<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator taryf energii - rzeczywiste ceny ENTSO-E</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Light theme colors */
            --bg-gradient-1: #667eea;
            --bg-gradient-2: #764ba2;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e8f4f8;
            --text-primary: #2c3e50;
            --text-secondary: #666;
            --text-inverse: #ffffff;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --chart-bg: rgba(255, 255, 255, 0.95);
        }
        
        [data-theme="dark"] {
            /* Dark theme colors */
            --bg-gradient-1: #1a1a2e;
            --bg-gradient-2: #16213e;
            --bg-primary: #1e1e2e;
            --bg-secondary: #2a2a3e;
            --bg-tertiary: #35354a;
            --text-primary: #f0f0f0;
            --text-secondary: #b0b0b0;
            --text-inverse: #1e1e2e;
            --border-color: #444466;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --glass-bg: rgba(30, 30, 46, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #5dade2;
            --chart-bg: rgba(30, 30, 46, 0.95);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        /* Theme toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px var(--shadow-color);
        }
        
        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px var(--shadow-color);
        }
        
        .theme-toggle-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
        }
        
        .theme-toggle:hover .theme-toggle-icon {
            transform: rotate(180deg);
        }
        
        /* Glassmorphism container */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 8px 32px var(--shadow-color);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px var(--shadow-color);
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }
        
        h1 {
            text-align: center;
            color: var(--text-inverse);
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: fadeInDown 0.8s ease;
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-inverse);
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.9;
            animation: fadeInUp 0.8s ease 0.2s backwards;
        }
        
        /* Season toggle */
        .season-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease 0.4s backwards;
        }
        
        .season-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 25px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        .season-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow-color);
        }
        
        .season-btn.active {
            background: var(--info);
            color: white;
        }
        
        /* API Status */
        .api-status {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-primary);
            animation: slideIn 0.6s ease 0.6s backwards;
            transition: all 0.3s ease;
        }
        
        .api-status.loading {
            background: rgba(255, 243, 205, 0.8);
            border-color: rgba(255, 234, 167, 0.5);
            color: #856404;
        }
        
        .api-status.error {
            background: rgba(248, 215, 218, 0.8);
            border-color: rgba(245, 198, 203, 0.5);
            color: #721c24;
        }
        
        /* Controls section */
        .controls-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: fadeIn 0.8s ease 0.8s backwards;
            transition: all 0.3s ease;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            animation: fadeInUp 0.6s ease;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        input, select, textarea {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--info);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }
        
        /* Date range controls visibility fix */
        #date-range-group,
        #date-range-group-to {
            transition: all 0.3s ease;
        }
        
        /* Profile section */
        .profile-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            animation: fadeIn 0.6s ease;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .profile-btn {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }
        
        .profile-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--info);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }
        
        .profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .profile-btn.active {
            background: var(--info);
            color: white;
            border-color: var(--info);
        }
        
        /* Buttons */
        .fetch-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .fetch-btn:hover:not(:disabled) {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .fetch-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Charts section */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            background: var(--chart-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: scaleIn 0.8s ease;
            transition: all 0.3s ease;
        }
        
        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px var(--shadow-color);
        }
        
        .chart-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        .chart-wrapper {
            position: relative;
            height: 350px;
        }
        
        /* Summary section */
        .summary-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: fadeInUp 0.8s ease;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .summary-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .summary-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s ease;
        }
        
        .summary-card:hover::before {
            animation: shimmer 0.5s ease;
        }
        
        .summary-card.best {
            background: linear-gradient(135deg, var(--success), #27ae60);
            color: white;
            box-shadow: 0 5px 20px rgba(39, 174, 96, 0.3);
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            animation: countUp 1s ease;
        }
        
        .summary-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Price preview */
        .price-preview {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            animation: fadeIn 0.6s ease;
        }
        
        .prices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }
        
        .price-cell {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .price-cell:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .price-hour {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .price-value {
            font-weight: 600;
        }
        
        /* Hourly analysis */
        .hourly-analysis {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px var(--shadow-color);
            grid-column: 1 / -1;
            animation: fadeInUp 0.8s ease;
        }
        
        .hour-grid {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin-top: 15px;
        }
        
        .hour-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .hour-cell:hover {
            transform: scale(1.2);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }
        
        @keyframes countUp {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .hour-grid {
                grid-template-columns: repeat(12, 1fr);
            }
            
            .theme-toggle {
                top: 10px;
                right: 10px;
            }
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0,0,0,0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Seasonal profiles */
        .seasonal-info {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85rem;
            text-align: center;
            color: var(--text-secondary);
        }
        
        /* Advanced section improvements */
        #advanced-section {
            margin-top: 20px;
            animation: fadeIn 0.6s ease;
        }
        
        .profile-editor {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
        }
        
        .day-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .day-tab {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .day-tab:hover {
            border-color: var(--info);
            transform: translateY(-2px);
            box-shadow: 0 3px 10px var(--shadow-color);
        }
        
        .day-tab.active {
            background: var(--info);
            color: white;
            border-color: var(--info);
        }
        
        /* Legend improvements */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            background: var(--bg-secondary);
            padding: 5px 15px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .legend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px var(--shadow-color);
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <span class="theme-toggle-icon">üåô</span>
        <span class="theme-text">Tryb ciemny</span>
    </button>
    
    <div class="container">
        <h1>‚ö° Kalkulator Taryf z ENTSO-E</h1>
        <div class="subtitle">Rzeczywiste ceny spot dla Polski + por√≥wnanie wszystkich taryf</div>
        
        <!-- Season Toggle -->
        <div class="season-toggle">
            <button class="season-btn active" onclick="setSeason('all', this)">üìÖ Ca≈Çy rok</button>
            <button class="season-btn" onclick="setSeason('summer', this)">‚òÄÔ∏è Lato</button>
            <button class="season-btn" onclick="setSeason('winter', this)">‚ùÑÔ∏è Zima</button>
        </div>
        
        <div class="api-status glass-card" id="api-status">
            <strong>üîå API ENTSO-E:</strong> Kliknij "Pobierz ceny spot" aby pobraƒá rzeczywiste ceny energii z ENTSO-E Transparency Platform<br>
            <small>üí° <strong>Wa≈ºne:</strong> ENTSO-E ma dane tylko z przesz≈Ço≈õci (maksymalnie do wczoraj)</small>
        </div>
        
        <!-- Sekcja ENTSO-E API -->
        <div class="controls-section glass-card">
            <h3>üåç Rzeczywiste ceny energii (ENTSO-E Transparency Platform)</h3>
            <div class="controls-grid">
                <div class="input-group">
                    <label for="analysis-type">
                        Typ analizy:
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">Wybierz spos√≥b analizy cen energii</span>
                        </span>
                    </label>
                    <select id="analysis-type">
                        <option value="single-day">Pojedynczy dzie≈Ñ</option>
                        <option value="date-range">Zakres dat</option>
                        <option value="week-analysis">Analiza tygodniowa</option>
                        <option value="month-analysis">Analiza miesiƒôczna</option>
                    </select>
                </div>
                <div class="input-group" id="single-date-group">
                    <label for="date-select">Data analizy:</label>
                    <input type="date" id="date-select" value="">
                </div>
                <div class="input-group" id="date-range-group" style="display: none;">
                    <label for="date-from">Od:</label>
                    <input type="date" id="date-from" value="">
                </div>
                <div class="input-group" id="date-range-group-to" style="display: none;">
                    <label for="date-to">Do:</label>
                    <input type="date" id="date-to" value="">
                </div>
                <div class="input-group">
                    <label for="eur-pln-rate">
                        Kurs EUR/PLN:
                        <span class="tooltip">‚úèÔ∏è
                            <span class="tooltiptext">Mo≈ºesz edytowaƒá rƒôcznie</span>
                        </span>
                    </label>
                    <input type="number" id="eur-pln-rate" value="4.30" step="0.01" min="3" max="6">
                    <button class="fetch-btn" onclick="updateExchangeRate()" style="margin-top: 5px; padding: 6px 12px; font-size: 0.8rem;">
                        üí± Zaktualizuj kurs EUR/PLN
                    </button>
                </div>
                <div class="input-group">
                    <label for="g11f-margin">
                        Dodatkowa mar≈ºa G11f (z≈Ç/kWh):
                        <span class="tooltip">‚ÑπÔ∏è
                            <span class="tooltiptext">Mar≈ºa dodawana do ceny spot przez sprzedawcƒô</span>
                        </span>
                    </label>
                    <input type="number" id="g11f-margin" value="0.05" step="0.001" min="0" max="0.2">
                </div>
                <div class="input-group">
                    <label>&nbsp;</label>
                    <button class="fetch-btn" onclick="fetchSpotPrices()">
                        üìä Pobierz ceny spot
                    </button>
                    <label class="auto-fetch" style="margin-top: 10px;">
                        <input type="checkbox" id="auto-fetch" checked> Auto-od≈õwie≈ºanie
                    </label>
                </div>
            </div>
            <div class="price-preview" id="price-preview" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>üìä Ceny spot dla Polski:</strong>
                    <div id="price-stats" style="font-size: 0.9rem;"></div>
                </div>
                <div class="prices-grid" id="spot-prices-grid"></div>
                <div class="currency-info" id="currency-info" style="margin-top: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 10px;"></div>
            </div>
        </div>
        
        <!-- Kontrolki podstawowe -->
        <div class="controls-section glass-card">
            <h3>‚öôÔ∏è Parametry gospodarstwa</h3>
            <div class="controls-grid">
                <div class="input-group">
                    <label for="monthly-usage">Miesiƒôczne zu≈ºycie (kWh):</label>
                    <input type="number" id="monthly-usage" value="300" min="0" step="10">
                </div>
                <div class="input-group">
                    <label for="annual-usage">Roczne zu≈ºycie (kWh):</label>
                    <input type="number" id="annual-usage" value="3600" min="0" step="100">
                </div>
                <div class="input-group">
                    <label for="installation-type">Typ instalacji:</label>
                    <select id="installation-type">
                        <option value="1-phase">1-fazowa</option>
                        <option value="3-phase" selected>3-fazowa</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>&nbsp;</label>
                    <button class="fetch-btn" onclick="toggleAdvanced()" style="background: var(--text-primary);">
                        ‚öôÔ∏è Zaawansowane profile
                    </button>
                </div>
            </div>
            
            <div class="profile-section">
                <h4>üìà Profile zu≈ºycia energii</h4>
                <div class="seasonal-info" id="seasonal-info" style="display: none;">
                    Profil dostosowany do sezonu: <strong id="current-season">Ca≈Çy rok</strong>
                </div>
                <div class="profile-grid">
                    <div class="profile-btn active" onclick="setUsageProfile('standard', this)">
                        üè† Standard<br><small>R√≥wnomierne zu≈ºycie</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('morning', this)">
                        üåÖ Poranny<br><small>Pik 6-9, 17-21</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('evening', this)">
                        üåÜ Wieczorny<br><small>Pik 18-23</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('night', this)">
                        üåô Nocny<br><small>Pik 22-6</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('flexible', this)">
                        üîÑ Elastyczny<br><small>Dostosowany do G12</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('homeoffice', this)">
                        üíª Home Office<br><small>R√≥wnomierne 8-18</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Podsumowanie koszt√≥w -->
        <div class="summary-section glass-card">
            <h3>üí∞ Por√≥wnanie miesiƒôcznych koszt√≥w</h3>
            <div class="summary-grid" id="cost-summary">
                <!-- Wype≈Çniane dynamicznie -->
            </div>
        </div>
        
        <!-- Wykresy -->
        <div class="charts-section">
            <div class="chart-container glass-card">
                <div class="chart-title">Stawki w ciƒÖgu doby</div>
                <div class="chart-wrapper">
                    <canvas id="hourlyRatesChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container glass-card">
                <div class="chart-title">Profil zu≈ºycia vs ceny</div>
                <div class="chart-wrapper">
                    <canvas id="costProfileChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Analiza godzinowa -->
        <div class="hourly-analysis glass-card">
            <div class="chart-title">üïê Analiza godzinowa taryf</div>
            
            <h4>G11f - Dynamiczna (ceny spot + sta≈Çy sk≈Çadnik 0,0516 z≈Ç/kWh + mar≈ºa)</h4>
            <div class="hour-label" style="text-align: center; color: var(--text-secondary); margin-bottom: 5px;">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g11f-hours"></div>
            
            <h4 style="margin-top: 20px;">G12 - Dzie≈Ñ/Noc</h4>
            <div class="hour-label" style="text-align: center; color: var(--text-secondary); margin-bottom: 5px;">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g12-hours"></div>
            
            <h4 style="margin-top: 20px;">G12w - Weekendowa (+ ca≈Çe weekendy w taryfie nocnej)</h4>
            <div class="hour-label" style="text-align: center; color: var(--text-secondary); margin-bottom: 5px;">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g12w-hours"></div>
            
            <h4 style="margin-top: 20px;">G12r - Szczyt/Pozaszczyt</h4>
            <div class="hour-label" style="text-align: center; color: var(--text-secondary); margin-bottom: 5px;">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g12r-hours"></div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--danger);"></div>
                    <span>Dro≈ºej (dzie≈Ñ/szczyt)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--success);"></div>
                    <span>Taniej (noc/pozaszczyt)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, var(--success), var(--warning), var(--danger));"></div>
                    <span>Dynamiczna (zielony=tanie, czerwony=drogie)</span>
                </div>
            </div>
        </div>
        
        <!-- Sekcja zaawansowana -->
        <div class="controls-section glass-card" id="advanced-section" style="display: none;">
            <h3>üîß Zaawansowane profile zu≈ºycia</h3>
            <p style="margin-bottom: 20px; color: var(--text-secondary);">
                Ustaw r√≥≈ºne profile zu≈ºycia dla poszczeg√≥lnych dni tygodnia. 
                Przydatne np. dla ≈Çadowania auta elektrycznego tylko w okre≈õlone dni.
            </p>
            
            <div class="profile-editor">
                <div class="day-tabs">
                    <button class="day-tab active" onclick="selectDay('all')" data-day="all">Wszystkie dni</button>
                    <button class="day-tab" onclick="selectDay('monday')" data-day="monday">Poniedzia≈Çek</button>
                    <button class="day-tab" onclick="selectDay('tuesday')" data-day="tuesday">Wtorek</button>
                    <button class="day-tab" onclick="selectDay('wednesday')" data-day="wednesday">≈öroda</button>
                    <button class="day-tab" onclick="selectDay('thursday')" data-day="thursday">Czwartek</button>
                    <button class="day-tab" onclick="selectDay('friday')" data-day="friday">PiƒÖtek</button>
                    <button class="day-tab" onclick="selectDay('saturday')" data-day="saturday">Sobota</button>
                    <button class="day-tab" onclick="selectDay('sunday')" data-day="sunday">Niedziela</button>
                </div>
                
                <div class="profile-controls" style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                    <div class="profile-presets">
                        <h4 style="margin-bottom: 10px;">Gotowe wzorce:</h4>
                        <div class="preset-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('standard')">üè† Standard</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('morning')">üåÖ Poranny</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('evening')">üåÜ Wieczorny</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('night')">üåô Nocny</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('ev_charging')">‚ö° ≈Åadowanie EV</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('heat_pump')">üî• Pompa ciep≈Ça</button>
                        </div>
                    </div>
                    
                    <div class="hourly-editor">
                        <h4 id="editor-title">Edycja profilu: Wszystkie dni</h4>
                        <div class="hour-sliders" id="hour-sliders" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 10px; margin: 20px 0;">
                            <!-- Wype≈Çniane dynamicznie -->
                        </div>
                        <div class="editor-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="fetch-btn" style="background: var(--warning);" onclick="resetCurrentDay()">üîÑ Reset dnia</button>
                            <button class="fetch-btn" style="background: #9b59b6;" onclick="copyToAllDays()">üìã Kopiuj na wszystkie dni</button>
                            <button class="fetch-btn" onclick="saveCustomProfile()">üíæ Zapisz profil</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Tw√≥j token ENTSO-E (bƒôdzie u≈ºywany automatycznie)
        const ENTSO_API_TOKEN = '74e2281c-6281-46b5-8805-7d5b3dc7389b';
        const POLAND_DOMAIN = '10YPL-AREA-----S';
        
        // Theme management
        let currentTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        updateThemeToggle();
        
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeToggle();
            
            // Update charts if they exist
            if (hourlyChart) {
                updateChartTheme(hourlyChart);
            }
            if (costChart) {
                updateChartTheme(costChart);
            }
        }
        
        function updateThemeToggle() {
            const toggle = document.querySelector('.theme-toggle');
            const icon = toggle.querySelector('.theme-toggle-icon');
            const text = toggle.querySelector('.theme-text');
            
            if (currentTheme === 'dark') {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Tryb jasny';
            } else {
                icon.textContent = 'üåô';
                text.textContent = 'Tryb ciemny';
            }
        }
        
        function updateChartTheme(chart) {
            if (!chart || !chart.options || !chart.options.scales) return;
            
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary');
            const gridColor = getComputedStyle(document.body).getPropertyValue('--border-color');
            
            if (chart.options.scales.x) {
                if (chart.options.scales.x.ticks) chart.options.scales.x.ticks.color = textColor;
                if (chart.options.scales.x.grid) chart.options.scales.x.grid.color = gridColor;
            }
            if (chart.options.scales.y) {
                if (chart.options.scales.y.ticks) chart.options.scales.y.ticks.color = textColor;
                if (chart.options.scales.y.grid) chart.options.scales.y.grid.color = gridColor;
            }
            if (chart.options.plugins && chart.options.plugins.legend && chart.options.plugins.legend.labels) {
                chart.options.plugins.legend.labels.color = textColor;
            }
            
            chart.update();
        }
        
        // Season management
        let currentSeason = 'all';
        
        function setSeason(season, element) {
            currentSeason = season;
            
            // Update buttons
            document.querySelectorAll('.season-btn').forEach(btn => btn.classList.remove('active'));
            if (element) element.classList.add('active');
            
            // Update seasonal info
            const seasonalInfo = document.getElementById('seasonal-info');
            const currentSeasonText = document.getElementById('current-season');
            
            if (seasonalInfo && currentSeasonText) {
                if (season !== 'all') {
                    seasonalInfo.style.display = 'block';
                    currentSeasonText.textContent = season === 'summer' ? 'Lato' : 'Zima';
                } else {
                    seasonalInfo.style.display = 'none';
                }
            }
            
            // Apply seasonal adjustments to profiles
            applySeasonalAdjustments();
            calculateCostsAndUpdate();
        }
        
        function applySeasonalAdjustments() {
            try {
                if (!currentProfile || currentProfile.length === 0) {
                    currentProfile = [...usageProfiles.standard];
                }
                
                // Stw√≥rz kopiƒô profilu do modyfikacji
                let adjustedProfile = [...currentProfile];
                
                // Adjust profiles based on season
                if (currentSeason === 'summer') {
                    // Summer adjustments - less heating, more cooling
                    adjustedProfile = adjustedProfile.map((value, hour) => {
                        if (hour >= 12 && hour <= 16) {
                            return value * 1.2; // More AC usage during hot hours
                        } else if (hour >= 22 || hour <= 5) {
                            return value * 0.8; // Less night usage (no heating)
                        }
                        return value;
                    });
                } else if (currentSeason === 'winter') {
                    // Winter adjustments - more heating, longer lighting
                    adjustedProfile = adjustedProfile.map((value, hour) => {
                        if ((hour >= 6 && hour <= 8) || (hour >= 17 && hour <= 22)) {
                            return value * 1.3; // More heating and lighting
                        } else if (hour >= 10 && hour <= 15) {
                            return value * 0.9; // Less usage during warmer day hours
                        }
                        return value;
                    });
                }
                
                // Normalize to 100%
                const sum = adjustedProfile.reduce((a, b) => a + b, 0);
                if (sum > 0) {
                    currentProfile = adjustedProfile.map(v => (v / sum) * 100);
                }
            } catch (error) {
                console.error('B≈ÇƒÖd podczas dostosowywania profilu sezonowego:', error);
            }
        }
        
        // Definicje taryf z Energa Operator
        const tariffs = {
            G11: {
                name: "G11 - Jednostrefowa",
                rate: 0.3437,
                fixedMonthly: { "1-phase": 7.68, "3-phase": 11.54 },
                type: "flat"
            },
            G11f: {
                name: "G11f - Dynamiczna", 
                baseRate: 0.0516, // Sta≈Çy sk≈Çadnik zmienny stawki sieciowej
                fixedMonthly: { "1-phase": 38.69, "3-phase": 54.37 }, // Sta≈Çy sk≈Çadnik stawki sieciowej
                type: "dynamic"
            },
            G12: {
                name: "G12 - Dzie≈Ñ/Noc",
                rates: { day: 0.3791, night: 0.0816 },
                zones: [
                    // dzie≈Ñ: 6-13, 15-22; noc: 13-15, 22-6
                    'night','night','night','night','night','night', // 0-5
                    'day','day','day','day','day','day','day', // 6-12
                    'night','night', // 13-14
                    'day','day','day','day','day','day','day', // 15-21
                    'night','night' // 22-23
                ],
                fixedMonthly: { "1-phase": 14.07, "3-phase": 19.77 }
            },
            G12w: {
                name: "G12w - Weekendowa",
                rates: { day: 0.3960, night: 0.0838 },
                zones: [
                    'night','night','night','night','night','night',
                    'day','day','day','day','day','day','day',
                    'night','night',
                    'day','day','day','day','day','day','day',
                    'night','night'
                ],
                weekendAllNight: true,
                fixedMonthly: { "1-phase": 14.07, "3-phase": 19.77 }
            },
            G12r: {
                name: "G12r - Szczyt/Pozaszczyt", 
                rates: { peak: 0.3590, offpeak: 0.0870 },
                zones: [
                    // szczyt: 7-13, 16-22; pozaszczyt: 13-16, 22-7
                    'offpeak','offpeak','offpeak','offpeak','offpeak','offpeak','offpeak', // 0-6
                    'peak','peak','peak','peak','peak','peak', // 7-12
                    'offpeak','offpeak','offpeak', // 13-15
                    'peak','peak','peak','peak','peak','peak', // 16-21
                    'offpeak','offpeak' // 22-23
                ],
                fixedMonthly: { "1-phase": 14.07, "3-phase": 19.77 }
            }
        };
        
        // Systemowe op≈Çaty
        const systemCharges = {
            subscription: 4.56,
            quality: 0.0321,
            oze: 0.0035,
            cogeneration: 0.003,
        };
        
        function getTransitionFee(annualUsage) {
            if (annualUsage < 500) return 0.02;
            if (annualUsage <= 1200) return 0.10;
            return 0.33;
        }
        
        function getPowerFee(annualUsage) {
            if (annualUsage < 500) return 2.86;
            if (annualUsage <= 1200) return 6.86;
            if (annualUsage <= 2800) return 11.44;
            return 16.01;
        }
        
        // Profile zu≈ºycia (% dla ka≈ºdej godziny doby)
        const usageProfiles = {
            standard: new Array(24).fill(100/24), // r√≥wnomierne
            morning: [2,2,2,2,2,8,12,12,8,4,4,4,4,4,4,4,8,12,12,8,6,4,3,2], // poranki + wieczory
            evening: [2,2,2,2,2,3,6,8,4,3,3,3,3,3,3,3,4,6,12,15,15,8,4,2], // wieczorny pik
            night: [8,8,8,6,4,2,2,2,2,2,2,2,2,2,2,2,2,3,4,6,8,12,15,15], // nocny
            flexible: [8,8,8,8,6,4,2,2,2,2,2,2,8,8,4,2,2,2,2,2,4,6,8,8], // dostosowany do G12
            homeoffice: [3,2,2,2,2,4,6,8,10,8,6,6,6,8,8,6,6,4,3,2,2,2,2,2], // home office
            ev_charging: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,50,50,0], // ≈Çadowanie EV 21-23h
            heat_pump: [6,6,6,6,6,8,4,2,2,2,2,2,2,2,2,2,2,4,6,8,8,8,8,6] // pompa ciep≈Ça
        };
        
        let currentProfile = [...usageProfiles.standard];
        let weeklyProfiles = {
            monday: [...usageProfiles.standard],
            tuesday: [...usageProfiles.standard],
            wednesday: [...usageProfiles.standard],
            thursday: [...usageProfiles.standard],
            friday: [...usageProfiles.standard],
            saturday: [...usageProfiles.standard],
            sunday: [...usageProfiles.standard]
        };
        let selectedDay = 'all';
        let useWeeklyProfiles = false;
        let spotPrices = null;
        let spotPricesRange = []; // Dla zakres√≥w dat
        let hourlyChart = null;
        let costChart = null;
        let currentExchangeRate = 4.30;
        
        // Inicjalizuj currentProfile je≈õli jest pusty
        if (!currentProfile || currentProfile.length === 0) {
            currentProfile = new Array(24).fill(100/24);
        }
        
        // Zabezpieczenie przed b≈Çƒôdami
        window.addEventListener('error', function(e) {
            console.error('B≈ÇƒÖd aplikacji:', e.message, e.filename, e.lineno, e.colno);
            return true;
        });
        
        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Aplikacja startuje...');
            
            try {
                // Ustaw wczorajszƒÖ datƒô (ENTSO-E ma op√≥≈∫nienie ~1 dzie≈Ñ)
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                const weekAgo = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
                
                // Ustaw maksymalnƒÖ datƒô na wczoraj dla wszystkich p√≥l dat
                const dateSelect = document.getElementById('date-select');
                if (dateSelect) {
                    dateSelect.value = yesterday;
                    dateSelect.max = yesterday;
                }
                
                const dateFrom = document.getElementById('date-from');
                if (dateFrom) {
                    dateFrom.value = weekAgo;
                    dateFrom.max = yesterday;
                }
                
                const dateTo = document.getElementById('date-to');
                if (dateTo) {
                    dateTo.value = yesterday;
                    dateTo.max = yesterday;
                }
                
                // Ustaw domy≈õlny kurs
                currentExchangeRate = 4.30;
                const eurInput = document.getElementById('eur-pln-rate');
                if (eurInput) {
                    eurInput.value = currentExchangeRate.toFixed(4);
                }
                
                // Event listenery
                setupEventListeners();
                
                // Wstƒôpne obliczenia bez cen spot (u≈ºywa standardowych taryf)
                setTimeout(() => {
                    calculateCostsAndUpdate();
                    console.log('‚úÖ Aplikacja uruchomiona pomy≈õlnie');
                }, 100);
                
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd podczas inicjalizacji:', error);
            }
        });
        
        function fetchExchangeRate() {
            const eurInput = document.getElementById('eur-pln-rate');
            if (eurInput) {
                const newRate = parseFloat(eurInput.value);
                if (!isNaN(newRate) && newRate > 0) {
                    currentExchangeRate = newRate;
                    console.log(`üìä Zaktualizowano kurs EUR/PLN: ${currentExchangeRate.toFixed(4)}`);
                    
                    // Aktualizuj wy≈õwietlanie je≈õli sƒÖ ju≈º ceny
                    if (spotPrices && spotPrices.length > 0) {
                        updateSpotPricesDisplay();
                        calculateCostsAndUpdate();
                    }
                    
                    // Wy≈õwietl info o kursie
                    const currencyInfo = document.getElementById('currency-info');
                    if (currencyInfo) {
                        currencyInfo.innerHTML = `
                            üí± <span style="font-weight: bold;">Kurs EUR/PLN: ${currentExchangeRate.toFixed(4)}</span>
                            <span style="margin-left: 20px;">üì° ≈πr√≥d≈Ço: Wprowadzono rƒôcznie</span>
                            <span style="margin-left: 20px;">‚úÖ Zaktualizowano</span>
                        `;
                    }
                } else {
                    alert('Wprowad≈∫ poprawnƒÖ warto≈õƒá kursu EUR/PLN');
                }
            }
        }
        
        async function updateExchangeRate() {
            try {
                // Spr√≥buj kilka ≈∫r√≥de≈Ç kursu EUR/PLN
                let rate = null;
                let source = '';
                
                console.log('üîÑ Pobieranie kursu EUR/PLN...');
                
                // 1. Spr√≥buj NBP API przez CORS proxy
                try {
                    const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://api.nbp.pl/api/exchangerates/rates/a/eur/?format=json'));
                    if (response.ok) {
                        const data = await response.json();
                        if (data.contents) {
                            const nbpData = JSON.parse(data.contents);
                            if (nbpData && nbpData.rates && nbpData.rates.length > 0) {
                                rate = nbpData.rates[0].mid;
                                source = `NBP (${nbpData.rates[0].effectiveDate})`;
                                console.log('‚úÖ NBP API dzia≈Ça:', rate);
                            }
                        }
                    }
                } catch (e) {
                    console.log('‚ùå NBP API niedostƒôpne:', e.message);
                }
                
                // 2. Fallback - Frankfurter API (darmowe, bez limitu, CORS-friendly)
                if (!rate) {
                    try {
                        const response = await fetch('https://api.frankfurter.app/latest?from=EUR&to=PLN');
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.rates && data.rates.PLN) {
                                rate = data.rates.PLN;
                                source = `Frankfurter (${data.date})`;
                                console.log('‚úÖ Frankfurter API dzia≈Ça:', rate);
                            }
                        }
                    } catch (e) {
                        console.log('‚ùå Frankfurter API niedostƒôpne:', e.message);
                    }
                }
                
                // 3. Fallback - ExchangeRate-API
                if (!rate) {
                    try {
                        const response = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.rates && data.rates.PLN) {
                                rate = data.rates.PLN;
                                source = 'ExchangeRate-API';
                                console.log('‚úÖ ExchangeRate-API dzia≈Ça:', rate);
                            }
                        }
                    } catch (e) {
                        console.log('‚ùå ExchangeRate-API niedostƒôpne:', e.message);
                    }
                }
                
                // 4. Dodatkowy fallback - CoinGecko (simple price API)
                if (!rate) {
                    try {
                        const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=euro&vs_currencies=pln');
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.euro && data.euro.pln) {
                                rate = data.euro.pln;
                                source = 'CoinGecko';
                                console.log('‚úÖ CoinGecko API dzia≈Ça:', rate);
                            }
                        }
                    } catch (e) {
                        console.log('‚ùå CoinGecko API niedostƒôpne:', e.message);
                    }
                }
                
                // 5. Ostatni fallback - domy≈õlne warto≈õci
                if (!rate) {
                    rate = 4.30; // Konserwatywna warto≈õƒá
                    source = 'Warto≈õƒá domy≈õlna (API niedostƒôpne)';
                    console.log('‚ö†Ô∏è U≈ºywam domy≈õlnego kursu:', rate);
                }
                
                currentExchangeRate = parseFloat(rate) || 4.30;
                document.getElementById('eur-pln-rate').value = currentExchangeRate.toFixed(4);
                
                console.log(`üìä Kurs EUR/PLN: ${rate.toFixed(4)} (${source})`);
                
                // Aktualizuj wy≈õwietlanie je≈õli sƒÖ ju≈º ceny
                if (spotPrices) {
                    updateSpotPricesDisplay();
                }
                
                // Wy≈õwietl info o kursie
                const currencyInfo = document.getElementById('currency-info');
                if (currencyInfo && !currencyInfo.innerHTML.includes('Kurs EUR/PLN:')) {
                    currencyInfo.innerHTML = `
                        üí± <span style="font-weight: bold;">Kurs EUR/PLN: ${rate.toFixed(4)}</span>
                        <span style="margin-left: 20px;">üì° ≈πr√≥d≈Ço: ${source}</span>
                        <span style="margin-left: 20px;">‚úèÔ∏è Mo≈ºesz edytowaƒá rƒôcznie</span>
                    `;
                }
                
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd pobierania kursu:', error);
                
                // Fallback na domy≈õlny kurs
                const defaultRate = 4.30;
                currentExchangeRate = defaultRate;
                document.getElementById('eur-pln-rate').value = defaultRate.toFixed(4);
                
                const currencyInfo = document.getElementById('currency-info');
                if (currencyInfo) {
                    currencyInfo.innerHTML = `
                        ‚ö†Ô∏è <span style="color: var(--warning);">Kurs domy≈õlny: ${defaultRate.toFixed(4)} PLN/EUR</span>
                        <span style="margin-left: 20px;">‚úèÔ∏è Mo≈ºesz edytowaƒá rƒôcznie powy≈ºej</span>
                    `;
                }
            }
        }
        
        async function fetchSpotPrices() {
            const analysisType = document.getElementById('analysis-type').value;
            const statusDiv = document.getElementById('api-status');
            const btn = document.querySelector('.fetch-btn');
            
            let startDate, endDate;
            const today = new Date();
            const yesterday = new Date(Date.now() - 86400000);
            
            // Okre≈õl zakres dat na podstawie typu analizy
            switch (analysisType) {
                case 'single-day':
                    const singleDate = document.getElementById('date-select').value;
                    if (!singleDate) {
                        alert('Wybierz datƒô analizy');
                        return;
                    }
                    
                    // Sprawd≈∫ czy data nie jest z przysz≈Ço≈õci
                    const selectedDate = new Date(singleDate);
                    if (selectedDate >= today) {
                        alert('‚ùå ENTSO-E API ma dane tylko z przesz≈Ço≈õci!\n\nNajnowsze dostƒôpne dane to z wczoraj. Wybierz wcze≈õniejszƒÖ datƒô.');
                        return;
                    }
                    
                    startDate = endDate = singleDate;
                    break;
                    
                case 'date-range':
                    startDate = document.getElementById('date-from').value;
                    endDate = document.getElementById('date-to').value;
                    if (!startDate || !endDate) {
                        alert('Wybierz zakres dat');
                        return;
                    }
                    
                    // Sprawd≈∫ czy daty nie sƒÖ z przysz≈Ço≈õci
                    const startDateObj = new Date(startDate);
                    const endDateObj = new Date(endDate);
                    if (startDateObj >= today || endDateObj >= today) {
                        alert('‚ùå ENTSO-E API ma dane tylko z przesz≈Ço≈õci!\n\nNajnowsze dostƒôpne dane to z wczoraj. Wybierz wcze≈õniejsze daty.');
                        return;
                    }
                    
                    break;
                    
                case 'week-analysis':
                    const weekDate = document.getElementById('date-select').value;
                    if (!weekDate) {
                        alert('Wybierz datƒô dla analizy tygodniowej');
                        return;
                    }
                    
                    const weekDateObj = new Date(weekDate);
                    if (weekDateObj >= yesterday) {
                        alert('‚ùå ENTSO-E API ma dane tylko z przesz≈Ço≈õci!\n\nWybierz datƒô z wcze≈õniejszego tygodnia.');
                        return;
                    }
                    
                    const weekStart = new Date(weekDate);
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1); // Poniedzia≈Çek
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6); // Niedziela
                    
                    startDate = weekStart.toISOString().split('T')[0];
                    endDate = weekEnd.toISOString().split('T')[0];
                    break;
                    
                case 'month-analysis':
                    const monthDate = new Date(document.getElementById('date-select').value);
                    if (!monthDate.getTime()) {
                        alert('Wybierz datƒô dla analizy miesiƒôcznej');
                        return;
                    }
                    
                    if (monthDate >= yesterday) {
                        alert('‚ùå ENTSO-E API ma dane tylko z przesz≈Ço≈õci!\n\nWybierz datƒô z wcze≈õniejszego miesiƒÖca.');
                        return;
                    }
                    
                    startDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1).toISOString().split('T')[0];
                    endDate = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).toISOString().split('T')[0];
                    break;
            }
            
            // UI feedback
            statusDiv.className = 'api-status glass-card loading';
            statusDiv.innerHTML = `<strong>‚è≥ Pobieranie:</strong> Rzeczywiste dane z ENTSO-E API... <span class="spinner"></span>`;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Pobieranie... <span class="spinner"></span>';
            
            try {
                if (analysisType === 'single-day') {
                    // Pojedynczy dzie≈Ñ
                    await fetchSingleDayPrices(startDate);
                    statusDiv.className = 'api-status glass-card';
                    statusDiv.innerHTML = `<strong>‚úÖ Pobrano:</strong> Rzeczywiste ceny spot dla ${startDate} z ENTSO-E`;
                } else {
                    // Zakres dat
                    await fetchDateRangePrices(startDate, endDate);
                    statusDiv.className = 'api-status glass-card';
                    statusDiv.innerHTML = `<strong>‚úÖ Pobrano:</strong> Rzeczywiste ceny spot dla zakresu ${startDate} - ${endDate} z ENTSO-E`;
                }
                
                updateSpotPricesDisplay();
                calculateCostsAndUpdate();
                
            } catch (error) {
                console.error('‚ùå B≈ÇƒÖd pobierania danych ENTSO-E:', error);
                
                statusDiv.className = 'api-status glass-card error';
                statusDiv.innerHTML = `<strong>‚ùå B≈ÇƒÖd API ENTSO-E:</strong> ${error.message}<br>
                    <small>üí° <strong>Wskaz√≥wka:</strong> ENTSO-E ma dane tylko z przesz≈Ço≈õci (do wczoraj). 
                    Je≈õli wybra≈Çe≈õ datƒô z przysz≈Ço≈õci, wybierz wcze≈õniejszƒÖ datƒô.</small>`;
                
                // NIE MA FALLBACK - musi dzia≈Çaƒá prawdziwe API
                spotPrices = null;
            }
            
            // Reset UI
            btn.disabled = false;
            btn.innerHTML = 'üìä Pobierz ceny spot';
        }
        
        async function fetchSingleDayPrices(date) {
            // Format daty dla ENTSO-E API (YYYYMMDDHHMM)
            const targetDate = new Date(date);
            const nextDay = new Date(targetDate);
            nextDay.setDate(nextDay.getDate() + 1);
            
            const startDateTime = date.replace(/-/g, '') + '0000';
            const endDateTime = nextDay.toISOString().split('T')[0].replace(/-/g, '') + '0000';
            
            console.log(`Pobieranie danych ENTSO-E dla: ${date} (${startDateTime} - ${endDateTime})`);
            
            // Spr√≥buj r√≥≈ºne metody CORS
            const methods = [
                // Metoda 1: allorigins proxy
                async () => {
                    const apiUrl = `https://web-api.tp.entsoe.eu/api?` +
                        `securityToken=${ENTSO_API_TOKEN}&` +
                        `documentType=A44&` +
                        `in_Domain=${POLAND_DOMAIN}&` +
                        `out_Domain=${POLAND_DOMAIN}&` +
                        `periodStart=${startDateTime}&` +
                        `periodEnd=${endDateTime}`;
                    
                    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(apiUrl);
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) throw new Error(`AllOrigins proxy error: ${response.status}`);
                    
                    const data = await response.json();
                    if (!data.contents) throw new Error('Brak contents w odpowiedzi AllOrigins');
                    
                    return data.contents;
                },
                
                // Metoda 2: corsproxy.io
                async () => {
                    const apiUrl = `https://web-api.tp.entsoe.eu/api?` +
                        `securityToken=${ENTSO_API_TOKEN}&` +
                        `documentType=A44&` +
                        `in_Domain=${POLAND_DOMAIN}&` +
                        `out_Domain=${POLAND_DOMAIN}&` +
                        `periodStart=${startDateTime}&` +
                        `periodEnd=${endDateTime}`;
                    
                    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(apiUrl);
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) throw new Error(`CorsProxy error: ${response.status}`);
                    
                    return await response.text();
                },
                
                // Metoda 3: cors-anywhere
                async () => {
                    const apiUrl = `https://web-api.tp.entsoe.eu/api?` +
                        `securityToken=${ENTSO_API_TOKEN}&` +
                        `documentType=A44&` +
                        `in_Domain=${POLAND_DOMAIN}&` +
                        `out_Domain=${POLAND_DOMAIN}&` +
                        `periodStart=${startDateTime}&` +
                        `periodEnd=${endDateTime}`;
                    
                    const proxyUrl = 'https://cors-anywhere.herokuapp.com/' + apiUrl;
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) throw new Error(`CORS-Anywhere error: ${response.status}`);
                    
                    return await response.text();
                }
            ];
            
            let xmlText = null;
            let lastError = null;
            
            // Pr√≥buj ka≈ºdƒÖ metodƒô CORS
            for (let i = 0; i < methods.length; i++) {
                try {
                    console.log(`Pr√≥ba ${i + 1}: Pobieranie przez proxy...`);
                    xmlText = await methods[i]();
                    console.log(`‚úÖ Sukces przez proxy ${i + 1}`);
                    break;
                } catch (error) {
                    console.warn(`‚ùå Proxy ${i + 1} nie dzia≈Ça:`, error.message);
                    lastError = error;
                    continue;
                }
            }
            
            if (!xmlText) {
                throw new Error(`Wszystkie proxy CORS nie dzia≈ÇajƒÖ. Ostatni b≈ÇƒÖd: ${lastError?.message}`);
            }
            
            // Parsuj XML z ENTSO-E
            const prices = parseENTSOEXML(xmlText);
            
            if (prices.length === 0) {
                throw new Error('Brak danych cenowych w odpowiedzi ENTSO-E lub b≈ÇƒÖd parsowania XML');
            }
            
            // Sprawd≈∫ czy mamy 24 godziny
            if (prices.length !== 24) {
                console.warn(`Otrzymano ${prices.length} cen zamiast 24`);
                // Dope≈Çnij lub obetnij do 24 godzin
                while (prices.length < 24) {
                    prices.push(prices[prices.length - 1] || 50); // Domy≈õlna cena 50 ‚Ç¨/MWh
                }
                if (prices.length > 24) {
                    prices.splice(24);
                }
            }
            
            spotPrices = prices;
            console.log('‚úÖ Pobrano prawdziwe dane ENTSO-E:', {
                data: date,
                liczba_cen: prices.length,
                min: Math.min(...prices).toFixed(2) + ' ‚Ç¨/MWh',
                max: Math.max(...prices).toFixed(2) + ' ‚Ç¨/MWh',
                ≈õrednia: (prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(2) + ' ‚Ç¨/MWh',
                przyk≈Çad: prices.slice(0, 3).map(p => p.toFixed(2)).join(', ') + '...'
            });
        }
        
        async function fetchDateRangePrices(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            if (daysDiff > 31) {
                throw new Error('Maksymalny zakres to 31 dni');
            }
            
            spotPricesRange = [];
            const currentDate = new Date(start);
            
            for (let i = 0; i < daysDiff; i++) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                console.log(`Pobieranie danych dla dnia ${i + 1}/${daysDiff}: ${dateStr}`);
                
                try {
                    await fetchSingleDayPrices(dateStr);
                    spotPricesRange.push({
                        date: dateStr,
                        prices: [...spotPrices]
                    });
                } catch (error) {
                    console.error(`‚ùå B≈ÇƒÖd pobierania danych dla ${dateStr}:`, error.message);
                    throw new Error(`Nie uda≈Ço siƒô pobraƒá danych dla ${dateStr}: ${error.message}`);
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
                
                // Kr√≥tk–∞—è pauza miƒôdzy ≈ºƒÖdaniami aby nie przeciƒÖ≈ºyƒá API
                if (i < daysDiff - 1) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            // Ustaw ≈õrednie ceny dla analizy
            if (spotPricesRange.length > 0) {
                spotPrices = calculateAverageHourlyPrices(spotPricesRange);
                console.log(`‚úÖ Obliczono ≈õrednie ceny z ${spotPricesRange.length} dni`);
            } else {
                throw new Error('Nie uda≈Ço siƒô pobraƒá ≈ºadnych danych cenowych');
            }
        }
        
        function parseENTSOEXML(xmlText) {
            try {
                console.log('Parsowanie XML z ENTSO-E...');
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                // Sprawd≈∫ b≈Çƒôdy parsowania
                const parseError = xmlDoc.querySelector('parsererror');
                if (parseError) {
                    throw new Error(`B≈ÇƒÖd parsowania XML: ${parseError.textContent}`);
                }
                
                // Sprawd≈∫ b≈Çƒôdy ENTSO-E API
                const errorElement = xmlDoc.querySelector('Reason, text');
                if (errorElement && errorElement.textContent.includes('No matching data found')) {
                    throw new Error(`ENTSO-E API: ${errorElement.textContent}`);
                }
                
                // Znajd≈∫ dane cenowe - r√≥≈ºne mo≈ºliwe struktury XML
                const timeSeries = xmlDoc.querySelectorAll('TimeSeries');
                const prices = new Array(24).fill(null);
                
                console.log(`Znaleziono ${timeSeries.length} TimeSeries`);
                
                if (timeSeries.length === 0) {
                    // Spr√≥buj alternatywnej struktury
                    const periods = xmlDoc.querySelectorAll('Period');
                    console.log(`Znaleziono ${periods.length} Periods`);
                    
                    periods.forEach(period => {
                        const points = period.querySelectorAll('Point');
                        points.forEach(point => {
                            const positionEl = point.querySelector('position');
                            const priceEl = point.querySelector('price\\.amount, amount');
                            
                            if (positionEl && priceEl) {
                                const position = parseInt(positionEl.textContent) - 1; // ENTSO-E u≈ºywa 1-based indexing
                                const price = parseFloat(priceEl.textContent);
                                
                                if (position >= 0 && position < 24 && !isNaN(price)) {
                                    prices[position] = price;
                                }
                            }
                        });
                    });
                } else {
                    // Standardowa struktura TimeSeries
                    timeSeries.forEach(ts => {
                        const points = ts.querySelectorAll('Point');
                        points.forEach(point => {
                            const positionEl = point.querySelector('position');
                            const priceEl = point.querySelector('price\\.amount, amount');
                            
                            if (positionEl && priceEl) {
                                const position = parseInt(positionEl.textContent) - 1; // ENTSO-E u≈ºywa 1-based indexing
                                const price = parseFloat(priceEl.textContent);
                                
                                if (position >= 0 && position < 24 && !isNaN(price)) {
                                    prices[position] = price;
                                }
                            }
                        });
                    });
                }
                
                // Sprawd≈∫ czy uda≈Ço siƒô wyparsowaƒá jakiekolwiek ceny
                const validPrices = prices.filter(p => p !== null && !isNaN(p));
                console.log(`Wyparsowano ${validPrices.length} wa≈ºnych cen z 24`);
                
                if (validPrices.length === 0) {
                    console.error('XML content:', xmlText.substring(0, 1000) + '...');
                    throw new Error('Nie uda≈Ço siƒô wyparsowaƒá ≈ºadnych cen z XML');
                }
                
                // Wype≈Çnij brakujƒÖce ceny interpolacjƒÖ lub ≈õredniƒÖ
                const avgPrice = validPrices.reduce((a, b) => a + b, 0) / validPrices.length;
                
                for (let i = 0; i < 24; i++) {
                    if (prices[i] === null || isNaN(prices[i])) {
                        // Spr√≥buj interpolacji z sƒÖsiadami
                        let leftPrice = null, rightPrice = null;
                        
                        for (let j = i - 1; j >= 0; j--) {
                            if (prices[j] !== null && !isNaN(prices[j])) {
                                leftPrice = prices[j];
                                break;
                            }
                        }
                        
                        for (let j = i + 1; j < 24; j++) {
                            if (prices[j] !== null && !isNaN(prices[j])) {
                                rightPrice = prices[j];
                                break;
                            }
                        }
                        
                        if (leftPrice !== null && rightPrice !== null) {
                            prices[i] = (leftPrice + rightPrice) / 2;
                        } else if (leftPrice !== null) {
                            prices[i] = leftPrice;
                        } else if (rightPrice !== null) {
                            prices[i] = rightPrice;
                        } else {
                            prices[i] = avgPrice || 50; // Domy≈õlna cena je≈õli brak ≈õredniej
                        }
                    }
                }
                
                console.log('‚úÖ Parsowanie XML zako≈Ñczone pomy≈õlnie');
                return prices;
                
            } catch (error) {
                console.error('B≈ÇƒÖd parsowania XML:', error);
                throw error;
            }
        }
        
        function calculateAverageHourlyPrices(pricesRange) {
            const hourlyAverages = new Array(24).fill(0);
            const hourlyCounts = new Array(24).fill(0);
            
            pricesRange.forEach(dayData => {
                if (!dayData || !dayData.prices || !Array.isArray(dayData.prices)) return;
                
                dayData.prices.forEach((price, hour) => {
                    if (price && price > 0 && hour >= 0 && hour < 24) {
                        hourlyAverages[hour] += price;
                        hourlyCounts[hour]++;
                    }
                });
            });
            
            return hourlyAverages.map((sum, hour) => 
                hourlyCounts[hour] > 0 ? sum / hourlyCounts[hour] : 0
            );
        }
        
        function updateSpotPricesDisplay() {
            const eurPln = parseFloat(document.getElementById('eur-pln-rate').value) || currentExchangeRate || 4.30;
            const preview = document.getElementById('price-preview');
            const grid = document.getElementById('spot-prices-grid');
            const stats = document.getElementById('price-stats');
            const currencyInfo = document.getElementById('currency-info');
            
            if (!spotPrices || spotPrices.length === 0) {
                if (preview) preview.style.display = 'none';
                return;
            }
            
            // Przelicz ceny na z≈Ç/kWh
            const pricesInPLN = spotPrices.map(price => (price * eurPln / 1000));
            
            // Oblicz statystyki
            const validPrices = pricesInPLN.filter(p => !isNaN(p) && p !== null);
            if (validPrices.length === 0) {
                if (preview) preview.style.display = 'none';
                return;
            }
            
            const minPrice = Math.min(...validPrices);
            const maxPrice = Math.max(...validPrices);
            const avgPrice = validPrices.reduce((a, b) => a + b, 0) / validPrices.length;
            
            // Wy≈õwietl statystyki
            if (stats) {
                stats.innerHTML = `
                    <strong>üìä PRAWDZIWE DANE ENTSO-E:</strong> 
                    Min: ${minPrice.toFixed(4)} z≈Ç/kWh | 
                    ≈ör: ${avgPrice.toFixed(4)} z≈Ç/kWh | 
                    Max: ${maxPrice.toFixed(4)} z≈Ç/kWh
                `;
            }
            
            // Wyczy≈õƒá siatkƒô
            if (grid) {
                grid.innerHTML = '';
                
                // Wype≈Çnij siatkƒô cenami
                pricesInPLN.forEach((price, hour) => {
                    if (isNaN(price) || price === null) return;
                    
                    const cell = document.createElement('div');
                    cell.className = 'price-cell';
                    
                    // Kolor na podstawie ceny (zielony = tania, czerwony = droga)
                    const ratio = maxPrice > minPrice ? (price - minPrice) / (maxPrice - minPrice) : 0.5;
                    const hue = 120 - (ratio * 120); // 120 = zielony, 0 = czerwony
                    const saturation = 60 + (ratio * 20); // 60-80%
                    const lightness = 85 - (ratio * 25); // 85-60%
                    
                    cell.style.backgroundColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                    
                    // Kolor tekstu dla lepszej czytelno≈õci
                    cell.style.color = lightness < 70 ? 'white' : 'var(--text-primary)';
                    
                    cell.innerHTML = `
                        <div class="price-hour">${hour}h</div>
                        <div class="price-value">${price.toFixed(4)}</div>
                    `;
                    
                    cell.title = `${hour}:00 - ${price.toFixed(4)} z≈Ç/kWh (${(price * 1000 / eurPln).toFixed(2)} ‚Ç¨/MWh) - DANE ENTSO-E`;
                    
                    grid.appendChild(cell);
                });
            }
            
            if (preview) {
                preview.style.display = 'block';
            }
            
            // Aktualizuj wizualizacje
            renderHourlyTariffs();
        }
        
        function calculateCostsAndUpdate() {
            try {
                const monthlyUsage = parseFloat(document.getElementById('monthly-usage').value) || 300;
                const annualUsage = parseFloat(document.getElementById('annual-usage').value) || 3600;
                const installationType = document.getElementById('installation-type').value;
                
                const results = [];
                
                // Oblicz koszty dla ka≈ºdej taryfy
                Object.entries(tariffs).forEach(([id, tariff]) => {
                    try {
                        const cost = calculateTariffCost(id, monthlyUsage, annualUsage, installationType);
                        if (cost !== null) {
                            results.push({
                                id: id,
                                name: tariff.name,
                                totalCost: cost.total,
                                variableCost: cost.variable,
                                fixedCost: cost.fixed
                            });
                        }
                    } catch (error) {
                        console.error(`B≈ÇƒÖd obliczania kosztu dla taryfy ${id}:`, error);
                    }
                });
                
                // Sortuj po kosztach
                results.sort((a, b) => a.totalCost - b.totalCost);
                
                // Aktualizuj podsumowanie
                updateCostSummary(results);
                
                // Aktualizuj wykresy
                createCharts();
                
                // Renderuj taryfy godzinowe
                renderHourlyTariffs();
                
            } catch (error) {
                console.error('B≈ÇƒÖd podczas aktualizacji koszt√≥w:', error);
            }
        }
        
        function calculateTariffCost(tariffId, monthlyUsage, annualUsage, installationType) {
            try {
                const tariff = tariffs[tariffId];
                if (!tariff) return null;
                
                const installKey = installationType === "1-phase" ? "1-phase" : "3-phase";
                
                // Op≈Çaty sta≈Çe
                const fixedNetwork = tariff.fixedMonthly && tariff.fixedMonthly[installKey] ? tariff.fixedMonthly[installKey] : 0;
                const fixedSystem = systemCharges.subscription + getTransitionFee(annualUsage) + getPowerFee(annualUsage);
                const totalFixed = fixedNetwork + fixedSystem;
                
                // Op≈Çaty zmienne - u≈ºywaj profilu odpowiedniego dla kalkulacji
                let variableCost = 0;
                const profileToUse = useWeeklyProfiles ? getAverageWeeklyProfile() : currentProfile;
                
                // Zabezpieczenie przed brakiem profilu
                if (!profileToUse || profileToUse.length !== 24) {
                    console.error('B≈ÇƒÖd: Nieprawid≈Çowy profil zu≈ºycia');
                    return null;
                }
                
                if (tariff.type === "flat" && tariff.rate) {
                    // G11 - sta≈Ça stawka
                    variableCost = monthlyUsage * tariff.rate;
                } else if (tariff.type === "dynamic" && spotPrices) {
                    // G11f - dynamiczna na podstawie cen spot + sta≈Çy sk≈Çadnik zmienny
                    const eurPln = parseFloat(document.getElementById('eur-pln-rate').value) || 4.30;
                    const margin = parseFloat(document.getElementById('g11f-margin').value) || 0.05;
                    
                    let totalDynamicCost = 0;
                    for (let hour = 0; hour < 24; hour++) {
                        if (spotPrices[hour] === undefined || profileToUse[hour] === undefined) continue;
                        
                        // Sk≈Çadnik dynamiczny (spot) + sta≈Çy sk≈Çadnik zmienny + mar≈ºa
                        const spotPriceInPLN = spotPrices[hour] * eurPln / 1000; // Przelicz ‚Ç¨/MWh na z≈Ç/kWh
                        const totalHourlyRate = spotPriceInPLN + (tariff.baseRate || 0.0516) + margin;
                        const hourlyUsage = (monthlyUsage / 30) * (profileToUse[hour] / 100);
                        totalDynamicCost += hourlyUsage * totalHourlyRate;
                    }
                    variableCost = totalDynamicCost * 30; // Przelicz na miesiƒÖc
                } else if (tariff.zones && tariff.rates) {
                    // Taryfy strefowe (G12, G12w, G12r)
                    let dayUsage = 0;
                    let nightUsage = 0;
                    
                    for (let hour = 0; hour < 24; hour++) {
                        const zone = tariff.zones[hour];
                        if (!zone || profileToUse[hour] === undefined) continue;
                        
                        const hourlyUsage = (monthlyUsage / 30) * (profileToUse[hour] / 100);
                        
                        if (zone === 'day' || zone === 'peak') {
                            dayUsage += hourlyUsage;
                        } else if (zone === 'night' || zone === 'offpeak') {
                            nightUsage += hourlyUsage;
                        }
                    }
                    
                    dayUsage *= 30; // Przelicz na miesiƒÖc
                    nightUsage *= 30;
                    
                    const dayRate = tariff.rates.day !== undefined ? tariff.rates.day : 
                                   (tariff.rates.peak !== undefined ? tariff.rates.peak : 0);
                    const nightRate = tariff.rates.night !== undefined ? tariff.rates.night : 
                                     (tariff.rates.offpeak !== undefined ? tariff.rates.offpeak : 0);
                    
                    variableCost = (dayUsage * dayRate) + (nightUsage * nightRate);
                }
                
                // Op≈Çaty systemowe zmienne
                const systemVariable = monthlyUsage * (systemCharges.quality + systemCharges.oze + systemCharges.cogeneration);
                
                const totalVariable = variableCost + systemVariable;
                const totalCost = totalFixed + totalVariable;
                
                return {
                    total: totalCost,
                    fixed: totalFixed,
                    variable: totalVariable
                };
                
            } catch (error) {
                console.error(`B≈ÇƒÖd w calculateTariffCost dla ${tariffId}:`, error);
                return null;
            }
        }
        
        function updateCostSummary(results) {
            const container = document.getElementById('cost-summary');
            if (!container) return;
            
            container.innerHTML = '';
            
            results.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'summary-card' + (index === 0 ? ' best' : '');
                
                const difference = index === 0 ? 'NAJTA≈ÉSZA' : 
                    `+${(result.totalCost - results[0].totalCost).toFixed(2)} z≈Ç`;
                const differenceClass = index === 0 ? 'savings' : 'loss';
                
                card.innerHTML = `
                    <div class="summary-value">${result.totalCost.toFixed(2)} z≈Ç</div>
                    <div class="summary-label">${result.id}</div>
                    <div class="summary-label">${result.name}</div>
                    <div class="${differenceClass}" style="margin-top: 5px; font-weight: bold; color: ${index === 0 ? 'white' : 'var(--danger)'};">${difference}</div>
                `;
                
                container.appendChild(card);
            });
        }
        
        function renderHourlyTariffs() {
            // Zabezpieczenie przed brakiem danych
            try {
                if (tariffs.G12 && tariffs.G12.zones && tariffs.G12.rates) {
                    renderTariffHours('g12-hours', tariffs.G12.zones, tariffs.G12.rates);
                }
                if (tariffs.G12w && tariffs.G12w.zones && tariffs.G12w.rates) {
                    renderTariffHours('g12w-hours', tariffs.G12w.zones, tariffs.G12w.rates);
                }
                if (tariffs.G12r && tariffs.G12r.zones && tariffs.G12r.rates) {
                    renderTariffHours('g12r-hours', tariffs.G12r.zones, tariffs.G12r.rates);
                }
                
                // G11f - dynamiczne ceny
                if (spotPrices && spotPrices.length > 0) {
                    const eurPln = parseFloat(document.getElementById('eur-pln-rate').value) || currentExchangeRate || 4.30;
                    const margin = parseFloat(document.getElementById('g11f-margin').value) || 0.05;
                    const baseRate = tariffs.G11f ? tariffs.G11f.baseRate : 0.0516; // Sta≈Çy sk≈Çadnik zmienny 0.0516 z≈Ç/kWh
                    
                    const dynamicPrices = spotPrices.map(price => {
                        if (price === null || price === undefined || isNaN(price)) return null;
                        const spotPriceInPLN = price * eurPln / 1000; // ‚Ç¨/MWh -> z≈Ç/kWh
                        return spotPriceInPLN + baseRate + margin; // spot + sta≈Çy sk≈Çadnik + mar≈ºa
                    }).filter(p => p !== null);
                    
                    if (dynamicPrices.length > 0) {
                        renderDynamicHours('g11f-hours', dynamicPrices);
                    }
                }
            } catch (error) {
                console.error('B≈ÇƒÖd podczas renderowania taryf godzinowych:', error);
            }
        }
        
        function renderTariffHours(containerId, zones, rates) {
            const container = document.getElementById(containerId);
            if (!container || !zones || !rates) return;
            
            container.innerHTML = '';
            
            zones.forEach((zone, hour) => {
                if (!zone || zone === undefined || zone === null) return;
                
                const cell = document.createElement('div');
                cell.className = 'hour-cell';
                cell.textContent = hour;
                
                let rate = null;
                // Sprawd≈∫ czy zone to string i czy rates ma odpowiedniƒÖ w≈Ça≈õciwo≈õƒá
                if (typeof zone === 'string' && rates.hasOwnProperty(zone)) {
                    rate = rates[zone];
                } else if (zone === 'day' && rates.day !== undefined) {
                    rate = rates.day;
                } else if (zone === 'night' && rates.night !== undefined) {
                    rate = rates.night;
                } else if (zone === 'peak' && rates.peak !== undefined) {
                    rate = rates.peak;
                } else if (zone === 'offpeak' && rates.offpeak !== undefined) {
                    rate = rates.offpeak;
                }
                
                if (rate === null || rate === undefined) return;
                
                const color = (zone === 'day' || zone === 'peak') ? 'var(--danger)' : 'var(--success)';
                cell.style.backgroundColor = color;
                cell.title = `${hour}:00 - ${zone} (${rate.toFixed(4)} z≈Ç/kWh)`;
                
                container.appendChild(cell);
            });
        }
        
        function renderDynamicHours(containerId, prices) {
            const container = document.getElementById(containerId);
            if (!container || !prices || prices.length === 0) return;
            
            container.innerHTML = '';
            
            const validPrices = prices.filter(p => p !== null && p !== undefined && !isNaN(p));
            if (validPrices.length === 0) return;
            
            const minPrice = Math.min(...validPrices);
            const maxPrice = Math.max(...validPrices);
            
            prices.forEach((price, hour) => {
                if (price === null || price === undefined || isNaN(price) || hour >= 24) return;
                
                const cell = document.createElement('div');
                cell.className = 'hour-cell';
                cell.textContent = hour;
                
                // Kolor na podstawie ceny (od zielonego przez ≈º√≥≈Çty do czerwonego)
                const ratio = maxPrice > minPrice ? (price - minPrice) / (maxPrice - minPrice) : 0.5;
                const hue = 120 - (ratio * 120); // 120 = zielony, 0 = czerwony
                cell.style.backgroundColor = `hsl(${hue}, 70%, 50%)`;
                cell.title = `${hour}:00 - ${price.toFixed(4)} z≈Ç/kWh (spot + sta≈Çy sk≈Çadnik + mar≈ºa)`;
                
                container.appendChild(cell);
            });
        }
        
        function createCharts() {
            try {
                const ctx1 = document.getElementById('hourlyRatesChart');
                const ctx2 = document.getElementById('costProfileChart');
                
                if (!ctx1 || !ctx2) {
                    console.error('Nie znaleziono element√≥w canvas dla wykres√≥w');
                    return;
                }
                
                // Niszczenie starych wykres√≥w
                if (hourlyChart) {
                    hourlyChart.destroy();
                    hourlyChart = null;
                }
                if (costChart) {
                    costChart.destroy();
                    costChart = null;
                }
                
                const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
                
                // Chart colors
                const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary');
                const gridColor = getComputedStyle(document.body).getPropertyValue('--border-color');
                
                // Wykres stawek godzinowych
                const datasets = [
                    {
                        label: 'G11 (sta≈Ça)',
                        data: new Array(24).fill(tariffs.G11 && tariffs.G11.rate ? tariffs.G11.rate : 0),
                        borderColor: '#3498db',
                        backgroundColor: '#3498db20',
                        borderWidth: 2
                    },
                    {
                        label: 'G12 (dzie≈Ñ/noc)',
                        data: tariffs.G12.zones ? tariffs.G12.zones.map(zone => {
                            if (!zone || !tariffs.G12.rates) return 0;
                            if (zone === 'day' && tariffs.G12.rates.day !== undefined) {
                                return tariffs.G12.rates.day;
                            } else if (zone === 'night' && tariffs.G12.rates.night !== undefined) {
                                return tariffs.G12.rates.night;
                            }
                            return 0;
                        }) : [],
                        borderColor: '#e74c3c',
                        backgroundColor: '#e74c3c20',
                        borderWidth: 2,
                        stepped: true
                    },
                    {
                        label: 'G12r (szczyt/pozaszczyt)',
                        data: tariffs.G12r.zones ? tariffs.G12r.zones.map(zone => {
                            if (!zone || !tariffs.G12r.rates) return 0;
                            if (zone === 'peak' && tariffs.G12r.rates.peak !== undefined) {
                                return tariffs.G12r.rates.peak;
                            } else if (zone === 'offpeak' && tariffs.G12r.rates.offpeak !== undefined) {
                                return tariffs.G12r.rates.offpeak;
                            }
                            return 0;
                        }) : [],
                        borderColor: '#f39c12',
                        backgroundColor: '#f39c1220',
                        borderWidth: 2,
                        stepped: true
                    }
                ];
                
                // Dodaj G11f je≈õli sƒÖ ceny spot
                if (spotPrices && spotPrices.length > 0) {
                    const eurPln = parseFloat(document.getElementById('eur-pln-rate').value) || currentExchangeRate || 4.30;
                    const margin = parseFloat(document.getElementById('g11f-margin').value) || 0.05;
                    const baseRate = tariffs.G11f ? tariffs.G11f.baseRate : 0.0516; // Sta≈Çy sk≈Çadnik zmienny
                    
                    const dynamicPrices = spotPrices.map(price => {
                        if (price === null || price === undefined || isNaN(price)) return 0;
                        const spotPriceInPLN = price * eurPln / 1000; // ‚Ç¨/MWh -> z≈Ç/kWh
                        return spotPriceInPLN + baseRate + margin; // spot + sta≈Çy sk≈Çadnik + mar≈ºa
                    });
                    
                    datasets.push({
                        label: 'G11f (dynamiczna)',
                        data: dynamicPrices,
                        borderColor: '#9b59b6',
                        backgroundColor: '#9b59b620',
                        borderWidth: 3
                    });
                }
                
                hourlyChart = new Chart(ctx1, {
                    type: 'line',
                    data: { labels: hours, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: textColor
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            y: {
                                beginAtZero: true,
                                title: { 
                                    display: true, 
                                    text: 'Stawka (z≈Ç/kWh)',
                                    color: textColor
                                },
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        }
                    }
                });
                
                // Wykres profilu vs koszt
                const profileToShow = useWeeklyProfiles ? getAverageWeeklyProfile() : currentProfile;
                
                costChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: hours,
                        datasets: [{
                            label: 'Profil zu≈ºycia (%)',
                            data: profileToShow || new Array(24).fill(100/24),
                            backgroundColor: 'rgba(39, 174, 96, 0.5)',
                            borderColor: '#27ae60',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: textColor
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            y: {
                                beginAtZero: true,
                                title: { 
                                    display: true, 
                                    text: 'Zu≈ºycie (% dobowego)',
                                    color: textColor
                                },
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('B≈ÇƒÖd podczas tworzenia wykres√≥w:', error);
            }
        }
        
        function setUsageProfile(profileName, element) {
            if (!usageProfiles[profileName]) {
                console.error('Nieznany profil:', profileName);
                return;
            }
            
            // Aktualizuj aktywny przycisk
            document.querySelectorAll('.profile-btn').forEach(btn => btn.classList.remove('active'));
            if (element) element.classList.add('active');
            
            // Ustaw profil
            currentProfile = [...usageProfiles[profileName]];
            
            // Apply seasonal adjustments
            applySeasonalAdjustments();
            
            // Przelicz i aktualizuj
            calculateCostsAndUpdate();
        }
        
        function setupEventListeners() {
            const monthlyUsage = document.getElementById('monthly-usage');
            if (monthlyUsage) {
                monthlyUsage.addEventListener('input', calculateCostsAndUpdate);
            }
            
            const annualUsage = document.getElementById('annual-usage');
            if (annualUsage) {
                annualUsage.addEventListener('input', calculateCostsAndUpdate);
            }
            
            const installationType = document.getElementById('installation-type');
            if (installationType) {
                installationType.addEventListener('change', calculateCostsAndUpdate);
            }
            
            const eurPlnRate = document.getElementById('eur-pln-rate');
            if (eurPlnRate) {
                eurPlnRate.addEventListener('input', () => {
                    updateSpotPricesDisplay();
                    calculateCostsAndUpdate();
                });
            }
            
            const g11fMargin = document.getElementById('g11f-margin');
            if (g11fMargin) {
                g11fMargin.addEventListener('input', () => {
                    renderHourlyTariffs();
                    calculateCostsAndUpdate();
                });
            }
            
            // Obs≈Çuga zmiany typu analizy
            const analysisType = document.getElementById('analysis-type');
            if (analysisType) {
                analysisType.addEventListener('change', function() {
                    const analysisTypeValue = this.value;
                    const singleDateGroup = document.getElementById('single-date-group');
                    const dateRangeGroup = document.getElementById('date-range-group');
                    const dateRangeGroupTo = document.getElementById('date-range-group-to');
                    
                    // Ukryj/poka≈º odpowiednie pola
                    if (analysisTypeValue === 'date-range') {
                        if (singleDateGroup) singleDateGroup.style.display = 'none';
                        if (dateRangeGroup) dateRangeGroup.style.display = 'flex';
                        if (dateRangeGroupTo) dateRangeGroupTo.style.display = 'flex';
                    } else {
                        if (singleDateGroup) singleDateGroup.style.display = 'flex';
                        if (dateRangeGroup) dateRangeGroup.style.display = 'none';
                        if (dateRangeGroupTo) dateRangeGroupTo.style.display = 'none';
                        
                        // Zaktualizuj etykietƒô dla r√≥≈ºnych typ√≥w analiz
                        const label = singleDateGroup ? singleDateGroup.querySelector('label') : null;
                        if (label) {
                            switch (analysisTypeValue) {
                                case 'week-analysis':
                                    label.textContent = 'Tydzie≈Ñ zawierajƒÖcy datƒô:';
                                    break;
                                case 'month-analysis':
                                    label.textContent = 'MiesiƒÖc zawierajƒÖcy datƒô:';
                                    break;
                                default:
                                    label.textContent = 'Data analizy:';
                                    break;
                            }
                        }
                    }
                    
                    // Auto-fetch je≈õli w≈ÇƒÖczone
                    const autoFetch = document.getElementById('auto-fetch');
                    if (autoFetch && autoFetch.checked) {
                        console.log('üîÑ Auto-fetch: zmiana typu analizy');
                        setTimeout(fetchSpotPrices, 500);
                    }
                });
            }
            
            // Auto-fetch przy zmianie dat - TYLKO je≈õli checkbox jest w≈ÇƒÖczony
            const dateSelect = document.getElementById('date-select');
            if (dateSelect) {
                dateSelect.addEventListener('change', () => {
                    const autoFetch = document.getElementById('auto-fetch');
                    if (autoFetch && autoFetch.checked) {
                        console.log('üîÑ Auto-fetch: zmiana daty pojedynczej');
                        setTimeout(fetchSpotPrices, 500);
                    }
                });
            }
            
            const dateFrom = document.getElementById('date-from');
            if (dateFrom) {
                dateFrom.addEventListener('change', () => {
                    const autoFetch = document.getElementById('auto-fetch');
                    const dateTo = document.getElementById('date-to');
                    if (autoFetch && autoFetch.checked && dateTo && dateTo.value) {
                        console.log('üîÑ Auto-fetch: zmiana daty poczƒÖtkowej');
                        setTimeout(fetchSpotPrices, 500);
                    }
                });
            }
            
            const dateTo = document.getElementById('date-to');
            if (dateTo) {
                dateTo.addEventListener('change', () => {
                    const autoFetch = document.getElementById('auto-fetch');
                    const dateFromEl = document.getElementById('date-from');
                    if (autoFetch && autoFetch.checked && dateFromEl && dateFromEl.value) {
                        console.log('üîÑ Auto-fetch: zmiana daty ko≈Ñcowej');
                        setTimeout(fetchSpotPrices, 500);
                    }
                });
            }
        }
        
        // === FUNKCJE ZAAWANSOWANYCH PROFILI ===
        
        function toggleAdvanced() {
            const section = document.getElementById('advanced-section');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                initializeAdvancedProfiles();
                // Smooth scroll to advanced section
                section.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                section.style.display = 'none';
            }
        }
        
        function initializeAdvancedProfiles() {
            // Inicjalizuj edytor godzinowy
            const container = document.getElementById('hour-sliders');
            container.innerHTML = '';
            
            for (let hour = 0; hour < 24; hour++) {
                const sliderDiv = document.createElement('div');
                sliderDiv.className = 'hour-slider';
                sliderDiv.innerHTML = `
                    <div class="hour-label" style="text-align: center; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">${hour}h</div>
                    <input type="number" class="hour-input" id="hour-${hour}" 
                           min="0" max="50" step="0.1" value="${currentProfile[hour].toFixed(1)}"
                           onchange="updateHourValue(${hour}, this.value)"
                           style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; text-align: center; font-size: 0.8rem;">
                `;
                container.appendChild(sliderDiv);
            }
        }
        
        function selectDay(day) {
            // Aktualizuj aktywny tab
            document.querySelectorAll('.day-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-day="${day}"]`).classList.add('active');
            
            selectedDay = day;
            
            // Aktualizuj tytu≈Ç
            const dayNames = {
                'all': 'Wszystkie dni',
                'monday': 'Poniedzia≈Çek',
                'tuesday': 'Wtorek', 
                'wednesday': '≈öroda',
                'thursday': 'Czwartek',
                'friday': 'PiƒÖtek',
                'saturday': 'Sobota',
                'sunday': 'Niedziela'
            };
            
            document.getElementById('editor-title').textContent = `Edycja profilu: ${dayNames[day]}`;
            
            // Za≈Çaduj profil dla wybranego dnia
            const profileToLoad = day === 'all' ? currentProfile : weeklyProfiles[day];
            
            for (let hour = 0; hour < 24; hour++) {
                const input = document.getElementById(`hour-${hour}`);
                if (input) {
                    input.value = profileToLoad[hour].toFixed(1);
                }
            }
        }
        
        function updateHourValue(hour, value) {
            const numValue = parseFloat(value) || 0;
            
            if (selectedDay === 'all') {
                currentProfile[hour] = numValue;
                // Aktualizuj tak≈ºe wszystkie dni tygodnia
                Object.keys(weeklyProfiles).forEach(day => {
                    weeklyProfiles[day][hour] = numValue;
                });
            } else {
                weeklyProfiles[selectedDay][hour] = numValue;
                useWeeklyProfiles = true;
            }
            
            // Przelicz koszty
            calculateCostsAndUpdate();
        }
        
        function applyPreset(presetName) {
            if (!usageProfiles[presetName]) return;
            
            const preset = [...usageProfiles[presetName]];
            
            if (selectedDay === 'all') {
                currentProfile = [...preset];
                // Aktualizuj wszystkie dni
                Object.keys(weeklyProfiles).forEach(day => {
                    weeklyProfiles[day] = [...preset];
                });
                useWeeklyProfiles = false;
            } else {
                weeklyProfiles[selectedDay] = [...preset];
                useWeeklyProfiles = true;
            }
            
            // Apply seasonal adjustments if needed
            if (currentSeason !== 'all') {
                applySeasonalAdjustments();
            }
            
            // Aktualizuj UI
            for (let hour = 0; hour < 24; hour++) {
                const input = document.getElementById(`hour-${hour}`);
                if (input) {
                    input.value = preset[hour].toFixed(1);
                }
            }
            
            calculateCostsAndUpdate();
        }
        
        function resetCurrentDay() {
            applyPreset('standard');
        }
        
        function copyToAllDays() {
            if (selectedDay === 'all') return;
            
            const profileToCopy = [...weeklyProfiles[selectedDay]];
            
            Object.keys(weeklyProfiles).forEach(day => {
                weeklyProfiles[day] = [...profileToCopy];
            });
            
            currentProfile = [...profileToCopy];
            
            alert(`Profil z ${selectedDay} skopiowany na wszystkie dni tygodnia.`);
            calculateCostsAndUpdate();
        }
        
        function saveCustomProfile() {
            const profileData = selectedDay === 'all' ? currentProfile : weeklyProfiles[selectedDay];
            const profileName = prompt('Nazwa profilu:', `M√≥j profil ${selectedDay}`);
            
            if (profileName) {
                // Zapisz w localStorage
                const savedProfiles = JSON.parse(localStorage.getItem('customProfiles') || '{}');
                savedProfiles[profileName] = [...profileData];
                localStorage.setItem('customProfiles', JSON.stringify(savedProfiles));
                
                alert(`Profil "${profileName}" zosta≈Ç zapisany!`);
            }
        }
        
        function getAverageWeeklyProfile() {
            try {
                // Oblicz ≈õredni profil tygodniowy (5 dni roboczych + 2 dni weekend)
                const avgProfile = new Array(24).fill(0);
                
                for (let hour = 0; hour < 24; hour++) {
                    let total = 0;
                    let count = 0;
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                    
                    days.forEach(day => {
                        if (weeklyProfiles[day] && weeklyProfiles[day][hour] !== undefined) {
                            total += weeklyProfiles[day][hour];
                            count++;
                        }
                    });
                    
                    avgProfile[hour] = count > 0 ? total / count : 100/24;
                }
                
                return avgProfile;
            } catch (error) {
                console.error('B≈ÇƒÖd podczas obliczania ≈õredniego profilu tygodniowego:', error);
                return new Array(24).fill(100/24);
            }
        }
    </script>
</body>
</html>
