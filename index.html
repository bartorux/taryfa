<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator taryf energii - rzeczywiste ceny ENTSO-E</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            text-align: center;
            color: rgba(255,255,255,0.9);
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        
        .api-status {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #155724;
        }
        
        .api-status.loading {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .api-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .controls-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        input, select, textarea {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .profile-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .profile-btn {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .profile-btn:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }
        
        .profile-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .chart-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .chart-wrapper {
            position: relative;
            height: 350px;
        }
        
        .hourly-analysis {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            grid-column: 1 / -1;
        }
        
        .entso-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .fetch-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .fetch-btn:hover:not(:disabled) {
            background: #229954;
            transform: translateY(-1px);
        }
        
        .fetch-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .auto-fetch {
            margin-left: 10px;
        }
        
        .price-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .prices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        .price-cell {
            background: white;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            font-size: 0.8rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .price-hour {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 2px;
        }
        
        .price-value {
            color: #27ae60;
            font-weight: 600;
        }
        
        .currency-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 8px;
            background: #e8f4f8;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .currency-rate {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .hour-grid {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin-top: 15px;
        }
        
        .hour-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            position: relative;
        }
        
        .hour-label {
            font-size: 0.6rem;
            margin-bottom: 5px;
            text-align: center;
            color: #666;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        
        .summary-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .summary-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .summary-card.best {
            background: #d4edda;
            border: 2px solid #c3e6cb;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .summary-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .savings {
            color: #27ae60;
            font-weight: bold;
        }
        
        .loss {
            color: #e74c3c;
            font-weight: bold;
        }
        
        /* Styles dla sekcji zaawansowanej */
        .profile-editor {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
        
        .day-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .day-tab {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .day-tab:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }
        
        .day-tab.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .profile-controls {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        
        .profile-presets h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .preset-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .preset-buttons button {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .preset-buttons button:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }
        
        .hourly-editor h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .hour-sliders {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .hour-slider {
            text-align: center;
        }
        
        .hour-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .hour-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.8rem;
        }
        
        .editor-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .editor-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .editor-actions button:nth-child(1) { background: #f39c12; color: white; }
        .editor-actions button:nth-child(2) { background: #9b59b6; color: white; }
        .editor-actions button:nth-child(3) { background: #27ae60; color: white; }
        
        .editor-actions button:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .hour-grid {
                grid-template-columns: repeat(12, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚡ Kalkulator Taryf z ENTSO-E</h1>
        <div class="subtitle">Rzeczywiste ceny spot dla Polski + porównanie wszystkich taryf</div>
        
        <div class="api-status" id="api-status">
            <strong>🔌 API ENTSO-E:</strong> Kliknij "Pobierz ceny spot" aby pobrać rzeczywiste ceny energii z ENTSO-E Transparency Platform<br>
            <small>💡 <strong>Ważne:</strong> ENTSO-E ma dane tylko z przeszłości (maksymalnie do wczoraj)</small>
        </div>
        
        <!-- Sekcja ENTSO-E API -->
        <div class="entso-section">
            <h3>🌍 Rzeczywiste ceny energii (ENTSO-E Transparency Platform)</h3>
            <div class="controls-grid">
                <div class="input-group">
                    <label for="analysis-type">Typ analizy:</label>
                    <select id="analysis-type">
                        <option value="single-day">Pojedynczy dzień</option>
                        <option value="date-range">Zakres dat</option>
                        <option value="week-analysis">Analiza tygodniowa</option>
                        <option value="month-analysis">Analiza miesięczna</option>
                    </select>
                </div>
        </div>
        
        <!-- Sekcja zaawansowana - ukryta domyślnie -->
        <div class="controls-section" id="advanced-section" style="display: none;">
            <h3>🔧 Zaawansowane profile zużycia</h3>
            <p style="margin-bottom: 20px; color: #666;">
                Ustaw różne profile zużycia dla poszczególnych dni tygodnia. 
                Przydatne np. dla ładowania auta elektrycznego tylko w określone dni.
            </p>
            
            <div class="profile-editor">
                <div class="day-tabs">
                    <button class="day-tab active" onclick="selectDay('all')" data-day="all">Wszystkie dni</button>
                    <button class="day-tab" onclick="selectDay('monday')" data-day="monday">Poniedziałek</button>
                    <button class="day-tab" onclick="selectDay('tuesday')" data-day="tuesday">Wtorek</button>
                    <button class="day-tab" onclick="selectDay('wednesday')" data-day="wednesday">Środa</button>
                    <button class="day-tab" onclick="selectDay('thursday')" data-day="thursday">Czwartek</button>
                    <button class="day-tab" onclick="selectDay('friday')" data-day="friday">Piątek</button>
                    <button class="day-tab" onclick="selectDay('saturday')" data-day="saturday">Sobota</button>
                    <button class="day-tab" onclick="selectDay('sunday')" data-day="sunday">Niedziela</button>
                </div>
                
                <div class="profile-controls">
                    <div class="profile-presets">
                        <h4>Gotowe wzorce:</h4>
                        <div class="preset-buttons">
                            <button onclick="applyPreset('standard')">🏠 Standard</button>
                            <button onclick="applyPreset('morning')">🌅 Poranny</button>
                            <button onclick="applyPreset('evening')">🌆 Wieczorny</button>
                            <button onclick="applyPreset('night')">🌙 Nocny</button>
                            <button onclick="applyPreset('ev_charging')">⚡ Ładowanie EV (22-6h)</button>
                            <button onclick="applyPreset('heat_pump')">🔥 Pompa ciepła</button>
                        </div>
                    </div>
                    
                    <div class="hourly-editor">
                        <h4 id="editor-title">Edycja profilu: Wszystkie dni</h4>
                        <div class="hour-sliders" id="hour-sliders">
                            <!-- Wypełniane dynamicznie -->
                        </div>
                        <div class="editor-actions">
                            <button onclick="resetCurrentDay()">🔄 Reset dnia</button>
                            <button onclick="copyToAllDays()">📋 Kopiuj na wszystkie dni</button>
                            <button onclick="saveCustomProfile()">💾 Zapisz profil</button>
                        </div>
                    </div>
                </div>
            </div>
                <div class="input-group" id="single-date-group">
                    <label for="date-select">Data analizy:</label>
                    <input type="date" id="date-select" value="">
                </div>
                <div class="input-group" id="date-range-group" style="display: none;">
                    <label for="date-from">Od:</label>
                    <input type="date" id="date-from" value="">
                </div>
                <div class="input-group" id="date-range-group-to" style="display: none;">
                    <label for="date-to">Do:</label>
                    <input type="date" id="date-to" value="">
                </div>
                <div class="input-group">
                    <label for="eur-pln-rate">Kurs EUR/PLN:</label>
                    <input type="number" id="eur-pln-rate" value="4.30" step="0.01" min="3" max="6" readonly>
                    <button class="fetch-btn" onclick="fetchExchangeRate()" style="margin-top: 5px; padding: 6px 12px; font-size: 0.8rem;">
                        💱 Pobierz aktualny kurs NBP
                    </button>
                </div>
                <div class="input-group">
                    <label for="g11f-margin">Dodatkowa marża G11f (zł/kWh):</label>
                    <input type="number" id="g11f-margin" value="0.05" step="0.001" min="0" max="0.2">
                </div>
                <div class="input-group">
                    <label>&nbsp;</label>
                    <button class="fetch-btn" onclick="fetchSpotPrices()">
                        📊 Pobierz ceny spot
                    </button>
                    <label class="auto-fetch">
                        <input type="checkbox" id="auto-fetch" checked> Auto-odświeżanie
                    </label>
                </div>
            </div>
            <div class="price-preview" id="price-preview" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>📊 Ceny spot dla Polski:</strong>
                    <div id="price-stats" style="font-size: 0.9rem; color: #666;"></div>
                </div>
                <div class="prices-grid" id="spot-prices-grid"></div>
                <div class="currency-info" id="currency-info"></div>
            </div>
        </div>
        
        <!-- Kontrolki podstawowe -->
        <div class="controls-section">
            <h3>⚙️ Parametry gospodarstwa</h3>
            <div class="controls-grid">
                <div class="input-group">
                    <label for="monthly-usage">Miesięczne zużycie (kWh):</label>
                    <input type="number" id="monthly-usage" value="300" min="0" step="10">
                </div>
                <div class="input-group">
                    <label for="annual-usage">Roczne zużycie (kWh):</label>
                    <input type="number" id="annual-usage" value="3600" min="0" step="100">
                </div>
                <div class="input-group">
                    <label for="installation-type">Typ instalacji:</label>
                    <select id="installation-type">
                        <option value="1-phase">1-fazowa</option>
                        <option value="3-phase" selected>3-fazowa</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>&nbsp;</label>
                    <button class="fetch-btn" onclick="toggleAdvanced()" style="background: #2c3e50;">
                        ⚙️ Zaawansowane profile
                    </button>
                </div>
            </div>
            
            <div class="profile-section">
                <h4>📈 Profile zużycia energii</h4>
                <div class="profile-grid">
                    <div class="profile-btn active" onclick="setUsageProfile('standard')">
                        🏠 Standard<br><small>Równomierne zużycie</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('morning')">
                        🌅 Poranny<br><small>Pik 6-9, 17-21</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('evening')">
                        🌆 Wieczorny<br><small>Pik 18-23</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('night')">
                        🌙 Nocny<br><small>Pik 22-6</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('flexible')">
                        🔄 Elastyczny<br><small>Dostosowany do G12</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('homeoffice')">
                        💻 Home Office<br><small>Równomierne 8-18</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Podsumowanie kosztów -->
        <div class="summary-section">
            <h3>💰 Porównanie miesięcznych kosztów</h3>
            <div class="summary-grid" id="cost-summary">
                <!-- Wypełniane dynamicznie -->
            </div>
        </div>
        
        <!-- Wykresy -->
        <div class="charts-section">
            <div class="chart-container">
                <div class="chart-title">Stawki w ciągu doby</div>
                <div class="chart-wrapper">
                    <canvas id="hourlyRatesChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">Profil zużycia vs ceny</div>
                <div class="chart-wrapper">
                    <canvas id="costProfileChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Analiza godzinowa -->
        <div class="hourly-analysis">
            <div class="chart-title">🕐 Analiza godzinowa taryf</div>
            
            <h4>G11f - Dynamiczna (ceny spot + stały składnik 0,0516 zł/kWh + marża)</h4>
            <div class="hour-label">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g11f-hours"></div>
            
            <h4 style="margin-top: 20px;">G12 - Dzień/Noc</h4>
            <div class="hour-label">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g12-hours"></div>
            
            <h4 style="margin-top: 20px;">G12w - Weekendowa (+ całe weekendy w taryfie nocnej)</h4>
            <div class="hour-label">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g12w-hours"></div>
            
            <h4 style="margin-top: 20px;">G12r - Szczyt/Pozaszczyt</h4>
            <div class="hour-label">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g12r-hours"></div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span>Drożej (dzień/szczyt)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #27ae60;"></div>
                    <span>Taniej (noc/pozaszczyt)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, #27ae60, #f39c12, #e74c3c);"></div>
                    <span>Dynamiczna (zielony=tanie, czerwony=drogie)</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Twój token ENTSO-E (będzie używany automatycznie)
        const ENTSO_API_TOKEN = '74e2281c-6281-46b5-8805-7d5b3dc7389b';
        const POLAND_DOMAIN = '10YPL-AREA-----S';
        
        // Definicje taryf z Energa Operator
        const tariffs = {
            G11: {
                name: "G11 - Jednostrefowa",
                rate: 0.3437,
                fixedMonthly: { "1-phase": 7.68, "3-phase": 11.54 },
                type: "flat"
            },
            G11f: {
                name: "G11f - Dynamiczna", 
                baseRate: 0.0516, // Stały składnik zmienny stawki sieciowej
                fixedMonthly: { "1-phase": 38.69, "3-phase": 54.37 }, // Stały składnik stawki sieciowej
                type: "dynamic"
            },
            G12: {
                name: "G12 - Dzień/Noc",
                rates: { day: 0.3791, night: 0.0816 },
                zones: [
                    // dzień: 6-13, 15-22; noc: 13-15, 22-6
                    'night','night','night','night','night','night', // 0-5
                    'day','day','day','day','day','day','day', // 6-12
                    'night','night', // 13-14
                    'day','day','day','day','day','day','day', // 15-21
                    'night','night' // 22-23
                ],
                fixedMonthly: { "1-phase": 14.07, "3-phase": 19.77 }
            },
            G12w: {
                name: "G12w - Weekendowa",
                rates: { day: 0.3960, night: 0.0838 },
                zones: [
                    'night','night','night','night','night','night',
                    'day','day','day','day','day','day','day',
                    'night','night',
                    'day','day','day','day','day','day','day',
                    'night','night'
                ],
                weekendAllNight: true,
                fixedMonthly: { "1-phase": 14.07, "3-phase": 19.77 }
            },
            G12r: {
                name: "G12r - Szczyt/Pozaszczyt", 
                rates: { peak: 0.3590, offpeak: 0.0870 },
                zones: [
                    // szczyt: 7-13, 16-22; pozaszczyt: 13-16, 22-7
                    'offpeak','offpeak','offpeak','offpeak','offpeak','offpeak','offpeak', // 0-6
                    'peak','peak','peak','peak','peak','peak', // 7-12
                    'offpeak','offpeak','offpeak', // 13-15
                    'peak','peak','peak','peak','peak','peak', // 16-21
                    'offpeak','offpeak' // 22-23
                ],
                fixedMonthly: { "1-phase": 14.07, "3-phase": 19.77 }
            }
        };
        
        // Systemowe opłaty
        const systemCharges = {
            subscription: 4.56,
            quality: 0.0321,
            oze: 0.0035,
            cogeneration: 0.003,
        };
        
        function getTransitionFee(annualUsage) {
            if (annualUsage < 500) return 0.02;
            if (annualUsage <= 1200) return 0.10;
            return 0.33;
        }
        
        function getPowerFee(annualUsage) {
            if (annualUsage < 500) return 2.86;
            if (annualUsage <= 1200) return 6.86;
            if (annualUsage <= 2800) return 11.44;
            return 16.01;
        }
        
        // Profile zużycia (% dla każdej godziny doby)
        const usageProfiles = {
            standard: new Array(24).fill(100/24), // równomierne
            morning: [2,2,2,2,2,8,12,12,8,4,4,4,4,4,4,4,8,12,12,8,6,4,3,2], // poranki + wieczory
            evening: [2,2,2,2,2,3,6,8,4,3,3,3,3,3,3,3,4,6,12,15,15,8,4,2], // wieczorny pik
            night: [8,8,8,6,4,2,2,2,2,2,2,2,2,2,2,2,2,3,4,6,8,12,15,15], // nocny
            flexible: [8,8,8,8,6,4,2,2,2,2,2,2,8,8,4,2,2,2,2,2,4,6,8,8], // dostosowany do G12
            homeoffice: [3,2,2,2,2,4,6,8,10,8,6,6,6,8,8,6,6,4,3,2,2,2,2,2], // home office
            ev_charging: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,50,50,0], // ładowanie EV 21-23h
            heat_pump: [6,6,6,6,6,8,4,2,2,2,2,2,2,2,2,2,2,4,6,8,8,8,8,6] // pompa ciepła
        };
        
        let currentProfile = [...usageProfiles.standard];
        let weeklyProfiles = {
            monday: [...usageProfiles.standard],
            tuesday: [...usageProfiles.standard],
            wednesday: [...usageProfiles.standard],
            thursday: [...usageProfiles.standard],
            friday: [...usageProfiles.standard],
            saturday: [...usageProfiles.standard],
            sunday: [...usageProfiles.standard]
        };
        let selectedDay = 'all';
        let useWeeklyProfiles = false;
        let spotPrices = null;
        let spotPricesRange = []; // Dla zakresów dat
        let hourlyChart = null;
        let costChart = null;
        let currentExchangeRate = 4.30;
        
        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', function() {
            // Ustaw wczorajszą datę (ENTSO-E ma opóźnienie ~1 dzień)
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            const weekAgo = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
            
            // Ustaw maksymalną datę na wczoraj dla wszystkich pól dat
            document.getElementById('date-select').value = yesterday;
            document.getElementById('date-select').max = yesterday;
            document.getElementById('date-from').value = weekAgo;
            document.getElementById('date-from').max = yesterday;
            document.getElementById('date-to').value = yesterday;
            document.getElementById('date-to').max = yesterday;
            
            // Pobierz aktualny kurs EUR/PLN
            fetchExchangeRate();
            
            // NIE MA AUTO-FETCH - użytkownik musi kliknąć przycisk żeby pobrać prawdziwe dane
            
            // Event listenery
            setupEventListeners();
            
            // Wstępne obliczenia bez cen spot (używa standardowych taryf)
            calculateCostsAndUpdate();
        });
        
        async function fetchExchangeRate() {
            try {
                // Spróbuj kilka źródeł kursu EUR/PLN
                let rate = null;
                let source = '';
                
                console.log('🔄 Pobieranie kursu EUR/PLN...');
                
                // 1. Spróbuj NBP API przez CORS proxy
                try {
                    const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://api.nbp.pl/api/exchangerates/rates/a/eur/?format=json'));
                    if (response.ok) {
                        const data = await response.json();
                        const nbpData = JSON.parse(data.contents);
                        rate = nbpData.rates[0].mid;
                        source = `NBP (${nbpData.rates[0].effectiveDate})`;
                        console.log('✅ NBP API działa:', rate);
                    }
                } catch (e) {
                    console.log('❌ NBP API niedostępne:', e.message);
                }
                
                // 2. Fallback - ExchangeRate-API (obsługuje CORS)
                if (!rate) {
                    try {
                        const response = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
                        if (response.ok) {
                            const data = await response.json();
                            rate = data.rates.PLN;
                            source = 'ExchangeRate-API';
                            console.log('✅ ExchangeRate-API działa:', rate);
                        }
                    } catch (e) {
                        console.log('❌ ExchangeRate-API niedostępne:', e.message);
                    }
                }
                
                // 3. Ostatni fallback - domyślne wartości
                if (!rate) {
                    rate = 4.30; // Konserwatywna wartość
                    source = 'Wartość domyślna (API niedostępne)';
                    console.log('⚠️ Używam domyślnego kursu:', rate);
                }
                
                currentExchangeRate = rate;
                document.getElementById('eur-pln-rate').value = rate.toFixed(4);
                
                console.log(`📊 Kurs EUR/PLN: ${rate.toFixed(4)} (${source})`);
                
                // Aktualizuj wyświetlanie jeśli są już ceny
                if (spotPrices) {
                    updateSpotPricesDisplay();
                }
                
                // Pokaż komunikat o sukcesie
                const currencyInfo = document.getElementById('currency-info');
                if (currencyInfo) {
                    currencyInfo.innerHTML = `
                        💱 <span class="currency-rate">Kurs EUR/PLN: ${rate.toFixed(4)}</span>
                        <span style="margin-left: 20px;">📡 Źródło: ${source}</span>
                    `;
                }
                
            } catch (error) {
                console.error('❌ Błąd pobierania kursu:', error);
                
                // Fallback na domyślny kurs
                const defaultRate = 4.30;
                document.getElementById('eur-pln-rate').value = defaultRate.toFixed(4);
                
                const currencyInfo = document.getElementById('currency-info');
                if (currencyInfo) {
                    currencyInfo.innerHTML = `
                        ⚠️ <span style="color: #f39c12;">Kurs domyślny: ${defaultRate.toFixed(4)} PLN/EUR</span>
                        <span style="margin-left: 20px;">💡 Możesz edytować ręcznie</span>
                    `;
                }
            }
        }
        
        async function fetchSpotPrices() {
            const analysisType = document.getElementById('analysis-type').value;
            const statusDiv = document.getElementById('api-status');
            const btn = document.querySelector('.fetch-btn');
            
            let startDate, endDate;
            const today = new Date();
            const yesterday = new Date(Date.now() - 86400000);
            
            // Określ zakres dat na podstawie typu analizy
            switch (analysisType) {
                case 'single-day':
                    const singleDate = document.getElementById('date-select').value;
                    if (!singleDate) {
                        alert('Wybierz datę analizy');
                        return;
                    }
                    
                    // Sprawdź czy data nie jest z przyszłości
                    const selectedDate = new Date(singleDate);
                    if (selectedDate >= today) {
                        alert('❌ ENTSO-E API ma dane tylko z przeszłości!\n\nNajnowsze dostępne dane to z wczoraj. Wybierz wcześniejszą datę.');
                        return;
                    }
                    
                    startDate = endDate = singleDate;
                    break;
                    
                case 'date-range':
                    startDate = document.getElementById('date-from').value;
                    endDate = document.getElementById('date-to').value;
                    if (!startDate || !endDate) {
                        alert('Wybierz zakres dat');
                        return;
                    }
                    
                    // Sprawdź czy daty nie są z przyszłości
                    const startDateObj = new Date(startDate);
                    const endDateObj = new Date(endDate);
                    if (startDateObj >= today || endDateObj >= today) {
                        alert('❌ ENTSO-E API ma dane tylko z przeszłości!\n\nNajnowsze dostępne dane to z wczoraj. Wybierz wcześniejsze daty.');
                        return;
                    }
                    
                    break;
                    
                case 'week-analysis':
                    const weekDate = document.getElementById('date-select').value;
                    if (!weekDate) {
                        alert('Wybierz datę dla analizy tygodniowej');
                        return;
                    }
                    
                    const weekDateObj = new Date(weekDate);
                    if (weekDateObj >= yesterday) {
                        alert('❌ ENTSO-E API ma dane tylko z przeszłości!\n\nWybierz datę z wcześniejszego tygodnia.');
                        return;
                    }
                    
                    const weekStart = new Date(weekDate);
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1); // Poniedziałek
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6); // Niedziela
                    
                    startDate = weekStart.toISOString().split('T')[0];
                    endDate = weekEnd.toISOString().split('T')[0];
                    break;
                    
                case 'month-analysis':
                    const monthDate = new Date(document.getElementById('date-select').value);
                    if (!monthDate.getTime()) {
                        alert('Wybierz datę dla analizy miesięcznej');
                        return;
                    }
                    
                    if (monthDate >= yesterday) {
                        alert('❌ ENTSO-E API ma dane tylko z przeszłości!\n\nWybierz datę z wcześniejszego miesiąca.');
                        return;
                    }
                    
                    startDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1).toISOString().split('T')[0];
                    endDate = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).toISOString().split('T')[0];
                    break;
            }
            
            // UI feedback
            statusDiv.className = 'api-status loading';
            statusDiv.innerHTML = `<strong>⏳ Pobieranie:</strong> Rzeczywiste dane z ENTSO-E API...`;
            btn.disabled = true;
            btn.textContent = '⏳ Pobieranie...';
            
            try {
                if (analysisType === 'single-day') {
                    // Pojedynczy dzień
                    await fetchSingleDayPrices(startDate);
                    statusDiv.className = 'api-status';
                    statusDiv.innerHTML = `<strong>✅ Pobrano:</strong> Rzeczywiste ceny spot dla ${startDate} z ENTSO-E`;
                } else {
                    // Zakres dat
                    await fetchDateRangePrices(startDate, endDate);
                    statusDiv.className = 'api-status';
                    statusDiv.innerHTML = `<strong>✅ Pobrano:</strong> Rzeczywiste ceny spot dla zakresu ${startDate} - ${endDate} z ENTSO-E`;
                }
                
                updateSpotPricesDisplay();
                calculateCostsAndUpdate();
                
            } catch (error) {
                console.error('❌ Błąd pobierania danych ENTSO-E:', error);
                
                statusDiv.className = 'api-status error';
                statusDiv.innerHTML = `<strong>❌ Błąd API ENTSO-E:</strong> ${error.message}<br>
                    <small>💡 <strong>Wskazówka:</strong> ENTSO-E ma dane tylko z przeszłości (do wczoraj). 
                    Jeśli wybrałeś datę z przyszłości, wybierz wcześniejszą datę.</small>`;
                
                // NIE MA FALLBACK - musi działać prawdziwe API
                spotPrices = null;
            }
            
            // Reset UI
            btn.disabled = false;
            btn.textContent = '📊 Pobierz ceny spot';
        }
        
        async function fetchSingleDayPrices(date) {
            // Format daty dla ENTSO-E API (YYYYMMDDHHMM)
            const targetDate = new Date(date);
            const nextDay = new Date(targetDate);
            nextDay.setDate(nextDay.getDate() + 1);
            
            const startDateTime = date.replace(/-/g, '') + '0000';
            const endDateTime = nextDay.toISOString().split('T')[0].replace(/-/g, '') + '0000';
            
            console.log(`Pobieranie danych ENTSO-E dla: ${date} (${startDateTime} - ${endDateTime})`);
            
            // Spróbuj różne metody CORS
            const methods = [
                // Metoda 1: allorigins proxy
                async () => {
                    const apiUrl = `https://web-api.tp.entsoe.eu/api?` +
                        `securityToken=${ENTSO_API_TOKEN}&` +
                        `documentType=A44&` +
                        `in_Domain=${POLAND_DOMAIN}&` +
                        `out_Domain=${POLAND_DOMAIN}&` +
                        `periodStart=${startDateTime}&` +
                        `periodEnd=${endDateTime}`;
                    
                    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(apiUrl);
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) throw new Error(`AllOrigins proxy error: ${response.status}`);
                    
                    const data = await response.json();
                    if (!data.contents) throw new Error('Brak contents w odpowiedzi AllOrigins');
                    
                    return data.contents;
                },
                
                // Metoda 2: corsproxy.io
                async () => {
                    const apiUrl = `https://web-api.tp.entsoe.eu/api?` +
                        `securityToken=${ENTSO_API_TOKEN}&` +
                        `documentType=A44&` +
                        `in_Domain=${POLAND_DOMAIN}&` +
                        `out_Domain=${POLAND_DOMAIN}&` +
                        `periodStart=${startDateTime}&` +
                        `periodEnd=${endDateTime}`;
                    
                    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(apiUrl);
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) throw new Error(`CorsProxy error: ${response.status}`);
                    
                    return await response.text();
                },
                
                // Metoda 3: cors-anywhere
                async () => {
                    const apiUrl = `https://web-api.tp.entsoe.eu/api?` +
                        `securityToken=${ENTSO_API_TOKEN}&` +
                        `documentType=A44&` +
                        `in_Domain=${POLAND_DOMAIN}&` +
                        `out_Domain=${POLAND_DOMAIN}&` +
                        `periodStart=${startDateTime}&` +
                        `periodEnd=${endDateTime}`;
                    
                    const proxyUrl = 'https://cors-anywhere.herokuapp.com/' + apiUrl;
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) throw new Error(`CORS-Anywhere error: ${response.status}`);
                    
                    return await response.text();
                }
            ];
            
            let xmlText = null;
            let lastError = null;
            
            // Próbuj każdą metodę CORS
            for (let i = 0; i < methods.length; i++) {
                try {
                    console.log(`Próba ${i + 1}: Pobieranie przez proxy...`);
                    xmlText = await methods[i]();
                    console.log(`✅ Sukces przez proxy ${i + 1}`);
                    break;
                } catch (error) {
                    console.warn(`❌ Proxy ${i + 1} nie działa:`, error.message);
                    lastError = error;
                    continue;
                }
            }
            
            if (!xmlText) {
                throw new Error(`Wszystkie proxy CORS nie działają. Ostatni błąd: ${lastError?.message}`);
            }
            
            // Parsuj XML z ENTSO-E
            const prices = parseENTSOEXML(xmlText);
            
            if (prices.length === 0) {
                throw new Error('Brak danych cenowych w odpowiedzi ENTSO-E lub błąd parsowania XML');
            }
            
            // Sprawdź czy mamy 24 godziny
            if (prices.length !== 24) {
                console.warn(`Otrzymano ${prices.length} cen zamiast 24`);
                // Dopełnij lub obetnij do 24 godzin
                while (prices.length < 24) {
                    prices.push(prices[prices.length - 1] || 50); // Domyślna cena 50 €/MWh
                }
                if (prices.length > 24) {
                    prices.splice(24);
                }
            }
            
            spotPrices = prices;
            console.log('✅ Pobrano prawdziwe dane ENTSO-E:', {
                data: date,
                liczba_cen: prices.length,
                min: Math.min(...prices).toFixed(2) + ' €/MWh',
                max: Math.max(...prices).toFixed(2) + ' €/MWh',
                średnia: (prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(2) + ' €/MWh',
                przykład: prices.slice(0, 3).map(p => p.toFixed(2)).join(', ') + '...'
            });
        }
        
        async function fetchDateRangePrices(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            if (daysDiff > 31) {
                throw new Error('Maksymalny zakres to 31 dni');
            }
            
            spotPricesRange = [];
            const currentDate = new Date(start);
            
            for (let i = 0; i < daysDiff; i++) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                console.log(`Pobieranie danych dla dnia ${i + 1}/${daysDiff}: ${dateStr}`);
                
                try {
                    await fetchSingleDayPrices(dateStr);
                    spotPricesRange.push({
                        date: dateStr,
                        prices: [...spotPrices]
                    });
                } catch (error) {
                    console.error(`❌ Błąd pobierania danych dla ${dateStr}:`, error.message);
                    throw new Error(`Nie udało się pobrać danych dla ${dateStr}: ${error.message}`);
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
                
                // Krótkая pauza między żądaniami aby nie przeciążyć API
                if (i < daysDiff - 1) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            // Ustaw średnie ceny dla analizy
            if (spotPricesRange.length > 0) {
                spotPrices = calculateAverageHourlyPrices(spotPricesRange);
                console.log(`✅ Obliczono średnie ceny z ${spotPricesRange.length} dni`);
            } else {
                throw new Error('Nie udało się pobrać żadnych danych cenowych');
            }
        }
        
        function parseENTSOEXML(xmlText) {
            try {
                console.log('Parsowanie XML z ENTSO-E...');
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                // Sprawdź błędy parsowania
                const parseError = xmlDoc.querySelector('parsererror');
                if (parseError) {
                    throw new Error(`Błąd parsowania XML: ${parseError.textContent}`);
                }
                
                // Sprawdź błędy ENTSO-E API
                const errorElement = xmlDoc.querySelector('Reason, text');
                if (errorElement && errorElement.textContent.includes('No matching data found')) {
                    throw new Error(`ENTSO-E API: ${errorElement.textContent}`);
                }
                
                // Znajdź dane cenowe - różne możliwe struktury XML
                const timeSeries = xmlDoc.querySelectorAll('TimeSeries');
                const prices = new Array(24).fill(null);
                
                console.log(`Znaleziono ${timeSeries.length} TimeSeries`);
                
                if (timeSeries.length === 0) {
                    // Spróbuj alternatywnej struktury
                    const periods = xmlDoc.querySelectorAll('Period');
                    console.log(`Znaleziono ${periods.length} Periods`);
                    
                    periods.forEach(period => {
                        const points = period.querySelectorAll('Point');
                        points.forEach(point => {
                            const positionEl = point.querySelector('position');
                            const priceEl = point.querySelector('price\\.amount, amount');
                            
                            if (positionEl && priceEl) {
                                const position = parseInt(positionEl.textContent) - 1; // ENTSO-E używa 1-based indexing
                                const price = parseFloat(priceEl.textContent);
                                
                                if (position >= 0 && position < 24 && !isNaN(price)) {
                                    prices[position] = price;
                                }
                            }
                        });
                    });
                } else {
                    // Standardowa struktura TimeSeries
                    timeSeries.forEach(ts => {
                        const points = ts.querySelectorAll('Point');
                        points.forEach(point => {
                            const positionEl = point.querySelector('position');
                            const priceEl = point.querySelector('price\\.amount, amount');
                            
                            if (positionEl && priceEl) {
                                const position = parseInt(positionEl.textContent) - 1; // ENTSO-E używa 1-based indexing
                                const price = parseFloat(priceEl.textContent);
                                
                                if (position >= 0 && position < 24 && !isNaN(price)) {
                                    prices[position] = price;
                                }
                            }
                        });
                    });
                }
                
                // Sprawdź czy udało się wyparsować jakiekolwiek ceny
                const validPrices = prices.filter(p => p !== null && !isNaN(p));
                console.log(`Wyparsowano ${validPrices.length} ważnych cen z 24`);
                
                if (validPrices.length === 0) {
                    console.error('XML content:', xmlText.substring(0, 1000) + '...');
                    throw new Error('Nie udało się wyparsować żadnych cen z XML');
                }
                
                // Wypełnij brakujące ceny interpolacją lub średnią
                const avgPrice = validPrices.reduce((a, b) => a + b, 0) / validPrices.length;
                
                for (let i = 0; i < 24; i++) {
                    if (prices[i] === null || isNaN(prices[i])) {
                        // Spróbuj interpolacji z sąsiadami
                        let leftPrice = null, rightPrice = null;
                        
                        for (let j = i - 1; j >= 0; j--) {
                            if (prices[j] !== null) {
                                leftPrice = prices[j];
                                break;
                            }
                        }
                        
                        for (let j = i + 1; j < 24; j++) {
                            if (prices[j] !== null) {
                                rightPrice = prices[j];
                                break;
                            }
                        }
                        
                        if (leftPrice !== null && rightPrice !== null) {
                            prices[i] = (leftPrice + rightPrice) / 2;
                        } else if (leftPrice !== null) {
                            prices[i] = leftPrice;
                        } else if (rightPrice !== null) {
                            prices[i] = rightPrice;
                        } else {
                            prices[i] = avgPrice;
                        }
                    }
                }
                
                console.log('✅ Parsowanie XML zakończone pomyślnie');
                return prices;
                
            } catch (error) {
                console.error('Błąd parsowania XML:', error);
                throw error;
            }
        }
        
        function calculateAverageHourlyPrices(pricesRange) {
            const hourlyAverages = new Array(24).fill(0);
            const hourlyCounts = new Array(24).fill(0);
            
            pricesRange.forEach(dayData => {
                dayData.prices.forEach((price, hour) => {
                    if (price && price > 0) {
                        hourlyAverages[hour] += price;
                        hourlyCounts[hour]++;
                    }
                });
            });
            
            return hourlyAverages.map((sum, hour) => 
                hourlyCounts[hour] > 0 ? sum / hourlyCounts[hour] : 0
            );
        }
        
        function updateSpotPricesDisplay() {
            const eurPln = parseFloat(document.getElementById('eur-pln-rate').value);
            const preview = document.getElementById('price-preview');
            const grid = document.getElementById('spot-prices-grid');
            const stats = document.getElementById('price-stats');
            const currencyInfo = document.getElementById('currency-info');
            
            if (!spotPrices || spotPrices.length === 0) {
                preview.style.display = 'none';
                return;
            }
            
            // Przelicz ceny na zł/kWh
            const pricesInPLN = spotPrices.map(price => (price * eurPln / 1000));
            
            // Oblicz statystyki
            const minPrice = Math.min(...pricesInPLN);
            const maxPrice = Math.max(...pricesInPLN);
            const avgPrice = pricesInPLN.reduce((a, b) => a + b, 0) / pricesInPLN.length;
            
            // Wyświetl statystyki
            stats.innerHTML = `
                <strong>📊 PRAWDZIWE DANE ENTSO-E:</strong> 
                Min: ${minPrice.toFixed(4)} zł/kWh | 
                Śr: ${avgPrice.toFixed(4)} zł/kWh | 
                Max: ${maxPrice.toFixed(4)} zł/kWh
            `;
            
            // Wyświetl info o kursie (tylko jeśli nie ma już info z fetchExchangeRate)
            if (!currencyInfo.innerHTML || currencyInfo.innerHTML.includes('Ostatnia aktualizacja')) {
                currencyInfo.innerHTML = `
                    💱 <span class="currency-rate">Kurs: ${eurPln.toFixed(4)} PLN/EUR</span>
                    <span style="margin-left: 20px;">⚡ Źródło: ENTSO-E Transparency Platform</span>
                    <span style="margin-left: 20px;">📊 Zakres: ${minPrice.toFixed(4)} - ${maxPrice.toFixed(4)} zł/kWh</span>
                `;
            }
            
            // Wyczyść siatkę
            grid.innerHTML = '';
            
            // Wypełnij siatkę cenami
            pricesInPLN.forEach((price, hour) => {
                const cell = document.createElement('div');
                cell.className = 'price-cell';
                
                // Kolor na podstawie ceny (zielony = tania, czerwony = droga)
                const ratio = (price - minPrice) / (maxPrice - minPrice);
                const hue = 120 - (ratio * 120); // 120 = zielony, 0 = czerwony
                const saturation = 60 + (ratio * 20); // 60-80%
                const lightness = 85 - (ratio * 25); // 85-60%
                
                cell.style.backgroundColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                
                // Kolor tekstu dla lepszej czytelności
                cell.style.color = lightness < 70 ? 'white' : '#2c3e50';
                
                cell.innerHTML = `
                    <div class="price-hour">${hour}h</div>
                    <div class="price-value">${price.toFixed(4)}</div>
                `;
                
                cell.title = `${hour}:00 - ${price.toFixed(4)} zł/kWh (${(price * 1000 / eurPln).toFixed(2)} €/MWh) - DANE ENTSO-E`;
                
                grid.appendChild(cell);
            });
            
            preview.style.display = 'block';
            
            // Aktualizuj wizualizacje
            renderHourlyTariffs();
        }
        
        function calculateCostsAndUpdate() {
            const monthlyUsage = parseFloat(document.getElementById('monthly-usage').value) || 300;
            const annualUsage = parseFloat(document.getElementById('annual-usage').value) || 3600;
            const installationType = document.getElementById('installation-type').value;
            
            const results = [];
            
            // Oblicz koszty dla każdej taryfy
            Object.entries(tariffs).forEach(([id, tariff]) => {
                const cost = calculateTariffCost(id, monthlyUsage, annualUsage, installationType);
                if (cost !== null) {
                    results.push({
                        id: id,
                        name: tariff.name,
                        totalCost: cost.total,
                        variableCost: cost.variable,
                        fixedCost: cost.fixed
                    });
                }
            });
            
            // Sortuj po kosztach
            results.sort((a, b) => a.totalCost - b.totalCost);
            
            // Aktualizuj podsumowanie
            updateCostSummary(results);
            
            // Aktualizuj wykresy
            createCharts();
        }
        
        function calculateTariffCost(tariffId, monthlyUsage, annualUsage, installationType) {
            const tariff = tariffs[tariffId];
            const installKey = installationType === "1-phase" ? "1-phase" : "3-phase";
            
            // Opłaty stałe
            const fixedNetwork = tariff.fixedMonthly[installKey];
            const fixedSystem = systemCharges.subscription + getTransitionFee(annualUsage) + getPowerFee(annualUsage);
            const totalFixed = fixedNetwork + fixedSystem;
            
            // Opłaty zmienne - używaj profilu odpowiedniego dla kalkulacji
            let variableCost = 0;
            const profileToUse = useWeeklyProfiles ? getAverageWeeklyProfile() : currentProfile;
            
            if (tariff.type === "flat") {
                // G11 - stała stawka
                variableCost = monthlyUsage * tariff.rate;
            } else if (tariff.type === "dynamic" && spotPrices) {
                // G11f - dynamiczna na podstawie cen spot + stały składnik zmienny
                const eurPln = parseFloat(document.getElementById('eur-pln-rate').value);
                const margin = parseFloat(document.getElementById('g11f-margin').value);
                
                let totalDynamicCost = 0;
                for (let hour = 0; hour < 24; hour++) {
                    // Składnik dynamiczny (spot) + stały składnik zmienny + marża
                    const spotPriceInPLN = spotPrices[hour] * eurPln / 1000; // Przelicz €/MWh na zł/kWh
                    const totalHourlyRate = spotPriceInPLN + tariff.baseRate + margin;
                    const hourlyUsage = (monthlyUsage / 30) * (profileToUse[hour] / 100);
                    totalDynamicCost += hourlyUsage * totalHourlyRate;
                }
                variableCost = totalDynamicCost * 30; // Przelicz na miesiąc
            } else {
                // Taryfy strefowe (G12, G12w, G12r)
                let dayUsage = 0;
                let nightUsage = 0;
                
                for (let hour = 0; hour < 24; hour++) {
                    const zone = tariff.zones[hour];
                    const hourlyUsage = (monthlyUsage / 30) * (profileToUse[hour] / 100);
                    
                    if (zone.includes('day') || zone.includes('peak')) {
                        dayUsage += hourlyUsage;
                    } else {
                        nightUsage += hourlyUsage;
                    }
                }
                
                dayUsage *= 30; // Przelicz na miesiąc
                nightUsage *= 30;
                
                const dayRate = tariff.rates.day || tariff.rates.peak;
                const nightRate = tariff.rates.night || tariff.rates.offpeak;
                
                variableCost = (dayUsage * dayRate) + (nightUsage * nightRate);
            }
            
            // Opłaty systemowe zmienne
            const systemVariable = monthlyUsage * (systemCharges.quality + systemCharges.oze + systemCharges.cogeneration);
            
            const totalVariable = variableCost + systemVariable;
            const totalCost = totalFixed + totalVariable;
            
            return {
                total: totalCost,
                fixed: totalFixed,
                variable: totalVariable
            };
        }
        
        function updateCostSummary(results) {
            const container = document.getElementById('cost-summary');
            container.innerHTML = '';
            
            results.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'summary-card' + (index === 0 ? ' best' : '');
                
                const difference = index === 0 ? 'NAJTAŃSZA' : 
                    `+${(result.totalCost - results[0].totalCost).toFixed(2)} zł`;
                const differenceClass = index === 0 ? 'savings' : 'loss';
                
                card.innerHTML = `
                    <div class="summary-value">${result.totalCost.toFixed(2)} zł</div>
                    <div class="summary-label">${result.id}</div>
                    <div class="summary-label">${result.name}</div>
                    <div class="${differenceClass}" style="margin-top: 5px;">${difference}</div>
                `;
                
                container.appendChild(card);
            });
        }
        
        function renderHourlyTariffs() {
            renderTariffHours('g12-hours', tariffs.G12.zones, tariffs.G12.rates);
            renderTariffHours('g12w-hours', tariffs.G12w.zones, tariffs.G12w.rates);
            renderTariffHours('g12r-hours', tariffs.G12r.zones, tariffs.G12r.rates);
            
            // G11f - dynamiczne ceny
            if (spotPrices) {
                const eurPln = parseFloat(document.getElementById('eur-pln-rate').value);
                const margin = parseFloat(document.getElementById('g11f-margin').value);
                const baseRate = tariffs.G11f.baseRate; // Stały składnik zmienny 0.0516 zł/kWh
                
                const dynamicPrices = spotPrices.map(price => {
                    const spotPriceInPLN = price * eurPln / 1000; // €/MWh -> zł/kWh
                    return spotPriceInPLN + baseRate + margin; // spot + stały składnik + marża
                });
                renderDynamicHours('g11f-hours', dynamicPrices);
            }
        }
        
        function renderTariffHours(containerId, zones, rates) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            zones.forEach((zone, hour) => {
                const cell = document.createElement('div');
                cell.className = 'hour-cell';
                cell.textContent = hour;
                
                const rate = rates[zone];
                const color = zone.includes('day') || zone.includes('peak') ? '#e74c3c' : '#27ae60';
                cell.style.backgroundColor = color;
                cell.title = `${hour}:00 - ${zone} (${rate.toFixed(4)} zł/kWh)`;
                
                container.appendChild(cell);
            });
        }
        
        function renderDynamicHours(containerId, prices) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            
            prices.forEach((price, hour) => {
                const cell = document.createElement('div');
                cell.className = 'hour-cell';
                cell.textContent = hour;
                
                // Kolor na podstawie ceny (od zielonego przez żółty do czerwonego)
                const ratio = (price - minPrice) / (maxPrice - minPrice);
                const hue = 120 - (ratio * 120); // 120 = zielony, 0 = czerwony
                cell.style.backgroundColor = `hsl(${hue}, 70%, 50%)`;
                cell.title = `${hour}:00 - ${price.toFixed(4)} zł/kWh (spot + stały składnik + marża)`;
                
                container.appendChild(cell);
            });
        }
        
        function createCharts() {
            const ctx1 = document.getElementById('hourlyRatesChart');
            const ctx2 = document.getElementById('costProfileChart');
            
            // Niszczenie starych wykresów
            if (hourlyChart) hourlyChart.destroy();
            if (costChart) costChart.destroy();
            
            const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
            
            // Wykres stawek godzinowych
            const datasets = [
                {
                    label: 'G11 (stała)',
                    data: new Array(24).fill(tariffs.G11.rate),
                    borderColor: '#3498db',
                    backgroundColor: '#3498db20',
                    borderWidth: 2
                },
                {
                    label: 'G12 (dzień/noc)',
                    data: tariffs.G12.zones.map(zone => tariffs.G12.rates[zone]),
                    borderColor: '#e74c3c',
                    backgroundColor: '#e74c3c20',
                    borderWidth: 2,
                    stepped: true
                },
                {
                    label: 'G12r (szczyt/pozaszczyt)',
                    data: tariffs.G12r.zones.map(zone => tariffs.G12r.rates[zone]),
                    borderColor: '#f39c12',
                    backgroundColor: '#f39c1220',
                    borderWidth: 2,
                    stepped: true
                }
            ];
            
            // Dodaj G11f jeśli są ceny spot
            if (spotPrices) {
                const eurPln = parseFloat(document.getElementById('eur-pln-rate').value);
                const margin = parseFloat(document.getElementById('g11f-margin').value);
                const baseRate = tariffs.G11f.baseRate; // Stały składnik zmienny
                
                const dynamicPrices = spotPrices.map(price => {
                    const spotPriceInPLN = price * eurPln / 1000; // €/MWh -> zł/kWh
                    return spotPriceInPLN + baseRate + margin; // spot + stały składnik + marża
                });
                
                datasets.push({
                    label: 'G11f (dynamiczna)',
                    data: dynamicPrices,
                    borderColor: '#9b59b6',
                    backgroundColor: '#9b59b620',
                    borderWidth: 3
                });
            }
            
            hourlyChart = new Chart(ctx1, {
                type: 'line',
                data: { labels: hours, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Stawka (zł/kWh)' }
                        }
                    }
                }
            });
            
            // Wykres profilu vs koszt
            const profileToShow = useWeeklyProfiles ? getAverageWeeklyProfile() : currentProfile;
            
            costChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Profil zużycia (%)',
                        data: profileToShow,
                        backgroundColor: '#27ae6050',
                        borderColor: '#27ae60',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Zużycie (% dobowego)' }
                        }
                    }
                }
            });
        }
        
        function setUsageProfile(profileName) {
            // Aktualizuj aktywny przycisk
            document.querySelectorAll('.profile-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Ustaw profil
            currentProfile = [...usageProfiles[profileName]];
            
            // Przelicz i aktualizuj
            calculateCostsAndUpdate();
        }
        
        function setupEventListeners() {
            document.getElementById('monthly-usage').addEventListener('input', calculateCostsAndUpdate);
            document.getElementById('annual-usage').addEventListener('input', calculateCostsAndUpdate);
            document.getElementById('installation-type').addEventListener('change', calculateCostsAndUpdate);
            document.getElementById('eur-pln-rate').addEventListener('input', () => {
                updateSpotPricesDisplay();
                calculateCostsAndUpdate();
            });
            document.getElementById('g11f-margin').addEventListener('input', () => {
                renderHourlyTariffs();
                calculateCostsAndUpdate();
            });
            
            // Obsługa zmiany typu analizy
            document.getElementById('analysis-type').addEventListener('change', function() {
                const analysisType = this.value;
                const singleDateGroup = document.getElementById('single-date-group');
                const dateRangeGroup = document.getElementById('date-range-group');
                const dateRangeGroupTo = document.getElementById('date-range-group-to');
                
                // Ukryj/pokaż odpowiednie pola
                if (analysisType === 'date-range') {
                    singleDateGroup.style.display = 'none';
                    dateRangeGroup.style.display = 'flex';
                    dateRangeGroupTo.style.display = 'flex';
                } else {
                    singleDateGroup.style.display = 'flex';
                    dateRangeGroup.style.display = 'none';
                    dateRangeGroupTo.style.display = 'none';
                    
                    // Zaktualizuj etykietę dla różnych typów analiz
                    const label = singleDateGroup.querySelector('label');
                    switch (analysisType) {
                        case 'week-analysis':
                            label.textContent = 'Tydzień zawierający datę:';
                            break;
                        case 'month-analysis':
                            label.textContent = 'Miesiąc zawierający datę:';
                            break;
                        default:
                            label.textContent = 'Data analizy:';
                            break;
                    }
                }
                
                // Auto-fetch jeśli włączone
                if (document.getElementById('auto-fetch').checked) {
                    console.log('🔄 Auto-fetch: zmiana typu analizy');
                    setTimeout(fetchSpotPrices, 500);
                }
            });
            
            // Auto-fetch przy zmianie dat - TYLKO jeśli checkbox jest włączony
            document.getElementById('date-select').addEventListener('change', () => {
                if (document.getElementById('auto-fetch').checked) {
                    console.log('🔄 Auto-fetch: zmiana daty pojedynczej');
                    setTimeout(fetchSpotPrices, 500);
                }
            });
            
            document.getElementById('date-from').addEventListener('change', () => {
                if (document.getElementById('auto-fetch').checked && document.getElementById('date-to').value) {
                    console.log('🔄 Auto-fetch: zmiana daty początkowej');
                    setTimeout(fetchSpotPrices, 500);
                }
            });
            
            document.getElementById('date-to').addEventListener('change', () => {
                if (document.getElementById('auto-fetch').checked && document.getElementById('date-from').value) {
                    console.log('🔄 Auto-fetch: zmiana daty końcowej');
                    setTimeout(fetchSpotPrices, 500);
                }
            });
        }
        
        // === FUNKCJE ZAAWANSOWANYCH PROFILI ===
        
        function toggleAdvanced() {
            const section = document.getElementById('advanced-section');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                initializeAdvancedProfiles();
            } else {
                section.style.display = 'none';
            }
        }
        
        function initializeAdvancedProfiles() {
            // Inicjalizuj edytor godzinowy
            const container = document.getElementById('hour-sliders');
            container.innerHTML = '';
            
            for (let hour = 0; hour < 24; hour++) {
                const sliderDiv = document.createElement('div');
                sliderDiv.className = 'hour-slider';
                sliderDiv.innerHTML = `
                    <div class="hour-label">${hour}h</div>
                    <input type="number" class="hour-input" id="hour-${hour}" 
                           min="0" max="50" step="0.1" value="${currentProfile[hour].toFixed(1)}"
                           onchange="updateHourValue(${hour}, this.value)">
                `;
                container.appendChild(sliderDiv);
            }
        }
        
        function selectDay(day) {
            // Aktualizuj aktywny tab
            document.querySelectorAll('.day-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-day="${day}"]`).classList.add('active');
            
            selectedDay = day;
            
            // Aktualizuj tytuł
            const dayNames = {
                'all': 'Wszystkie dni',
                'monday': 'Poniedziałek',
                'tuesday': 'Wtorek', 
                'wednesday': 'Środa',
                'thursday': 'Czwartek',
                'friday': 'Piątek',
                'saturday': 'Sobota',
                'sunday': 'Niedziela'
            };
            
            document.getElementById('editor-title').textContent = `Edycja profilu: ${dayNames[day]}`;
            
            // Załaduj profil dla wybranego dnia
            const profileToLoad = day === 'all' ? currentProfile : weeklyProfiles[day];
            
            for (let hour = 0; hour < 24; hour++) {
                const input = document.getElementById(`hour-${hour}`);
                if (input) {
                    input.value = profileToLoad[hour].toFixed(1);
                }
            }
        }
        
        function updateHourValue(hour, value) {
            const numValue = parseFloat(value) || 0;
            
            if (selectedDay === 'all') {
                currentProfile[hour] = numValue;
                // Aktualizuj także wszystkie dni tygodnia
                Object.keys(weeklyProfiles).forEach(day => {
                    weeklyProfiles[day][hour] = numValue;
                });
            } else {
                weeklyProfiles[selectedDay][hour] = numValue;
                useWeeklyProfiles = true;
            }
            
            // Przelicz koszty
            calculateCostsAndUpdate();
        }
        
        function applyPreset(presetName) {
            if (!usageProfiles[presetName]) return;
            
            const preset = [...usageProfiles[presetName]];
            
            if (selectedDay === 'all') {
                currentProfile = [...preset];
                // Aktualizuj wszystkie dni
                Object.keys(weeklyProfiles).forEach(day => {
                    weeklyProfiles[day] = [...preset];
                });
                useWeeklyProfiles = false;
            } else {
                weeklyProfiles[selectedDay] = [...preset];
                useWeeklyProfiles = true;
            }
            
            // Aktualizuj UI
            for (let hour = 0; hour < 24; hour++) {
                const input = document.getElementById(`hour-${hour}`);
                if (input) {
                    input.value = preset[hour].toFixed(1);
                }
            }
            
            calculateCostsAndUpdate();
        }
        
        function resetCurrentDay() {
            applyPreset('standard');
        }
        
        function copyToAllDays() {
            if (selectedDay === 'all') return;
            
            const profileToCopy = [...weeklyProfiles[selectedDay]];
            
            Object.keys(weeklyProfiles).forEach(day => {
                weeklyProfiles[day] = [...profileToCopy];
            });
            
            currentProfile = [...profileToCopy];
            
            alert(`Profil z ${selectedDay} skopiowany na wszystkie dni tygodnia.`);
            calculateCostsAndUpdate();
        }
        
        function saveCustomProfile() {
            const profileData = selectedDay === 'all' ? currentProfile : weeklyProfiles[selectedDay];
            const profileName = prompt('Nazwa profilu:', `Mój profil ${selectedDay}`);
            
            if (profileName) {
                // Zapisz w localStorage
                const savedProfiles = JSON.parse(localStorage.getItem('customProfiles') || '{}');
                savedProfiles[profileName] = [...profileData];
                localStorage.setItem('customProfiles', JSON.stringify(savedProfiles));
                
                alert(`Profil "${profileName}" został zapisany!`);
            }
        }
        
        function getAverageWeeklyProfile() {
            // Oblicz średni profil tygodniowy (5 dni roboczych + 2 dni weekend)
            const avgProfile = new Array(24).fill(0);
            
            for (let hour = 0; hour < 24; hour++) {
                let total = 0;
                total += weeklyProfiles.monday[hour] * 1; // Poniedziałek
                total += weeklyProfiles.tuesday[hour] * 1; // Wtorek  
                total += weeklyProfiles.wednesday[hour] * 1; // Środa
                total += weeklyProfiles.thursday[hour] * 1; // Czwartek
                total += weeklyProfiles.friday[hour] * 1; // Piątek
                total += weeklyProfiles.saturday[hour] * 1; // Sobota
                total += weeklyProfiles.sunday[hour] * 1; // Niedziela
                
                avgProfile[hour] = total / 7;
            }
            
            return avgProfile;
        }
    </script>
</body>
</html>
