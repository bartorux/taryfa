<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator taryf energii - rzeczywiste ceny ENTSO-E (v14 - finalna)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Light theme colors */
            --bg-gradient-1: #667eea;
            --bg-gradient-2: #764ba2;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e8f4f8;
            --text-primary: #2c3e50;
            --text-secondary: #666;
            --text-inverse: #ffffff;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --chart-bg: rgba(255, 255, 255, 0.95);
        }
        
        [data-theme="dark"] {
            /* Dark theme colors */
            --bg-gradient-1: #1a1a2e;
            --bg-gradient-2: #16213e;
            --bg-primary: #1e1e2e;
            --bg-secondary: #2a2a3e;
            --bg-tertiary: #35354a;
            --card-bg: #2a2a3e;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-inverse: #1e1e2e;
            --border: #555577;
            --border-color: #555577;
            --shadow-color: rgba(0, 0, 0, 0.7);
            --glass-bg: rgba(30, 30, 46, 0.8);
            --glass-border: rgba(255, 255, 255, 0.15);
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #5dade2;
            --primary: #3498db;
            --secondary: #44475a;
            --chart-bg: rgba(30, 30, 46, 0.95);
        }
        
        /* Poprawki dla trybu ciemnego */
        [data-theme="dark"] .summary-card {
            background: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border) !important;
        }
        
        [data-theme="dark"] .glass-card {
            background: var(--glass-bg) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .controls-section h3,
        [data-theme="dark"] .summary-section h3,
        [data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3, [data-theme="dark"] h4 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] input, [data-theme="dark"] select, [data-theme="dark"] button {
            background: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border) !important;
        }
        
        [data-theme="dark"] label {
            color: var(--text-primary) !important;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        /* Theme toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px var(--shadow-color);
        }
        
        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px var(--shadow-color);
        }
        
        .theme-toggle-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
        }
        
        .theme-toggle:hover .theme-toggle-icon {
            transform: rotate(180deg);
        }
        
        /* Glassmorphism container */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 8px 32px var(--shadow-color);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px var(--shadow-color);
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }
        
        h1 {
            text-align: center;
            color: var(--text-inverse);
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: fadeInDown 0.8s ease;
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-inverse);
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.9;
            animation: fadeInUp 0.8s ease 0.2s backwards;
        }
        
        /* Season toggle */
        .season-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease 0.4s backwards;
        }
        
        .season-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 25px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        .season-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow-color);
        }
        
        .season-btn.active {
            background: var(--info);
            color: white;
        }
        
        /* API Status */
        .api-status {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-primary);
            animation: slideIn 0.6s ease 0.6s backwards;
            transition: all 0.3s ease;
        }
        
        .api-status.loading {
            background: rgba(255, 243, 205, 0.8);
            border-color: rgba(255, 234, 167, 0.5);
            color: #856404;
        }
        
        .api-status.error {
            background: rgba(248, 215, 218, 0.8);
            border-color: rgba(245, 198, 203, 0.5);
            color: #721c24;
        }
        
        /* Controls section */
        .controls-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: fadeIn 0.8s ease 0.8s backwards;
            transition: all 0.3s ease;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            animation: fadeInUp 0.6s ease;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        input, select, textarea {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--info);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }
        
        /* Date range controls visibility fix */
        #date-range-group,
        #date-range-group-to {
            transition: all 0.3s ease;
        }
        
        /* Profile section */
        .profile-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            animation: fadeIn 0.6s ease;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .profile-btn {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }
        
        .profile-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--info);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }
        
        .profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .profile-btn.active {
            background: var(--info);
            color: white;
            border-color: var(--info);
        }
        
        /* Buttons */
        .fetch-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .fetch-btn:hover:not(:disabled) {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .fetch-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Charts section */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            background: var(--chart-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: scaleIn 0.8s ease;
            transition: all 0.3s ease;
        }
        
        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px var(--shadow-color);
        }
        
        .chart-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        .chart-wrapper {
            position: relative;
            height: 350px;
        }
        
        /* Summary section */
        .summary-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: fadeInUp 0.8s ease;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .summary-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .summary-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s ease;
        }
        
        .summary-card:hover::before {
            animation: shimmer 0.5s ease;
        }
        
        .summary-card.best {
            background: linear-gradient(135deg, var(--success), #27ae60);
            color: white;
            box-shadow: 0 5px 20px rgba(39, 174, 96, 0.3);
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            animation: countUp 1s ease;
        }
        
        .summary-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Price preview */
        .price-preview {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            animation: fadeIn 0.6s ease;
        }
        
        .prices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }
        
        .price-cell {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .price-cell:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .price-hour {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .price-value {
            font-weight: 600;
        }
        
        /* Hourly analysis */
        .hourly-analysis {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px var(--shadow-color);
            grid-column: 1 / -1;
            animation: fadeInUp 0.8s ease;
        }
        
        .hour-grid {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin-top: 15px;
        }
        
        .hour-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .hour-cell:hover {
            transform: scale(1.2);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* Tarcza toggle */
        .shield-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }
        
        .shield-toggle label {
            margin: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .shield-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* Daily costs section */
        .daily-costs-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px var(--shadow-color);
        }
        
        .daily-costs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .day-cost-card {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .day-cost-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .day-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-primary);
        }
        
        .day-cost {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--info);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }
        
        @keyframes countUp {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .hour-grid {
                grid-template-columns: repeat(12, 1fr);
            }
            
            .theme-toggle {
                top: 10px;
                right: 10px;
            }
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            text-align: center;
            border-radius: 6px;
            border: 1px solid var(--border);
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Seasonal profiles */
        .seasonal-info {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85rem;
            text-align: center;
            color: var(--text-secondary);
        }
        
        /* Advanced section improvements */
        #advanced-section {
            margin-top: 20px;
            animation: fadeIn 0.6s ease;
        }
        
        .profile-editor {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
        }
        
        /* New profile editor styles */
        .profile-visualizer {
            margin-bottom: 20px;
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }
        
        .hour-sliders-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .hour-slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .hour-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--text-secondary);
        }
        
        .hour-slider {
            width: 100%;
            height: 80px;
            writing-mode: bt-lr; /* IE */
            writing-mode: vertical-lr; /* Firefox */
            -webkit-appearance: slider-vertical; /* WebKit */
            background: linear-gradient(to top, #27ae60, #f39c12, #e74c3c);
            border-radius: 5px;
            outline: none;
        }
        
        .hour-input-small {
            width: 50px;
            padding: 3px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            text-align: center;
            font-size: 0.7rem;
        }
        
        .hour-percentage {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .hour-sliders-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 10px;
            }
            
            .hour-slider {
                height: 60px;
            }
        }
        
        /* Profile manager styles */
        .profiles-manager {
            margin-top: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }
        
        .saved-profiles-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .saved-profile-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .profile-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .profile-actions {
            display: flex;
            gap: 5px;
        }
        
        .profile-actions button {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        /* Profile comparison styles */
        .comparison-results {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .comparison-table th {
            background: var(--bg-secondary);
            font-weight: bold;
        }
        
        .savings-positive {
            color: var(--success);
            font-weight: bold;
        }
        
        .savings-negative {
            color: var(--danger);
            font-weight: bold;
        }
        
        /* Dual profile styles */
        .dual-profile-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        
        .profile-column {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .profile-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .profile-select:focus {
            outline: none;
            border-color: var(--info);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        @media (max-width: 768px) {
            .dual-profile-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        /* Dual profile summary styles */
        .dual-profile-card {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        }
        
        .dual-comparison {
            text-align: center;
        }
        
        .tariff-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .cost-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .cost-a, .cost-b {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .savings-indicator {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            background: var(--bg-tertiary);
        }
        
        .day-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .day-tab {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .day-tab:hover {
            border-color: var(--info);
            transform: translateY(-2px);
            box-shadow: 0 3px 10px var(--shadow-color);
        }
        
        .day-tab.active {
            background: var(--info);
            color: white;
            border-color: var(--info);
        }
        
        /* Legend improvements */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            background: var(--bg-secondary);
            padding: 5px 15px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .legend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px var(--shadow-color);
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <span class="theme-toggle-icon">🌙</span>
        <span class="theme-text">Tryb ciemny</span>
    </button>
    
    <div class="container">
        <h1>⚡ Kalkulator Taryf Energii Elektrycznej</h1>
        <div class="subtitle">Porównanie wszystkich taryf Energa-Operator + rzeczywiste ceny spot ENTSO-E</div>
        
        <!-- Season Toggle -->
        <div class="season-toggle">
            <button class="season-btn active" onclick="setSeason('all', this)">📅 Cały rok</button>
            <button class="season-btn" onclick="setSeason('summer', this)">☀️ Lato</button>
            <button class="season-btn" onclick="setSeason('winter', this)">❄️ Zima</button>
        </div>
        
        <div class="api-status glass-card" id="api-status">
            <strong>🔌 API ENTSO-E:</strong> Rzeczywiste ceny energii z ENTSO-E Transparency Platform<br>
            <small>💡 <strong>Ważne:</strong> ENTSO-E ma dane tylko z przeszłości (maksymalnie do wczoraj)</small>
        </div>
        
        <!-- Sekcja ENTSO-E API -->
        <div class="controls-section glass-card">
            <h3>🌍 Rzeczywiste ceny energii (ENTSO-E Transparency Platform)</h3>
            <div class="controls-grid">
                <div class="input-group">
                    <label for="analysis-type">
                        Typ analizy:
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">Wybierz sposób analizy cen energii</span>
                        </span>
                    </label>
                    <select id="analysis-type">
                        <option value="single-day">Pojedynczy dzień</option>
                        <option value="date-range">Zakres dat</option>
                        <option value="week-analysis">Analiza tygodniowa</option>
                        <option value="month-analysis">Analiza miesięczna</option>
                    </select>
                </div>
                <div class="input-group" id="single-date-group">
                    <label for="date-select">Data analizy:</label>
                    <input type="date" id="date-select" value="">
                </div>
                <div class="input-group" id="date-range-group" style="display: none;">
                    <label for="date-from">Od:</label>
                    <input type="date" id="date-from" value="">
                </div>
                <div class="input-group" id="date-range-group-to" style="display: none;">
                    <label for="date-to">Do:</label>
                    <input type="date" id="date-to" value="">
                </div>
                <div class="input-group">
                    <label for="eur-pln-rate">
                        Kurs EUR/PLN:
                        <span class="tooltip">✏️
                            <span class="tooltiptext">Możesz edytować ręcznie</span>
                        </span>
                    </label>
                    <input type="number" id="eur-pln-rate" value="4.30" step="0.01" min="3" max="6">
                    <small style="display: block; margin-top: 5px; color: var(--success); font-size: 0.8rem;">
                        💱 Kurs aktualizuje się automatycznie przy ładowaniu strony
                    </small>
                </div>
                <div class="input-group">
                    <label for="g11f-margin">
                        Dodatkowa marża G11f (zł/kWh):
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">Marża dodawana do ceny spot przez sprzedawcę</span>
                        </span>
                    </label>
                    <input type="number" id="g11f-margin" value="0.05" step="0.001" min="0" max="0.2">
                </div>
                <div class="input-group">
                    <label>&nbsp;</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="fetch-btn" onclick="handleFetchSpotPrices()" style="flex: 1;">
                            📊 Pobierz ceny spot
                        </button>
                        <label class="auto-fetch" style="font-size: 0.9rem;">
                            <input type="checkbox" id="auto-fetch" checked> Auto-odświeżanie
                        </label>
                    </div>
                </div>
            </div>
            <div class="price-preview" id="price-preview" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>📊 Ceny spot dla Polski:</strong>
                    <div id="price-stats" style="font-size: 0.9rem;"></div>
                </div>
                <div class="prices-grid" id="spot-prices-grid"></div>
                <div class="currency-info" id="currency-info" style="margin-top: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 10px;"></div>
            </div>
        </div>
        
        <!-- Kontrolki podstawowe -->
        <div class="controls-section glass-card">
            <h3>⚙️ Parametry gospodarstwa</h3>
            
            <!-- Tarcza toggle -->
            <div class="shield-toggle">
                <label>
                    <input type="checkbox" id="shield-toggle" checked onchange="toggleShield()">
                    <strong>🛡️ Tarcza rządowa:</strong> Uwzględnij tymczasowe stawki obowiązujące w 2025 r.
                </label>
                <small style="margin-left: 10px; color: var(--text-secondary);">
                    (bez VAT, zgodnie z ustawą o środkach nadzwyczajnych)
                </small>
            </div>
            
            <div class="controls-grid">
                <div class="input-group">
                    <label for="monthly-usage">Miesięczne zużycie (kWh):</label>
                    <input type="number" id="monthly-usage" value="300" min="0" step="10">
                </div>
                <div class="input-group">
                    <label for="annual-usage">Roczne zużycie (kWh):</label>
                    <input type="number" id="annual-usage" value="3600" min="0" step="100">
                </div>
                <div class="input-group">
                    <label for="installation-type">Typ instalacji:</label>
                    <select id="installation-type">
                        <option value="1-phase">1-fazowa</option>
                        <option value="3-phase" selected>3-fazowa</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>&nbsp;</label>
                    <button class="fetch-btn" onclick="toggleAdvanced()" style="background: var(--text-primary);">
                        ⚙️ Zaawansowane profile
                    </button>
                </div>
            </div>
            
            <div class="profile-section">
                <h4>📈 Profile zużycia energii - Porównanie</h4>
                <div class="seasonal-info" id="seasonal-info" style="display: none;">
                    Profil dostosowany do sezonu: <strong id="current-season">Cały rok</strong>
                </div>
                
                <div class="dual-profile-container">
                    <div class="profile-column">
                        <h5 style="color: var(--success); margin-bottom: 10px;">📊 Profil A (główny)</h5>
                        <select id="main-profile-select" class="profile-select" onchange="setMainProfile(this.value)">
                            <option value="standard">🏠 Standard - Równomierne</option>
                            <option value="morning">🌅 Poranny - Pik 6-9, 17-21</option>
                            <option value="evening">🌆 Wieczorny - Pik 18-23</option>
                            <option value="night">🌙 Nocny - Pik 22-6</option>
                            <option value="flexible">🔄 Elastyczny G12</option>
                            <option value="flexibleW">🔄 Elastyczny G12w</option>
                            <option value="homeoffice">💻 Home Office</option>
                            <option value="ev_charging">⚡ Ładowanie EV</option>
                            <option value="heat_pump">🔥 Pompa ciepła</option>
                        </select>
                    </div>
                    
                    <div class="profile-column">
                        <h5 style="color: var(--info); margin-bottom: 10px;">📈 Profil B (porównanie)</h5>
                        <select id="comparison-profile-select" class="profile-select" onchange="setComparisonProfile(this.value)">
                            <option value="">-- Wybierz do porównania --</option>
                            <option value="standard">🏠 Standard - Równomierne</option>
                            <option value="morning">🌅 Poranny - Pik 6-9, 17-21</option>
                            <option value="evening">🌆 Wieczorny - Pik 18-23</option>
                            <option value="night">🌙 Nocny - Pik 22-6</option>
                            <option value="flexible">🔄 Elastyczny G12</option>
                            <option value="flexibleW">🔄 Elastyczny G12w</option>
                            <option value="homeoffice">💻 Home Office</option>
                            <option value="ev_charging">⚡ Ładowanie EV</option>
                            <option value="heat_pump">🔥 Pompa ciepła</option>
                        </select>
                        <div style="margin-top: 8px;">
                            <input type="checkbox" id="enable-comparison" onchange="toggleDualProfileMode()" />
                            <label for="enable-comparison" style="margin-left: 5px; font-size: 0.9rem;">Włącz porównanie</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Podsumowanie kosztów miesięcznych -->
        <div class="summary-section glass-card">
            <h3>💰 Porównanie miesięcznych kosztów</h3>
            <div class="summary-grid" id="cost-summary">
                <!-- Wypełniane dynamicznie -->
            </div>
        </div>
        
        <!-- Podsumowanie kosztów dobowych -->
        <div class="daily-costs-section glass-card">
            <h3>📅 Średnie koszty dobowe</h3>
            <div class="daily-costs-grid" id="daily-cost-summary">
                <!-- Wypełniane dynamicznie -->
            </div>
        </div>
        
        <!-- Wykresy -->
        <div class="charts-section">
            <div class="chart-container glass-card">
                <div class="chart-title">Stawki w ciągu doby (dzień roboczy)</div>
                <div class="chart-wrapper">
                    <canvas id="hourlyRatesChart"></canvas>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 10px; font-size: 0.85rem; text-align: center;">
                    <strong>ℹ️ Uwaga:</strong> Wykres pokazuje całkowite koszty zmienne energii (dystrybucja + wszystkie opłaty zmienne).<br>
                    Opłata mocowa (0,1412 zł/kWh) jest doliczana tylko w godzinach 7-21 w dni robocze.<br>
                    <strong>📅 G12w:</strong> W weekendy cała doba jest rozliczana według taryfy nocnej (tańszej).<br>
                    <small>Koszty stałe (abonament, składnik stały, opłata przejściowa) są rozliczane miesięcznie i nie są pokazane na wykresie godzinowym.</small>
                </div>
            </div>
            
            <div class="chart-container glass-card">
                <div class="chart-title">Profil zużycia vs ceny</div>
                <div class="chart-wrapper">
                    <canvas id="costProfileChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Analiza godzinowa -->
        <div class="hourly-analysis glass-card">
            <div class="chart-title">🕐 Analiza godzinowa taryf</div>
            
            <h4>G11f - Dynamiczna (ceny spot + stały składnik 0,0516 zł/kWh + marża)</h4>
            <div class="hour-label" style="text-align: center; color: var(--text-secondary); margin-bottom: 5px;">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g11f-hours"></div>
            
            <h4 style="margin-top: 20px;">G12 - Dzień/Noc</h4>
            <div class="hour-label" style="text-align: center; color: var(--text-secondary); margin-bottom: 5px;">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g12-hours"></div>
            
            <h4 style="margin-top: 20px;">G12w - Weekendowa (+ całe weekendy w taryfie nocnej)</h4>
            <div style="text-align: center; color: var(--info); margin-bottom: 5px; font-size: 0.9rem;">
                📅 W soboty i niedziele cała doba jest rozliczana według taryfy nocnej!
            </div>
            <div class="hour-label" style="text-align: center; color: var(--text-secondary); margin-bottom: 5px;">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g12w-hours"></div>
            
            <h4 style="margin-top: 20px;">G12r - Szczyt/Pozaszczyt</h4>
            <div class="hour-label" style="text-align: center; color: var(--text-secondary); margin-bottom: 5px;">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g12r-hours"></div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--danger);"></div>
                    <span>Drożej (dzień/szczyt)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--success);"></div>
                    <span>Taniej (noc/pozaszczyt)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, var(--success), var(--warning), var(--danger));"></div>
                    <span>Dynamiczna (zielony=tanie, czerwony=drogie)</span>
                </div>
            </div>
        </div>
        
        <!-- Sekcja zaawansowana -->
        <div class="controls-section glass-card" id="advanced-section" style="display: none;">
            <h3>🔧 Zaawansowane profile zużycia</h3>
            <p style="margin-bottom: 20px; color: var(--text-secondary);">
                Ustaw różne profile zużycia dla poszczególnych dni tygodnia. 
                Przydatne np. dla ładowania auta elektrycznego tylko w określone dni.
            </p>
            
            <div class="profile-editor">
                <div class="day-tabs">
                    <button class="day-tab active" onclick="selectDay('all')" data-day="all">Wszystkie dni</button>
                    <button class="day-tab" onclick="selectDay('monday')" data-day="monday">Poniedziałek</button>
                    <button class="day-tab" onclick="selectDay('tuesday')" data-day="tuesday">Wtorek</button>
                    <button class="day-tab" onclick="selectDay('wednesday')" data-day="wednesday">Środa</button>
                    <button class="day-tab" onclick="selectDay('thursday')" data-day="thursday">Czwartek</button>
                    <button class="day-tab" onclick="selectDay('friday')" data-day="friday">Piątek</button>
                    <button class="day-tab" onclick="selectDay('saturday')" data-day="saturday">Sobota</button>
                    <button class="day-tab" onclick="selectDay('sunday')" data-day="sunday">Niedziela</button>
                </div>
                
                <div class="profile-controls" style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                    <div class="profile-presets">
                        <h4 style="margin-bottom: 10px;">Gotowe wzorce:</h4>
                        <div class="preset-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('standard')">🏠 Standard</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('morning')">🌅 Poranny</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('evening')">🌆 Wieczorny</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('night')">🌙 Nocny</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('ev_charging')">⚡ Ładowanie EV</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('heat_pump')">🔥 Pompa ciepła</button>
                        </div>
                    </div>
                    
                    <div class="hourly-editor">
                        <h4 id="editor-title">Edycja profilu: Wszystkie dni</h4>
                        <div class="hour-sliders" id="hour-sliders" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 10px; margin: 20px 0;">
                            <!-- Wypełniane dynamicznie -->
                        </div>
                        <div class="editor-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="fetch-btn" style="background: var(--warning);" onclick="resetCurrentDay()">🔄 Reset dnia</button>
                            <button class="fetch-btn" style="background: #9b59b6;" onclick="copyToAllDays()">📋 Kopiuj na wszystkie dni</button>
                            <button class="fetch-btn" onclick="saveCustomProfile()">💾 Zapisz profil</button>
                            <button class="fetch-btn" onclick="toggleProfilesManager()">📚 Zarządzaj profilami</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="toggleProfileComparison()">⚖️ Porównaj profile</button>
                        </div>
                        
                        <!-- Sekcja zarządzania profilami -->
                        <div id="profiles-manager" class="profiles-manager" style="display: none;">
                            <h4 style="margin: 20px 0 15px 0;">📚 Zapisane profile zużycia</h4>
                            <div id="saved-profiles-list" class="saved-profiles-list">
                                <!-- Wypełniane dynamicznie -->
                            </div>
                        </div>
                        
                        <!-- Sekcja porównania profili -->
                        <div id="profile-comparison" class="profiles-manager" style="display: none;">
                            <h4 style="margin: 20px 0 15px 0;">⚖️ Porównanie profili zużycia</h4>
                            <div class="comparison-controls" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div class="comparison-profile">
                                    <label><strong>Profil A (obecny):</strong></label>
                                    <select id="profile-a-select" style="width: 100%; padding: 8px; margin-top: 5px;">
                                        <option value="current">Aktualny profil</option>
                                    </select>
                                </div>
                                <div class="comparison-profile">
                                    <label><strong>Profil B (do porównania):</strong></label>
                                    <select id="profile-b-select" style="width: 100%; padding: 8px; margin-top: 5px;" onchange="setComparisonProfile(this.value)">
                                        <option value="">Wybierz profil...</option>
                                    </select>
                                </div>
                            </div>
                            <button onclick="compareProfiles()" class="fetch-btn" style="width: 100%; margin-bottom: 20px;">📊 Porównaj koszty</button>
                            <div id="comparison-results" class="comparison-results">
                                <!-- Wypełniane dynamicznie -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Twój token ENTSO-E (będzie używany automatycznie)
        const ENTSO_API_TOKEN = '74e2281c-6281-46b5-8805-7d5b3dc7389b';
        const POLAND_DOMAIN = '10YPL-AREA-----S';
        
        // Theme management
        let currentTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        updateThemeToggle();
        
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeToggle();
            
            // Update charts if they exist
            if (hourlyChart) {
                updateChartTheme(hourlyChart);
            }
            if (costChart) {
                updateChartTheme(costChart);
            }
        }
        
        function updateThemeToggle() {
            const toggle = document.querySelector('.theme-toggle');
            const icon = toggle.querySelector('.theme-toggle-icon');
            const text = toggle.querySelector('.theme-text');
            
            if (currentTheme === 'dark') {
                icon.textContent = '☀️';
                text.textContent = 'Tryb jasny';
            } else {
                icon.textContent = '🌙';
                text.textContent = 'Tryb ciemny';
            }
        }
        
        function updateChartTheme(chart) {
            if (!chart || !chart.options || !chart.options.scales) return;
            
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary');
            const gridColor = getComputedStyle(document.body).getPropertyValue('--border-color');
            
            if (chart.options.scales.x) {
                if (chart.options.scales.x.ticks) chart.options.scales.x.ticks.color = textColor;
                if (chart.options.scales.x.grid) chart.options.scales.x.grid.color = gridColor;
            }
            if (chart.options.scales.y) {
                if (chart.options.scales.y.ticks) chart.options.scales.y.ticks.color = textColor;
                if (chart.options.scales.y.grid) chart.options.scales.y.grid.color = gridColor;
            }
            if (chart.options.plugins && chart.options.plugins.legend && chart.options.plugins.legend.labels) {
                chart.options.plugins.legend.labels.color = textColor;
            }
            
            chart.update();
        }
        
        // Season management
        let currentSeason = 'all';
        
        function setSeason(season, element) {
            currentSeason = season;
            
            // Update buttons
            document.querySelectorAll('.season-btn').forEach(btn => btn.classList.remove('active'));
            if (element) element.classList.add('active');
            
            // Update seasonal info
            const seasonalInfo = document.getElementById('seasonal-info');
            const currentSeasonText = document.getElementById('current-season');
            
            if (seasonalInfo && currentSeasonText) {
                if (season !== 'all') {
                    seasonalInfo.style.display = 'block';
                    currentSeasonText.textContent = season === 'summer' ? 'Lato' : 'Zima';
                } else {
                    seasonalInfo.style.display = 'none';
                }
            }
            
            // Apply seasonal adjustments to profiles
            applySeasonalAdjustments();
            calculateCostsAndUpdate();
        }
        
        function applySeasonalAdjustments() {
            try {
                if (!currentProfile || currentProfile.length === 0) {
                    currentProfile = [...usageProfiles.standard];
                }
                
                // Stwórz kopię profilu do modyfikacji
                let adjustedProfile = [...currentProfile];
                
                // Adjust profiles based on season
                if (currentSeason === 'summer') {
                    // Summer adjustments - less heating, more cooling
                    adjustedProfile = adjustedProfile.map((value, hour) => {
                        if (hour >= 12 && hour <= 16) {
                            return value * 1.2; // More AC usage during hot hours
                        } else if (hour >= 22 || hour <= 5) {
                            return value * 0.8; // Less night usage (no heating)
                        }
                        return value;
                    });
                } else if (currentSeason === 'winter') {
                    // Winter adjustments - more heating, longer lighting
                    adjustedProfile = adjustedProfile.map((value, hour) => {
                        if ((hour >= 6 && hour <= 8) || (hour >= 17 && hour <= 22)) {
                            return value * 1.3; // More heating and lighting
                        } else if (hour >= 10 && hour <= 15) {
                            return value * 0.9; // Less usage during warmer day hours
                        }
                        return value;
                    });
                }
                
                // Normalize to 100%
                const sum = adjustedProfile.reduce((a, b) => a + b, 0);
                if (sum > 0) {
                    currentProfile = adjustedProfile.map(v => (v / sum) * 100);
                }
            } catch (error) {
                console.error('Błąd podczas dostosowywania profilu sezonowego:', error);
            }
        }
        
        // Shield toggle
        let useShield = true;
        
        function toggleShield() {
            useShield = document.getElementById('shield-toggle').checked;
            calculateCostsAndUpdate();
        }
        
        // Definicje taryf z Energa Operator
        const tariffs = {
            G11: {
                name: "G11 - Jednostrefowa",
                rate: 0.3437, // bez tarczy
                rateShield: 0.30, // z tarczą (obniżone)
                fixedMonthly: { "1-phase": 7.68, "3-phase": 11.54 },
                type: "flat"
            },
            G11f: {
                name: "G11f - Dynamiczna", 
                baseRate: 0.0516, // Stały składnik zmienny stawki sieciowej
                fixedMonthly: { "1-phase": 38.69, "3-phase": 54.37 }, // Stały składnik stawki sieciowej
                type: "dynamic"
            },
            G12: {
                name: "G12 - Dzień/Noc",
                rates: { 
                    day: 0.3791, 
                    night: 0.0816,
                    dayShield: 0.32, // obniżone z tarczą
                    nightShield: 0.07 // obniżone z tarczą
                },
                zones: [
                    // dzień: 6-13, 15-22; noc: 13-15, 22-6
                    'night','night','night','night','night','night', // 0-5
                    'day','day','day','day','day','day','day', // 6-12
                    'night','night', // 13-14
                    'day','day','day','day','day','day','day', // 15-21
                    'night','night' // 22-23
                ],
                fixedMonthly: { "1-phase": 14.07, "3-phase": 19.77 }
            },
            G12w: {
                name: "G12w - Weekendowa",
                rates: { 
                    day: 0.3960, 
                    night: 0.0838,
                    dayShield: 0.33, // obniżone z tarczą
                    nightShield: 0.07 // obniżone z tarczą
                },
                zones: [
                    'night','night','night','night','night','night',
                    'day','day','day','day','day','day','day',
                    'night','night',
                    'day','day','day','day','day','day','day',
                    'night','night'
                ],
                weekendAllNight: true,
                fixedMonthly: { "1-phase": 14.07, "3-phase": 19.77 }
            },
            G12r: {
                name: "G12r - Szczyt/Pozaszczyt", 
                rates: { 
                    peak: 0.3590, 
                    offpeak: 0.0870,
                    peakShield: 0.31, // obniżone z tarczą
                    offpeakShield: 0.07 // obniżone z tarczą
                },
                zones: [
                    // szczyt: 7-13, 16-22; pozaszczyt: 13-16, 22-7
                    'offpeak','offpeak','offpeak','offpeak','offpeak','offpeak','offpeak', // 0-6
                    'peak','peak','peak','peak','peak','peak', // 7-12
                    'offpeak','offpeak','offpeak', // 13-15
                    'peak','peak','peak','peak','peak','peak', // 16-21
                    'offpeak','offpeak' // 22-23
                ],
                fixedMonthly: { "1-phase": 14.07, "3-phase": 19.77 }
            }
        };
        
        // Systemowe opłaty
        const systemCharges = {
            subscription: 4.56,
            quality: 0.0321,
            oze: 0.0035,      // 3.50 zł/MWh = 0.0035 zł/kWh
            cogeneration: 0.003,  // 3.00 zł/MWh = 0.003 zł/kWh
        };
        
        function getTransitionFee(annualUsage) {
            if (annualUsage < 500) return 0.02;
            if (annualUsage <= 1200) return 0.10;
            return 0.33;
        }
        
        function getPowerFee(annualUsage) {
            if (annualUsage < 500) return 2.86;
            if (annualUsage <= 1200) return 6.86;
            if (annualUsage <= 2800) return 11.44;
            return 16.01;
        }
        
        // Profile zużycia (% dla każdej godziny doby)
        const usageProfiles = {
            standard: new Array(24).fill(100/24), // równomierne
            morning: [2,2,2,2,2,8,12,12,8,4,4,4,4,4,4,4,8,12,12,8,6,4,3,2], // poranki + wieczory
            evening: [2,2,2,2,2,3,6,8,4,3,3,3,3,3,3,3,4,6,12,15,15,8,4,2], // wieczorny pik
            night: [8,8,8,6,4,2,2,2,2,2,2,2,2,2,2,2,2,3,4,6,8,12,15,15], // nocny
            flexible: [8,8,8,8,6,4,2,2,2,2,2,2,8,8,4,2,2,2,2,2,4,6,8,8], // dostosowany do G12
            flexibleW: [10,10,10,8,6,4,2,2,2,2,2,2,8,8,2,2,2,2,2,2,2,4,8,10], // dostosowany do G12w (więcej w weekendy)
            homeoffice: [3,2,2,2,2,4,6,8,10,8,6,6,6,8,8,6,6,4,3,2,2,2,2,2], // home office
            ev_charging: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,50,50,0], // ładowanie EV 21-23h
            heat_pump: [6,6,6,6,6,8,4,2,2,2,2,2,2,2,2,2,2,4,6,8,8,8,8,6] // pompa ciepła
        };
        
        let currentProfile = [...usageProfiles.standard];
        let comparisonProfile = null; // Profil do porównania
        let isDualProfileMode = false; // Czy włączony tryb porównania
        let weeklyProfiles = {
            monday: [...usageProfiles.standard],
            tuesday: [...usageProfiles.standard],
            wednesday: [...usageProfiles.standard],
            thursday: [...usageProfiles.standard],
            friday: [...usageProfiles.standard],
            saturday: [...usageProfiles.standard],
            sunday: [...usageProfiles.standard]
        };
        let selectedDay = 'all';
        let useWeeklyProfiles = false;
        let spotPrices = null;
        let spotPricesRange = []; // Dla zakresów dat
        let hourlyChart = null;
        let costChart = null;
        let currentExchangeRate = 4.30;
        
        // Inicjalizuj currentProfile jeśli jest pusty
        if (!currentProfile || currentProfile.length === 0) {
            currentProfile = new Array(24).fill(100/24);
        }
        
        // Zabezpieczenie przed błędami
        window.addEventListener('error', function(e) {
            console.error('Błąd aplikacji:', e.message, e.filename, e.lineno, e.colno);
            return true;
        });
        
        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Aplikacja startuje...');
            
            // Inicjalizuj wykresy z pustymi danymi
            setTimeout(() => {
                console.log('🎯 Inicjalizacja początkowych wykresów...');
                createCharts();
                // Uruchom obliczenia kosztów
                calculateCostsAndUpdate();
                // Załaduj profile do porównania
                updateComparisonProfiles();
                console.log('🔄 Profile comparison loaded');
                
                // Pobierz aktualny kurs EUR automatycznie
                setTimeout(() => {
                    fetchEuroRate().catch(error => {
                        console.warn('Nie udało się pobrać kursu EUR automatycznie:', error);
                    });
                }, 1000);
            }, 500);
            
            try {
                // Ustaw bezpieczną datę (ENTSO-E ma opóźnienie ~1-2 dni)
                const yesterday = new Date(Date.now() - 2 * 86400000).toISOString().split('T')[0]; // 2 dni temu dla pewności
                const weekAgo = new Date(Date.now() - 9 * 86400000).toISOString().split('T')[0]; // 9 dni temu
                
                // Ustaw maksymalną datę na wczoraj dla wszystkich pól dat
                const dateSelect = document.getElementById('date-select');
                if (dateSelect) {
                    dateSelect.value = yesterday;
                    dateSelect.max = yesterday;
                }
                
                const dateFrom = document.getElementById('date-from');
                if (dateFrom) {
                    dateFrom.value = weekAgo;
                    dateFrom.max = yesterday;
                }
                
                const dateTo = document.getElementById('date-to');
                if (dateTo) {
                    dateTo.value = yesterday;
                    dateTo.max = yesterday;
                }
                
                // Ustaw domyślny kurs
                currentExchangeRate = 4.30;
                const eurInput = document.getElementById('eur-pln-rate');
                if (eurInput) {
                    eurInput.value = currentExchangeRate.toFixed(4);
                }
                
                // Event listenery
                setupEventListeners();
                
                // Wstępne obliczenia bez cen spot (używa standardowych taryf)
                setTimeout(() => {
                    calculateCostsAndUpdate();
                    console.log('✅ Aplikacja uruchomiona pomyślnie');
                }, 100);
                
            } catch (error) {
                console.error('❌ Błąd podczas inicjalizacji:', error);
            }
        });
        
        function fetchExchangeRate() {
            const eurInput = document.getElementById('eur-pln-rate');
            if (eurInput) {
                const newRate = parseFloat(eurInput.value);
                if (!isNaN(newRate) && newRate > 0) {
                    currentExchangeRate = newRate;
                    console.log(`📊 Zaktualizowano kurs EUR/PLN: ${currentExchangeRate.toFixed(4)}`);
                    
                    // Aktualizuj wyświetlanie jeśli są już ceny
                    if (spotPrices && spotPrices.length > 0) {
                        updateSpotPricesDisplay();
                        calculateCostsAndUpdate();
                    }
                    
                    // Wyświetl info o kursie
                    const currencyInfo = document.getElementById('currency-info');
                    if (currencyInfo) {
                        currencyInfo.innerHTML = `
                            💱 <span style="font-weight: bold;">Kurs EUR/PLN: ${currentExchangeRate.toFixed(4)}</span>
                            <span style="margin-left: 20px;">📡 Źródło: Wprowadzono ręcznie</span>
                            <span style="margin-left: 20px;">✅ Zaktualizowano</span>
                        `;
                    }
                } else {
                    alert('Wprowadź poprawną wartość kursu EUR/PLN');
                }
            }
        }
        
        async function updateExchangeRate() {
            try {
                // Spróbuj kilka źródeł kursu EUR/PLN
                let rate = null;
                let source = '';
                
                console.log('🔄 Pobieranie kursu EUR/PLN...');
                
                // 1. Spróbuj NBP API przez CORS proxy
                try {
                    const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://api.nbp.pl/api/exchangerates/rates/a/eur/?format=json'));
                    if (response.ok) {
                        const data = await response.json();
                        if (data.contents) {
                            const nbpData = JSON.parse(data.contents);
                            if (nbpData && nbpData.rates && nbpData.rates.length > 0) {
                                rate = nbpData.rates[0].mid;
                                source = `NBP (${nbpData.rates[0].effectiveDate})`;
                                console.log('✅ NBP API działa:', rate);
                            }
                        }
                    }
                } catch (e) {
                    console.log('❌ NBP API niedostępne:', e.message);
                }
                
                // 2. Fallback - Frankfurter API (darmowe, bez limitu, CORS-friendly)
                if (!rate) {
                    try {
                        const response = await fetch('https://api.frankfurter.app/latest?from=EUR&to=PLN');
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.rates && data.rates.PLN) {
                                rate = data.rates.PLN;
                                source = `Frankfurter (${data.date})`;
                                console.log('✅ Frankfurter API działa:', rate);
                            }
                        }
                    } catch (e) {
                        console.log('❌ Frankfurter API niedostępne:', e.message);
                    }
                }
                
                // 3. Fallback - ExchangeRate-API
                if (!rate) {
                    try {
                        const response = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.rates && data.rates.PLN) {
                                rate = data.rates.PLN;
                                source = 'ExchangeRate-API';
                                console.log('✅ ExchangeRate-API działa:', rate);
                            }
                        }
                    } catch (e) {
                        console.log('❌ ExchangeRate-API niedostępne:', e.message);
                    }
                }
                
                // 4. Dodatkowy fallback - CoinGecko (simple price API)
                if (!rate) {
                    try {
                        const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=euro&vs_currencies=pln');
                        if (response.ok) {
                            const data = await response.json();
                            if (data && data.euro && data.euro.pln) {
                                rate = data.euro.pln;
                                source = 'CoinGecko';
                                console.log('✅ CoinGecko API działa:', rate);
                            }
                        }
                    } catch (e) {
                        console.log('❌ CoinGecko API niedostępne:', e.message);
                    }
                }
                
                // 5. Ostatni fallback - domyślne wartości
                if (!rate) {
                    rate = 4.30; // Konserwatywna wartość
                    source = 'Wartość domyślna (API niedostępne)';
                    console.log('⚠️ Używam domyślnego kursu:', rate);
                }
                
                currentExchangeRate = parseFloat(rate) || 4.30;
                document.getElementById('eur-pln-rate').value = currentExchangeRate.toFixed(4);
                
                console.log(`📊 Kurs EUR/PLN: ${rate.toFixed(4)} (${source})`);
                
                // Aktualizuj wyświetlanie jeśli są już ceny
                if (spotPrices) {
                    updateSpotPricesDisplay();
                }
                
                // Wyświetl info o kursie
                const currencyInfo = document.getElementById('currency-info');
                if (currencyInfo && !currencyInfo.innerHTML.includes('Kurs EUR/PLN:')) {
                    currencyInfo.innerHTML = `
                        💱 <span style="font-weight: bold;">Kurs EUR/PLN: ${rate.toFixed(4)}</span>
                        <span style="margin-left: 20px;">📡 Źródło: ${source}</span>
                        <span style="margin-left: 20px;">✏️ Możesz edytować ręcznie</span>
                    `;
                }
                
            } catch (error) {
                console.error('❌ Błąd pobierania kursu:', error);
                
                // Fallback na domyślny kurs
                const defaultRate = 4.30;
                currentExchangeRate = defaultRate;
                document.getElementById('eur-pln-rate').value = defaultRate.toFixed(4);
                
                const currencyInfo = document.getElementById('currency-info');
                if (currencyInfo) {
                    currencyInfo.innerHTML = `
                        ⚠️ <span style="color: var(--warning);">Kurs domyślny: ${defaultRate.toFixed(4)} PLN/EUR</span>
                        <span style="margin-left: 20px;">✏️ Możesz edytować ręcznie powyżej</span>
                    `;
                }
            }
        }
        
        async function fetchSpotPrices() {
            const analysisType = document.getElementById('analysis-type').value;
            const statusDiv = document.getElementById('api-status');
            const btn = document.querySelector('.fetch-btn');
            
            let startDate, endDate;
            const today = new Date();
            const yesterday = new Date(Date.now() - 86400000);
            
            // Określ zakres dat na podstawie typu analizy
            switch (analysisType) {
                case 'single-day':
                    const singleDate = document.getElementById('date-select').value;
                    if (!singleDate) {
                        alert('Wybierz datę analizy');
                        return;
                    }
                    
                    // Sprawdź czy data nie jest z przyszłości
                    const selectedDate = new Date(singleDate);
                    const safeDate = new Date(Date.now() - 2 * 86400000); // 2 dni temu dla pewności
                    if (selectedDate >= safeDate) {
                        alert('❌ ENTSO-E API ma dane tylko z przeszłości!\n\nNajnowsze dostępne dane to sprzed 2-3 dni. Wybierz wcześniejszą datę.');
                        return;
                    }
                    
                    startDate = endDate = singleDate;
                    break;
                    
                case 'date-range':
                    startDate = document.getElementById('date-from').value;
                    endDate = document.getElementById('date-to').value;
                    if (!startDate || !endDate) {
                        alert('Wybierz zakres dat');
                        return;
                    }
                    
                    // Sprawdź czy daty nie są z przyszłości
                    const startDateObj = new Date(startDate);
                    const endDateObj = new Date(endDate);
                    if (startDateObj >= today || endDateObj >= today) {
                        alert('❌ ENTSO-E API ma dane tylko z przeszłości!\n\nNajnowsze dostępne dane to z wczoraj. Wybierz wcześniejsze daty.');
                        return;
                    }
                    
                    break;
                    
                case 'week-analysis':
                    // Automatycznie ustaw pełny poprzedni tydzień (poniedziałek-niedziela)
                    // ENTSO-E ma dane z opóźnieniem ~1-2 dni, więc użyjmy wczoraj jako najnowszą dostępną datę
                    const yesterday = new Date(Date.now() - 86400000); // wczoraj
                    const dayOfWeek = yesterday.getDay(); // 0=niedziela, 1=poniedziałek...
                    
                    // Znajdź niedzielę poprzedniego tygodnia
                    const daysToLastSunday = dayOfWeek === 0 ? 7 : dayOfWeek; // Jak daleko do końca poprzedniego tygodnia
                    const lastSunday = new Date(yesterday);
                    lastSunday.setDate(yesterday.getDate() - daysToLastSunday);
                    
                    // Ustaw pełny poprzedni tydzień (poniedziałek-niedziela)
                    const weekStart = new Date(lastSunday);
                    weekStart.setDate(lastSunday.getDate() - 6); // Poniedziałek poprzedniego tygodnia
                    
                    const weekEnd = new Date(lastSunday); // Niedziela poprzedniego tygodnia
                    
                    console.log(`📅 Analiza tygodniowa: ${weekStart.toISOString().split('T')[0]} - ${weekEnd.toISOString().split('T')[0]}`);
                    
                    // Sprawdź czy daty są w przeszłości względem wczoraj
                    const dayBeforeYesterday = new Date(Date.now() - 2 * 86400000);
                    if (weekEnd > dayBeforeYesterday) {
                        console.log('⚠️ Przesuwam tydzień dalej w przeszłość dla pewności dostępności danych ENTSO-E');
                        // Przesuń o kolejny tydzień w tył dla pewności
                        weekStart.setDate(weekStart.getDate() - 7);
                        weekEnd.setDate(weekEnd.getDate() - 7);
                    }
                    
                    startDate = weekStart.toISOString().split('T')[0];
                    endDate = weekEnd.toISOString().split('T')[0];
                    
                    // Pokaż użytkownikowi wybrane daty
                    statusDiv.innerHTML = `<strong>📅 Analiza tygodniowa:</strong> Automatycznie wybrany poprzedni pełny tydzień: ${startDate} - ${endDate}`;
                    
                    break;
                    
                case 'month-analysis':
                    const monthDate = new Date(document.getElementById('date-select').value);
                    if (!monthDate.getTime()) {
                        alert('Wybierz datę dla analizy miesięcznej');
                        return;
                    }
                    
                    const safeDateMonth = new Date(Date.now() - 2 * 86400000); // 2 dni temu dla pewności
                    if (monthDate >= safeDateMonth) {
                        alert('❌ ENTSO-E API ma dane tylko z przeszłości!\n\nNajnowsze dostępne dane to sprzed 2-3 dni. Wybierz wcześniejszą datę.');
                        return;
                    }
                    
                    startDate = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1).toISOString().split('T')[0];
                    endDate = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).toISOString().split('T')[0];
                    
                    // Sprawdź czy końcowa data miesiąca nie jest zbyt świeża
                    const endDateObjMonth = new Date(endDate);
                    if (endDateObjMonth >= safeDateMonth) {
                        alert('❌ Wybrany miesiąc zawiera zbyt świeże daty!\n\nWybierz miesiąc, który zakończył się co najmniej 3 dni temu.');
                        return;
                    }
                    
                    console.log(`📅 Analiza miesięczna: ${startDate} - ${endDate}`);
                    statusDiv.innerHTML = `<strong>📅 Analiza miesięczna:</strong> ${startDate} - ${endDate}`;
                    
                    break;
            }
            
            // UI feedback
            statusDiv.className = 'api-status glass-card loading';
            statusDiv.innerHTML = `<strong>⏳ Pobieranie:</strong> Rzeczywiste dane z ENTSO-E API... <span class="spinner"></span>`;
            btn.disabled = true;
            btn.innerHTML = '⏳ Pobieranie... <span class="spinner"></span>';
            
            try {
                if (analysisType === 'single-day') {
                    // Pojedynczy dzień
                    await fetchSingleDayPrices(startDate);
                    statusDiv.className = 'api-status glass-card';
                    statusDiv.innerHTML = `<strong>✅ Pobrano:</strong> Rzeczywiste ceny spot dla ${startDate} z ENTSO-E`;
                } else {
                    // Zakres dat
                    await fetchDateRangePrices(startDate, endDate);
                    statusDiv.className = 'api-status glass-card';
                    statusDiv.innerHTML = `<strong>✅ Pobrano:</strong> Rzeczywiste ceny spot dla zakresu ${startDate} - ${endDate} z ENTSO-E`;
                }
                
                updateSpotPricesDisplay();
                calculateCostsAndUpdate();
                
            } catch (error) {
                console.error('❌ Błąd pobierania danych ENTSO-E:', error);
                
                statusDiv.className = 'api-status glass-card error';
                statusDiv.innerHTML = `<strong>❌ Błąd API ENTSO-E:</strong> ${error.message}<br>
                    <small>💡 <strong>Wskazówka:</strong> ENTSO-E ma dane tylko z przeszłości (do wczoraj). 
                    Jeśli wybrałeś datę z przyszłości, wybierz wcześniejszą datę.</small>`;
                
                // NIE MA FALLBACK - musi działać prawdziwe API
                spotPrices = null;
            }
            
            // Reset UI
            btn.disabled = false;
            btn.innerHTML = '📊 Pobierz ceny spot';
        }
        
        // Wrapper function for onclick handlers  
        function handleFetchSpotPrices() {
            fetchSpotPrices().catch(error => {
                console.error('Błąd podczas pobierania cen spot:', error);
            });
        }
        
        // Funkcja generująca przykładowe dane gdy API nie działa
        function generateSamplePrices(date) {
            console.log(`📊 Generowanie przykładowych danych dla ${date}`);
            const prices = [];
            
            // Typowy profil cenowy z Polski (ceny w €/MWh)
            const baseProfile = [
                45, 42, 40, 38, 37, 39, 45, 55,  // 0-7
                65, 62, 58, 56, 54, 52, 50, 48,  // 8-15
                52, 58, 68, 72, 70, 65, 58, 50   // 16-23
            ];
            
            // Dodaj losową zmienność ±20%
            for (let i = 0; i < 24; i++) {
                const variation = 0.8 + Math.random() * 0.4; // 0.8 do 1.2
                prices[i] = baseProfile[i] * variation;
            }
            
            spotPrices = prices;
            console.log('✅ Wygenerowano przykładowe dane:', {
                data: date,
                min: Math.min(...prices).toFixed(2) + ' €/MWh',
                max: Math.max(...prices).toFixed(2) + ' €/MWh',
                średnia: (prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(2) + ' €/MWh'
            });
            
            // Pokaż ostrzeżenie użytkownikowi
            const statusDiv = document.getElementById('api-status');
            if (statusDiv) {
                statusDiv.className = 'api-status glass-card warning';
                statusDiv.innerHTML = `<strong>⚠️ Uwaga:</strong> Używam przykładowych danych cenowych, ponieważ API ENTSO-E jest obecnie niedostępne. 
                    Dane są oparte na typowym profilu cenowym dla Polski.<br>
                    <small>💡 Spróbuj ponownie później lub skontaktuj się z administratorem.</small>`;
            }
            
            return prices;
        }
        
        async function fetchSingleDayPrices(date) {
            // Format daty dla ENTSO-E API (YYYYMMDDHHMM)
            const targetDate = new Date(date);
            const nextDay = new Date(targetDate);
            nextDay.setDate(nextDay.getDate() + 1);
            
            const startDateTime = date.replace(/-/g, '') + '0000';
            const endDateTime = nextDay.toISOString().split('T')[0].replace(/-/g, '') + '0000';
            
            console.log(`Pobieranie danych ENTSO-E dla: ${date} (${startDateTime} - ${endDateTime})`);
            
            // Spróbuj różne metody CORS
            const methods = [
                // Metoda 1: allorigins proxy
                async () => {
                    const apiUrl = `https://web-api.tp.entsoe.eu/api?` +
                        `securityToken=${ENTSO_API_TOKEN}&` +
                        `documentType=A44&` +
                        `in_Domain=${POLAND_DOMAIN}&` +
                        `out_Domain=${POLAND_DOMAIN}&` +
                        `periodStart=${startDateTime}&` +
                        `periodEnd=${endDateTime}`;
                    
                    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(apiUrl);
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) throw new Error(`AllOrigins proxy error: ${response.status}`);
                    
                    const data = await response.json();
                    if (!data.contents) throw new Error('Brak contents w odpowiedzi AllOrigins');
                    
                    return data.contents;
                },
                
                // Metoda 2: corsproxy.io
                async () => {
                    const apiUrl = `https://web-api.tp.entsoe.eu/api?` +
                        `securityToken=${ENTSO_API_TOKEN}&` +
                        `documentType=A44&` +
                        `in_Domain=${POLAND_DOMAIN}&` +
                        `out_Domain=${POLAND_DOMAIN}&` +
                        `periodStart=${startDateTime}&` +
                        `periodEnd=${endDateTime}`;
                    
                    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(apiUrl);
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) throw new Error(`CorsProxy error: ${response.status}`);
                    
                    return await response.text();
                },
                
                // Metoda 3: cors-anywhere
                async () => {
                    const apiUrl = `https://web-api.tp.entsoe.eu/api?` +
                        `securityToken=${ENTSO_API_TOKEN}&` +
                        `documentType=A44&` +
                        `in_Domain=${POLAND_DOMAIN}&` +
                        `out_Domain=${POLAND_DOMAIN}&` +
                        `periodStart=${startDateTime}&` +
                        `periodEnd=${endDateTime}`;
                    
                    const proxyUrl = 'https://cors-anywhere.herokuapp.com/' + apiUrl;
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) throw new Error(`CORS-Anywhere error: ${response.status}`);
                    
                    return await response.text();
                }
            ];
            
            let xmlText = null;
            let lastError = null;
            
            // Próbuj każdą metodę CORS
            for (let i = 0; i < methods.length; i++) {
                try {
                    console.log(`Próba ${i + 1}: Pobieranie przez proxy...`);
                    xmlText = await methods[i]();
                    console.log(`✅ Sukces przez proxy ${i + 1}`);
                    break;
                } catch (error) {
                    console.warn(`❌ Proxy ${i + 1} nie działa:`, error.message);
                    lastError = error;
                    continue;
                }
            }
            
            if (!xmlText) {
                console.warn('❌ Wszystkie proxy CORS nie działają. Używam przykładowych danych...');
                // Użyj przykładowych danych jako fallback
                return generateSamplePrices(date);
            }
            
            // Parsuj XML z ENTSO-E
            const prices = parseENTSOEXML(xmlText);
            
            if (!prices || prices.length === 0) {
                console.warn('❌ Błąd parsowania danych ENTSO-E, używam przykładowych danych');
                return generateSamplePrices(date);
            }
            
            // Sprawdź czy mamy 24 godziny
            if (prices.length !== 24) {
                console.warn(`Otrzymano ${prices.length} cen zamiast 24`);
                // Dopełnij lub obetnij do 24 godzin
                while (prices.length < 24) {
                    prices.push(prices[prices.length - 1] || 50); // Domyślna cena 50 €/MWh
                }
                if (prices.length > 24) {
                    prices.splice(24);
                }
            }
            
            spotPrices = prices;
            console.log('✅ Pobrano prawdziwe dane ENTSO-E:', {
                data: date,
                liczba_cen: prices.length,
                min: Math.min(...prices).toFixed(2) + ' €/MWh',
                max: Math.max(...prices).toFixed(2) + ' €/MWh',
                średnia: (prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(2) + ' €/MWh',
                przykład: prices.slice(0, 3).map(p => p.toFixed(2)).join(', ') + '...'
            });
        }
        
        async function fetchDateRangePrices(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            if (daysDiff > 31) {
                throw new Error('Maksymalny zakres to 31 dni');
            }
            
            spotPricesRange = [];
            const currentDate = new Date(start);
            
            for (let i = 0; i < daysDiff; i++) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                console.log(`Pobieranie danych dla dnia ${i + 1}/${daysDiff}: ${dateStr}`);
                
                try {
                    await fetchSingleDayPrices(dateStr);
                    spotPricesRange.push({
                        date: dateStr,
                        prices: [...spotPrices]
                    });
                } catch (error) {
                    console.error(`❌ Błąd pobierania danych dla ${dateStr}:`, error.message);
                    throw new Error(`Nie udało się pobrać danych dla ${dateStr}: ${error.message}`);
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
                
                // Krótkая pauza między żądaniami aby nie przeciążyć API
                if (i < daysDiff - 1) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            // Ustaw średnie ceny dla analizy
            if (spotPricesRange.length > 0) {
                spotPrices = calculateAverageHourlyPrices(spotPricesRange);
                console.log(`✅ Obliczono średnie ceny z ${spotPricesRange.length} dni`);
            } else {
                throw new Error('Nie udało się pobrać żadnych danych cenowych');
            }
        }
        
        function parseENTSOEXML(xmlText) {
            try {
                console.log('🔍 Parsowanie XML z ENTSO-E...');
                
                if (!xmlText || xmlText.trim().length === 0) {
                    console.error('❌ Pusty XML od ENTSO-E');
                    return null;
                }
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                // Sprawdź błędy parsowania
                const parseError = xmlDoc.querySelector('parsererror');
                if (parseError) {
                    throw new Error(`Błąd parsowania XML: ${parseError.textContent}`);
                }
                
                // Sprawdź błędy ENTSO-E API
                const errorElement = xmlDoc.querySelector('Reason, text');
                if (errorElement && errorElement.textContent.includes('No matching data found')) {
                    throw new Error(`ENTSO-E API: ${errorElement.textContent}`);
                }
                
                // Znajdź dane cenowe - różne możliwe struktury XML
                const timeSeries = xmlDoc.querySelectorAll('TimeSeries');
                const prices = new Array(24).fill(null);
                
                console.log(`Znaleziono ${timeSeries.length} TimeSeries`);
                
                if (timeSeries.length === 0) {
                    // Spróbuj alternatywnej struktury
                    const periods = xmlDoc.querySelectorAll('Period');
                    console.log(`Znaleziono ${periods.length} Periods`);
                    
                    periods.forEach(period => {
                        const points = period.querySelectorAll('Point');
                        points.forEach(point => {
                            const positionEl = point.querySelector('position');
                            const priceEl = point.querySelector('price\\.amount, amount');
                            
                            if (positionEl && priceEl) {
                                const position = parseInt(positionEl.textContent) - 1; // ENTSO-E używa 1-based indexing
                                const price = parseFloat(priceEl.textContent);
                                
                                if (position >= 0 && position < 24 && !isNaN(price)) {
                                    prices[position] = price;
                                }
                            }
                        });
                    });
                } else {
                    // Standardowa struktura TimeSeries
                    timeSeries.forEach(ts => {
                        const points = ts.querySelectorAll('Point');
                        points.forEach(point => {
                            const positionEl = point.querySelector('position');
                            const priceEl = point.querySelector('price\\.amount, amount');
                            
                            if (positionEl && priceEl) {
                                const position = parseInt(positionEl.textContent) - 1; // ENTSO-E używa 1-based indexing
                                const price = parseFloat(priceEl.textContent);
                                
                                if (position >= 0 && position < 24 && !isNaN(price)) {
                                    prices[position] = price;
                                }
                            }
                        });
                    });
                }
                
                // Sprawdź czy udało się wyparsować jakiekolwiek ceny
                const validPrices = prices.filter(p => p !== null && !isNaN(p));
                console.log(`Wyparsowano ${validPrices.length} ważnych cen z 24`);
                
                if (validPrices.length === 0) {
                    console.error('XML content:', xmlText.substring(0, 1000) + '...');
                    throw new Error('Nie udało się wyparsować żadnych cen z XML');
                }
                
                // Wypełnij brakujące ceny interpolacją lub średnią
                const avgPrice = validPrices.reduce((a, b) => a + b, 0) / validPrices.length;
                
                for (let i = 0; i < 24; i++) {
                    if (prices[i] === null || isNaN(prices[i])) {
                        // Spróbuj interpolacji z sąsiadami
                        let leftPrice = null, rightPrice = null;
                        
                        for (let j = i - 1; j >= 0; j--) {
                            if (prices[j] !== null && !isNaN(prices[j])) {
                                leftPrice = prices[j];
                                break;
                            }
                        }
                        
                        for (let j = i + 1; j < 24; j++) {
                            if (prices[j] !== null && !isNaN(prices[j])) {
                                rightPrice = prices[j];
                                break;
                            }
                        }
                        
                        if (leftPrice !== null && rightPrice !== null) {
                            prices[i] = (leftPrice + rightPrice) / 2;
                        } else if (leftPrice !== null) {
                            prices[i] = leftPrice;
                        } else if (rightPrice !== null) {
                            prices[i] = rightPrice;
                        } else {
                            prices[i] = avgPrice || 50; // Domyślna cena jeśli brak średniej
                        }
                    }
                }
                
                console.log('✅ Parsowanie XML zakończone pomyślnie');
                return prices;
                
            } catch (error) {
                console.error('Błąd parsowania XML:', error);
                throw error;
            }
        }
        
        function calculateAverageHourlyPrices(pricesRange) {
            const hourlyAverages = new Array(24).fill(0);
            const hourlyCounts = new Array(24).fill(0);
            
            pricesRange.forEach(dayData => {
                if (!dayData || !dayData.prices || !Array.isArray(dayData.prices)) return;
                
                dayData.prices.forEach((price, hour) => {
                    if (price && price > 0 && hour >= 0 && hour < 24) {
                        hourlyAverages[hour] += price;
                        hourlyCounts[hour]++;
                    }
                });
            });
            
            return hourlyAverages.map((sum, hour) => 
                hourlyCounts[hour] > 0 ? sum / hourlyCounts[hour] : 0
            );
        }
        
        function updateSpotPricesDisplay() {
            const eurPln = parseFloat(document.getElementById('eur-pln-rate').value) || currentExchangeRate || 4.30;
            const preview = document.getElementById('price-preview');
            const grid = document.getElementById('spot-prices-grid');
            const stats = document.getElementById('price-stats');
            const currencyInfo = document.getElementById('currency-info');
            
            if (!spotPrices || spotPrices.length === 0) {
                if (preview) preview.style.display = 'none';
                return;
            }
            
            // Przelicz ceny na zł/kWh
            const pricesInPLN = spotPrices.map(price => (price * eurPln / 1000));
            
            // Oblicz statystyki
            const validPrices = pricesInPLN.filter(p => !isNaN(p) && p !== null);
            if (validPrices.length === 0) {
                if (preview) preview.style.display = 'none';
                return;
            }
            
            const minPrice = Math.min(...validPrices);
            const maxPrice = Math.max(...validPrices);
            const avgPrice = validPrices.reduce((a, b) => a + b, 0) / validPrices.length;
            
            // Wyświetl statystyki
            if (stats) {
                stats.innerHTML = `
                    <strong>📊 PRAWDZIWE DANE ENTSO-E:</strong> 
                    Min: ${minPrice.toFixed(4)} zł/kWh | 
                    Śr: ${avgPrice.toFixed(4)} zł/kWh | 
                    Max: ${maxPrice.toFixed(4)} zł/kWh
                `;
            }
            
            // Wyczyść siatkę
            if (grid) {
                grid.innerHTML = '';
                
                // Wypełnij siatkę cenami
                pricesInPLN.forEach((price, hour) => {
                    if (isNaN(price) || price === null) return;
                    
                    const cell = document.createElement('div');
                    cell.className = 'price-cell';
                    
                    // Kolor na podstawie ceny (zielony = tania, czerwony = droga)
                    const ratio = maxPrice > minPrice ? (price - minPrice) / (maxPrice - minPrice) : 0.5;
                    const hue = 120 - (ratio * 120); // 120 = zielony, 0 = czerwony
                    const saturation = 60 + (ratio * 20); // 60-80%
                    const lightness = 85 - (ratio * 25); // 85-60%
                    
                    cell.style.backgroundColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                    
                    // Kolor tekstu dla lepszej czytelności
                    cell.style.color = lightness < 70 ? 'white' : 'var(--text-primary)';
                    
                    cell.innerHTML = `
                        <div class="price-hour">${hour}h</div>
                        <div class="price-value">${price.toFixed(4)}</div>
                    `;
                    
                    cell.title = `${hour}:00 - ${price.toFixed(4)} zł/kWh (${(price * 1000 / eurPln).toFixed(2)} €/MWh) - DANE ENTSO-E`;
                    
                    grid.appendChild(cell);
                });
            }
            
            if (preview) {
                preview.style.display = 'block';
            }
            
            // Aktualizuj wizualizacje
            renderHourlyTariffs();
        }
        
        function calculateCostsAndUpdate() {
            try {
                const monthlyUsage = parseFloat(document.getElementById('monthly-usage').value) || 300;
                const annualUsage = parseFloat(document.getElementById('annual-usage').value) || 3600;
                const installationTypeElement = document.getElementById('installation-type');
                const installationType = installationTypeElement ? installationTypeElement.value : '3-phase';
                
                console.log('🔍 Debug calculateCostsAndUpdate:', {
                    monthlyUsage,
                    annualUsage,
                    installationType,
                    currentProfile: currentProfile.length,
                    tariffsCount: Object.keys(tariffs).length
                });
                
                const results = [];
                
                // Oblicz koszty dla każdej taryfy
                Object.entries(tariffs).forEach(([id, tariff]) => {
                    try {
                        const cost = calculateTariffCost(id, monthlyUsage, annualUsage, installationType);
                        console.log(`💰 Koszt dla ${id}:`, cost);
                        if (cost !== null) {
                            results.push({
                                id: id,
                                name: tariff.name,
                                totalCost: cost.total,
                                variableCost: cost.variable,
                                fixedCost: cost.fixed,
                                dailyCost: cost.total / 30 // Średni koszt dzienny
                            });
                        }
                    } catch (error) {
                        console.error(`❌ Błąd obliczania kosztu dla taryfy ${id}:`, error);
                    }
                });
                
                // Sortuj po kosztach
                results.sort((a, b) => a.totalCost - b.totalCost);
                
                console.log('📊 Wyniki obliczeń:', results.length, 'taryf');
                console.log('📋 Lista wyników:', results);
                
                // Aktualizuj podsumowanie miesięczne
                updateCostSummary(results);
                console.log('✅ updateCostSummary wywołane');
                
                // Aktualizuj podsumowanie dzienne
                updateDailyCostSummary(results);
                
                // Aktualizuj wykresy
                setTimeout(() => {
                    createCharts();
                    console.log('📊 Wykresy utworzone po załadowaniu danych');
                }, 100);
                
                // Renderuj taryfy godzinowe
                renderHourlyTariffs();
                
            } catch (error) {
                console.error('Błąd podczas aktualizacji kosztów:', error);
            }
        }
        
        function calculateTariffCost(tariffId, monthlyUsage, annualUsage, installationType) {
            try {
                const tariff = tariffs[tariffId];
                if (!tariff) {
                    console.error(`❌ Nie znaleziono taryfy: ${tariffId}`);
                    return null;
                }
                
                console.log(`🔍 Obliczam koszt dla ${tariffId}:`, {
                    monthlyUsage,
                    annualUsage,
                    installationType,
                    tariffType: tariff.type
                });
                
                const installKey = installationType === "1-phase" ? "1-phase" : "3-phase";
                
                // Opłaty stałe
                const fixedNetwork = tariff.fixedMonthly && tariff.fixedMonthly[installKey] ? tariff.fixedMonthly[installKey] : 0;
                const fixedSystem = systemCharges.subscription + getTransitionFee(annualUsage) + getPowerFee(annualUsage);
                const totalFixed = fixedNetwork + fixedSystem;
                
                // Opłaty zmienne - używaj profilu odpowiedniego dla kalkulacji
                let variableCost = 0;
                const profileToUse = useWeeklyProfiles ? getAverageWeeklyProfile() : currentProfile;
                
                // Zabezpieczenie przed brakiem profilu
                if (!profileToUse || profileToUse.length !== 24) {
                    console.error('Błąd: Nieprawidłowy profil zużycia');
                    return null;
                }
                
                if (tariff.type === "flat") {
                    // G11 - stała stawka
                    const rate = useShield && tariff.rateShield ? tariff.rateShield : tariff.rate;
                    variableCost = monthlyUsage * rate;
                } else if (tariff.type === "dynamic" && spotPrices) {
                    // G11f - dynamiczna na podstawie cen spot + stały składnik zmienny
                    const eurPln = parseFloat(document.getElementById('eur-pln-rate').value) || 4.30;
                    const margin = parseFloat(document.getElementById('g11f-margin').value) || 0.05;
                    
                    let totalDynamicCost = 0;
                    for (let hour = 0; hour < 24; hour++) {
                        if (spotPrices[hour] === undefined || profileToUse[hour] === undefined) continue;
                        
                        // Składnik dynamiczny (spot) + stały składnik zmienny + marża
                        const spotPriceInPLN = spotPrices[hour] * eurPln / 1000; // Przelicz €/MWh na zł/kWh
                        const totalHourlyRate = spotPriceInPLN + (tariff.baseRate || 0.0516) + margin;
                        const hourlyUsage = (monthlyUsage / 30) * (profileToUse[hour] / 100);
                        totalDynamicCost += hourlyUsage * totalHourlyRate;
                    }
                    variableCost = totalDynamicCost * 30; // Przelicz na miesiąc
                } else if (tariff.zones && tariff.rates) {
                    // Taryfy strefowe (G12, G12w, G12r)
                    let dayUsage = 0;
                    let nightUsage = 0;
                    
                    for (let hour = 0; hour < 24; hour++) {
                        const zone = tariff.zones[hour];
                        if (!zone || profileToUse[hour] === undefined) continue;
                        
                        const hourlyUsage = (monthlyUsage / 30) * (profileToUse[hour] / 100);
                        
                        if (zone === 'day' || zone === 'peak') {
                            dayUsage += hourlyUsage;
                        } else if (zone === 'night' || zone === 'offpeak') {
                            nightUsage += hourlyUsage;
                        }
                    }
                    
                    dayUsage *= 30; // Przelicz na miesiąc
                    nightUsage *= 30;
                    
                    let dayRate, nightRate;
                    
                    if (useShield) {
                        // Z tarczą
                        dayRate = tariff.rates.dayShield !== undefined ? tariff.rates.dayShield : 
                                 (tariff.rates.peakShield !== undefined ? tariff.rates.peakShield : tariff.rates.day || tariff.rates.peak || 0);
                        nightRate = tariff.rates.nightShield !== undefined ? tariff.rates.nightShield : 
                                   (tariff.rates.offpeakShield !== undefined ? tariff.rates.offpeakShield : tariff.rates.night || tariff.rates.offpeak || 0);
                    } else {
                        // Bez tarczy
                        dayRate = tariff.rates.day !== undefined ? tariff.rates.day : 
                                 (tariff.rates.peak !== undefined ? tariff.rates.peak : 0);
                        nightRate = tariff.rates.night !== undefined ? tariff.rates.night : 
                                   (tariff.rates.offpeak !== undefined ? tariff.rates.offpeak : 0);
                    }
                    
                    variableCost = (dayUsage * dayRate) + (nightUsage * nightRate);
                }
                
                // Opłaty systemowe zmienne
                const systemVariable = monthlyUsage * (systemCharges.quality + systemCharges.oze + systemCharges.cogeneration);
                
                const totalVariable = variableCost + systemVariable;
                const totalCost = totalFixed + totalVariable;
                
                return {
                    total: totalCost,
                    fixed: totalFixed,
                    variable: totalVariable
                };
                
            } catch (error) {
                console.error(`Błąd w calculateTariffCost dla ${tariffId}:`, error);
                return null;
            }
        }
        
        function updateCostSummary(results) {
            const container = document.getElementById('cost-summary');
            console.log('🔍 updateCostSummary:', {
                containerFound: !!container,
                resultsCount: results.length,
                isDualProfileMode,
                hasComparisonProfile: !!comparisonProfile
            });
            
            if (!container) {
                console.error('❌ Nie znaleziono kontenera cost-summary');
                return;
            }
            
            container.innerHTML = '';
            
            if (isDualProfileMode && comparisonProfile) {
                // Tryb porównania dwóch profili - zmień layout na kolumnowy
                container.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                    max-width: 100%;
                `;
                updateDualProfileSummary(results);
            } else {
                // Przywróć standardowy grid layout
                container.style.cssText = `
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                `;
                
                // Standardowy tryb - jeden profil
                results.forEach((result, index) => {
                    const card = document.createElement('div');
                    card.className = 'summary-card' + (index === 0 ? ' best' : '');
                    
                    const difference = index === 0 ? 'NAJTAŃSZA' : 
                        `+${(result.totalCost - results[0].totalCost).toFixed(2)} zł`;
                    const differenceClass = index === 0 ? 'savings' : 'loss';
                    
                    card.innerHTML = `
                        <div class="summary-value">${result.totalCost.toFixed(2)} zł</div>
                        <div class="summary-label">${result.id}</div>
                        <div class="summary-label">${result.name}</div>
                        <div class="${differenceClass}" style="margin-top: 5px; font-weight: bold; color: ${index === 0 ? 'white' : 'var(--danger)'};">${difference}</div>
                    `;
                    
                    container.appendChild(card);
                });
            }
        }
        
        function updateDualProfileSummary(resultsA) {
            const container = document.getElementById('cost-summary');
            
            // Oblicz koszty dla profilu B
            const monthlyUsage = parseFloat(document.getElementById('monthly-usage').value) || 300;
            const annualUsage = parseFloat(document.getElementById('annual-usage').value) || 3600;
            const installationTypeElement = document.getElementById('installation-type');
            const installationType = installationTypeElement ? installationTypeElement.value : '3-phase';
            
            const resultsB = calculateAllTariffCosts(comparisonProfile, monthlyUsage, annualUsage, installationType);
            
            console.log('🔍 updateDualProfileSummary debug:', {
                resultsACount: resultsA.length,
                resultsBCount: resultsB.length,
                comparisonProfile: comparisonProfile?.slice(0, 3),
                currentProfile: currentProfile?.slice(0, 3),
                monthlyUsage,
                annualUsage,
                installationType
            });
            
            if (!resultsB || resultsB.length === 0) {
                console.error('❌ Brak wyników dla profilu B');
                container.innerHTML = '<div style="text-align: center; padding: 20px;">❌ Błąd obliczania kosztów dla profilu B</div>';
                return;
            }
            
            // Pobierz nazwy profili
            const mainProfileName = getProfileDisplayName(currentProfile);
            const comparisonProfileName = getProfileDisplayName(comparisonProfile);
            
            // Nagłówek porównania - większy, bardziej widoczny
            const header = document.createElement('div');
            header.style.cssText = `
                grid-column: 1/-1; 
                text-align: center; 
                margin-bottom: 20px; 
                padding: 15px; 
                background: linear-gradient(135deg, var(--success), var(--info)); 
                border-radius: 10px; 
                color: white; 
                font-weight: bold;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            `;
            header.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center;">
                    <div style="font-size: 1.1rem;">
                        🏠 ${mainProfileName}
                    </div>
                    <div style="
                        font-size: 1.8rem; 
                        font-weight: 900; 
                        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                        border: 3px solid white;
                        padding: 5px 15px;
                        border-radius: 50px;
                        background: rgba(255,255,255,0.2);
                    ">VS</div>
                    <div style="font-size: 1.1rem;">
                        🔄 ${comparisonProfileName}
                    </div>
                </div>
            `;
            container.appendChild(header);
            
            // Porównanie taryf - lepszy layout
            console.log('🔍 Rozpoczynam pętlę porównania, resultsA.slice(0, 5):', resultsA.slice(0, 5));
            console.log('🔍 Struktura resultsA[0]:', resultsA[0]);
            console.log('🔍 Struktura resultsB[0]:', resultsB[0]);
            console.log('🔍 Wszystkie ID w resultsA:', resultsA.map(r => r.id));
            console.log('🔍 Wszystkie ID w resultsB:', resultsB.map(r => r.id));
            console.log('🔍 JSON resultsA[0]:', JSON.stringify(resultsA[0], null, 2));
            console.log('🔍 JSON resultsB[0]:', JSON.stringify(resultsB[0], null, 2));
            
            resultsA.slice(0, 5).forEach((resultA, index) => {
                console.log(`🔍 Przetwarzam taryfę ${index}: ${resultA.id}`);
                const resultB = resultsB.find(r => r.id === resultA.id);
                if (!resultB) {
                    console.log(`❌ Nie znaleziono resultB dla ${resultA.id}`);
                    return;
                }
                console.log(`✅ Znaleziono resultB dla ${resultA.id}:`, resultB);
                
                const card = document.createElement('div');
                card.className = 'summary-card dual-profile-card';
                card.style.cssText = `
                    padding: 20px;
                    margin-bottom: 15px;
                    border-radius: 12px;
                    background: var(--card-bg);
                    border: 2px solid var(--border);
                    width: 100%;
                    max-width: none;
                    min-width: 400px;
                    box-sizing: border-box;
                `;
                
                const difference = resultA.totalCost - resultB.totalCost;
                const betterProfile = difference > 0 ? 'B' : difference < 0 ? 'A' : 'równe';
                const savingsAmount = Math.abs(difference);
                
                // Określ kolory na podstawie który profil jest lepszy
                const profileABetter = difference < 0;
                const profileBBetter = difference > 0;
                const isEqual = difference === 0;
                
                card.innerHTML = `
                    <div class="tariff-name" style="text-align: center; font-weight: bold; margin-bottom: 15px; color: var(--text-primary);">
                        ${resultA.id} - ${resultA.name}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 80px 1fr; gap: 20px; align-items: center; margin: 20px 0;">
                        <div style="
                            text-align: center; 
                            padding: 15px; 
                            border-radius: 12px; 
                            background: ${profileABetter ? 'var(--success)' : profileBBetter ? 'rgba(220, 53, 69, 0.1)' : 'var(--secondary)'};
                            color: ${profileABetter ? 'white' : profileBBetter ? 'var(--danger)' : 'var(--text-primary)'};
                            font-weight: bold;
                            border: 3px solid ${profileABetter ? 'var(--success)' : 'transparent'};
                            min-height: 100px;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                        ">
                            <div style="font-size: 1rem; margin-bottom: 8px; opacity: 0.9;">A: ${mainProfileName}</div>
                            <div style="font-size: 1.6rem; font-weight: 900;">${resultA.totalCost.toFixed(2)} zł</div>
                            ${profileABetter ? '<div style="font-size: 0.9rem; margin-top: 8px;">🏆 LEPSZY</div>' : ''}
                        </div>
                        
                        <div style="
                            font-size: 2.5rem; 
                            font-weight: 900; 
                            color: var(--primary);
                            text-align: center;
                            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
                        ">VS</div>
                        
                        <div style="
                            text-align: center; 
                            padding: 15px; 
                            border-radius: 12px; 
                            background: ${profileBBetter ? 'var(--success)' : profileABetter ? 'rgba(220, 53, 69, 0.1)' : 'var(--secondary)'};
                            color: ${profileBBetter ? 'white' : profileABetter ? 'var(--danger)' : 'var(--text-primary)'};
                            font-weight: bold;
                            border: 3px solid ${profileBBetter ? 'var(--success)' : 'transparent'};
                            min-height: 100px;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                        ">
                            <div style="font-size: 1rem; margin-bottom: 8px; opacity: 0.9;">B: ${comparisonProfileName}</div>
                            <div style="font-size: 1.6rem; font-weight: 900;">${resultB.totalCost.toFixed(2)} zł</div>
                            ${profileBBetter ? '<div style="font-size: 0.9rem; margin-top: 8px;">🏆 LEPSZY</div>' : ''}
                        </div>
                    </div>
                    
                    <div style="
                        text-align: center; 
                        margin-top: 15px; 
                        padding: 10px; 
                        background: ${isEqual ? 'var(--info)' : profileABetter || profileBBetter ? 'var(--success)' : 'var(--secondary)'};
                        color: white;
                        border-radius: 6px;
                        font-weight: bold;
                    ">
                        ${isEqual ? '🤝 Równe koszty' : 
                          `💰 Oszczędność: ${savingsAmount.toFixed(2)} zł (Profil ${betterProfile.toUpperCase()} lepszy)`}
                    </div>
                `;
                
                console.log(`✅ Dodaję kartę do kontenera dla ${resultA.id}`);
                container.appendChild(card);
            });
            
            console.log('🏁 Zakończono tworzenie kart porównania, liczba dzieci kontenera:', container.children.length);
        }
        
        function updateDailyCostSummary(results) {
            const container = document.getElementById('daily-cost-summary');
            if (!container) return;
            
            container.innerHTML = '';
            
            results.forEach(result => {
                const card = document.createElement('div');
                card.className = 'day-cost-card';
                
                card.innerHTML = `
                    <div class="day-name">${result.id}</div>
                    <div class="day-cost">${result.dailyCost.toFixed(2)} zł</div>
                `;
                
                container.appendChild(card);
            });
        }
        
        function renderHourlyTariffs() {
            // Zabezpieczenie przed brakiem danych
            try {
                if (tariffs.G12 && tariffs.G12.zones && tariffs.G12.rates) {
                    renderTariffHours('g12-hours', tariffs.G12.zones, tariffs.G12.rates);
                }
                if (tariffs.G12w && tariffs.G12w.zones && tariffs.G12w.rates) {
                    renderTariffHours('g12w-hours', tariffs.G12w.zones, tariffs.G12w.rates);
                }
                if (tariffs.G12r && tariffs.G12r.zones && tariffs.G12r.rates) {
                    renderTariffHours('g12r-hours', tariffs.G12r.zones, tariffs.G12r.rates);
                }
                
                // G11f - dynamiczne ceny
                if (spotPrices && spotPrices.length > 0) {
                    const eurPln = parseFloat(document.getElementById('eur-pln-rate').value) || currentExchangeRate || 4.30;
                    const margin = parseFloat(document.getElementById('g11f-margin').value) || 0.05;
                    const baseRate = tariffs.G11f ? tariffs.G11f.baseRate : 0.0516; // Stały składnik zmienny 0.0516 zł/kWh
                    
                    const dynamicPrices = spotPrices.map(price => {
                        if (price === null || price === undefined || isNaN(price)) return null;
                        const spotPriceInPLN = price * eurPln / 1000; // €/MWh -> zł/kWh
                        return spotPriceInPLN + baseRate + margin; // spot + stały składnik + marża
                    }).filter(p => p !== null);
                    
                    if (dynamicPrices.length > 0) {
                        renderDynamicHours('g11f-hours', dynamicPrices);
                    }
                }
            } catch (error) {
                console.error('Błąd podczas renderowania taryf godzinowych:', error);
            }
        }
        
        function renderTariffHours(containerId, zones, rates) {
            const container = document.getElementById(containerId);
            if (!container || !zones || !rates) return;
            
            container.innerHTML = '';
            
            zones.forEach((zone, hour) => {
                if (!zone || zone === undefined || zone === null) return;
                
                const cell = document.createElement('div');
                cell.className = 'hour-cell';
                cell.textContent = hour;
                
                let rate = null;
                // Sprawdź czy zone to string i czy rates ma odpowiednią właściwość
                if (typeof zone === 'string' && rates.hasOwnProperty(zone)) {
                    rate = rates[zone];
                } else if (zone === 'day' && rates.day !== undefined) {
                    rate = rates.day;
                } else if (zone === 'night' && rates.night !== undefined) {
                    rate = rates.night;
                } else if (zone === 'peak' && rates.peak !== undefined) {
                    rate = rates.peak;
                } else if (zone === 'offpeak' && rates.offpeak !== undefined) {
                    rate = rates.offpeak;
                }
                
                if (rate === null || rate === undefined) return;
                
                const color = (zone === 'day' || zone === 'peak') ? 'var(--danger)' : 'var(--success)';
                cell.style.backgroundColor = color;
                cell.title = `${hour}:00 - ${zone} (${rate.toFixed(4)} zł/kWh)`;
                
                container.appendChild(cell);
            });
        }
        
        function renderDynamicHours(containerId, prices) {
            const container = document.getElementById(containerId);
            if (!container || !prices || prices.length === 0) return;
            
            container.innerHTML = '';
            
            const validPrices = prices.filter(p => p !== null && p !== undefined && !isNaN(p));
            if (validPrices.length === 0) return;
            
            const minPrice = Math.min(...validPrices);
            const maxPrice = Math.max(...validPrices);
            
            prices.forEach((price, hour) => {
                if (price === null || price === undefined || isNaN(price) || hour >= 24) return;
                
                const cell = document.createElement('div');
                cell.className = 'hour-cell';
                cell.textContent = hour;
                
                // Kolor na podstawie ceny (od zielonego przez żółty do czerwonego)
                const ratio = maxPrice > minPrice ? (price - minPrice) / (maxPrice - minPrice) : 0.5;
                const hue = 120 - (ratio * 120); // 120 = zielony, 0 = czerwony
                cell.style.backgroundColor = `hsl(${hue}, 70%, 50%)`;
                cell.title = `${hour}:00 - ${price.toFixed(4)} zł/kWh (spot + stały składnik + marża)`;
                
                container.appendChild(cell);
            });
        }
        
        function createCharts() {
            try {
                console.log('🎯 Inicjalizacja wykresów...');
                const ctx1 = document.getElementById('hourlyRatesChart');
                const ctx2 = document.getElementById('costProfileChart');
                
                if (!ctx1 || !ctx2) {
                    console.error('❌ Nie znaleziono elementów canvas dla wykresów');
                    console.log('Sprawdzanie DOM:', {
                        hourlyRatesChart: !!ctx1,
                        costProfileChart: !!ctx2,
                        chartjsLoaded: typeof Chart !== 'undefined'
                    });
                    return;
                }
                
                console.log('✅ Elementy canvas znalezione, Chart.js loaded:', typeof Chart !== 'undefined');
                
                // Niszczenie starych wykresów
                if (hourlyChart) {
                    hourlyChart.destroy();
                    hourlyChart = null;
                }
                if (costChart) {
                    costChart.destroy();
                    costChart = null;
                }
                
                const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
                
                // Chart colors
                const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary');
                const gridColor = getComputedStyle(document.body).getPropertyValue('--border-color');
                
                // Oblicz całkowite opłaty systemowe
                // Składniki kosztów:
                // 1. Składnik zmienny stawki sieciowej (zależny od taryfy i strefy)
                // 2. Jakościowa: 0.0321 zł/kWh
                // 3. OZE: 3.50 zł/MWh = 0.0035 zł/kWh
                // 4. Kogeneracyjna: 3.00 zł/MWh = 0.003 zł/kWh
                // 5. Mocowa: 0.1412 zł/kWh (tylko w godzinach szczytowych)
                const baseSystemCharges = systemCharges.quality + systemCharges.oze + systemCharges.cogeneration; // 0.0321 + 0.0035 + 0.003 = 0.0386
                
                // Godziny szczytowe dla opłaty mocowej (zgodnie z informacją URE dla 2025)
                // TODO: Zaktualizować zgodnie z informacją URE nr 55/2024 dla poszczególnych kwartałów
                // Tymczasowo używamy standardowych godzin szczytowych 7-21 w dni robocze
                const peakHours = [7,8,9,10,11,12,13,14,15,16,17,18,19,20];
                const powerCharge = 0.1412; // zł/kWh
                
                // Funkcja do obliczania całkowitej opłaty systemowej
                const getTotalSystemCharges = (hour) => {
                    const isPeakHour = peakHours.includes(hour);
                    return baseSystemCharges + (isPeakHour ? powerCharge : 0);
                };
                
                // Wykres stawek godzinowych - pokazujący CAŁKOWITE koszty (dystrybucja + wszystkie opłaty)
                const datasets = [
                    {
                        label: 'G11 (stała) - całkowity koszt',
                        data: hours.map((_, hour) => {
                            const rate = tariffs.G11 ? (useShield && tariffs.G11.rateShield ? tariffs.G11.rateShield : tariffs.G11.rate) : 0;
                            return rate + getTotalSystemCharges(hour);
                        }),
                        borderColor: '#3498db',
                        backgroundColor: '#3498db20',
                        borderWidth: 2
                    },
                    {
                        label: 'G12 (dzień/noc) - całkowity koszt',
                        data: tariffs.G12.zones ? tariffs.G12.zones.map((zone, hour) => {
                            if (!zone || !tariffs.G12.rates) return 0;
                            let rate = 0;
                            if (zone === 'day') {
                                rate = useShield && tariffs.G12.rates.dayShield !== undefined ? tariffs.G12.rates.dayShield : tariffs.G12.rates.day || 0;
                            } else if (zone === 'night') {
                                rate = useShield && tariffs.G12.rates.nightShield !== undefined ? tariffs.G12.rates.nightShield : tariffs.G12.rates.night || 0;
                            }
                            return rate + getTotalSystemCharges(hour);
                        }) : [],
                        borderColor: '#e74c3c',
                        backgroundColor: '#e74c3c20',
                        borderWidth: 2,
                        stepped: true
                    },
                    {
                        label: 'G12w (weekendowa) - całkowity koszt',
                        data: tariffs.G12w.zones ? tariffs.G12w.zones.map((zone, hour) => {
                            if (!zone || !tariffs.G12w.rates) return 0;
                            let rate = 0;
                            if (zone === 'day') {
                                rate = useShield && tariffs.G12w.rates.dayShield !== undefined ? tariffs.G12w.rates.dayShield : tariffs.G12w.rates.day || 0;
                            } else if (zone === 'night') {
                                rate = useShield && tariffs.G12w.rates.nightShield !== undefined ? tariffs.G12w.rates.nightShield : tariffs.G12w.rates.night || 0;
                            }
                            return rate + getTotalSystemCharges(hour);
                        }) : [],
                        borderColor: '#2ecc71',
                        backgroundColor: '#2ecc7120',
                        borderWidth: 2,
                        stepped: true
                    },
                    {
                        label: 'G12r (szczyt/pozaszczyt) - całkowity koszt',
                        data: tariffs.G12r.zones ? tariffs.G12r.zones.map((zone, hour) => {
                            if (!zone || !tariffs.G12r.rates) return 0;
                            let rate = 0;
                            if (zone === 'peak') {
                                rate = useShield && tariffs.G12r.rates.peakShield !== undefined ? tariffs.G12r.rates.peakShield : tariffs.G12r.rates.peak || 0;
                            } else if (zone === 'offpeak') {
                                rate = useShield && tariffs.G12r.rates.offpeakShield !== undefined ? tariffs.G12r.rates.offpeakShield : tariffs.G12r.rates.offpeak || 0;
                            }
                            return rate + getTotalSystemCharges(hour);
                        }) : [],
                        borderColor: '#f39c12',
                        backgroundColor: '#f39c1220',
                        borderWidth: 2,
                        stepped: true
                    }
                ];
                
                // Dodaj G11f jeśli są ceny spot
                if (spotPrices && spotPrices.length > 0) {
                    const eurPln = parseFloat(document.getElementById('eur-pln-rate').value) || currentExchangeRate || 4.30;
                    const margin = parseFloat(document.getElementById('g11f-margin').value) || 0.05;
                    const baseRate = tariffs.G11f ? tariffs.G11f.baseRate : 0.0516; // Stały składnik zmienny
                    
                    const dynamicPrices = spotPrices.map((price, hour) => {
                        if (price === null || price === undefined || isNaN(price)) return 0;
                        const spotPriceInPLN = price * eurPln / 1000; // €/MWh -> zł/kWh
                        return spotPriceInPLN + baseRate + margin + getTotalSystemCharges(hour); // spot + stały składnik + marża + wszystkie opłaty
                    });
                    
                    datasets.push({
                        label: 'G11f (dynamiczna) - całkowity koszt',
                        data: dynamicPrices,
                        borderColor: '#9b59b6',
                        backgroundColor: '#9b59b620',
                        borderWidth: 3
                    });
                }
                
                hourlyChart = new Chart(ctx1, {
                    type: 'line',
                    data: { labels: hours, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: textColor
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            y: {
                                beginAtZero: true,
                                title: { 
                                    display: true, 
                                    text: 'Całkowity koszt (zł/kWh) - dystrybucja + wszystkie opłaty',
                                    color: textColor
                                },
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        }
                    }
                });
                
                // Wykres profilu vs koszt
                const profileToShow = useWeeklyProfiles ? getAverageWeeklyProfile() : currentProfile;
                
                costChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: hours,
                        datasets: [{
                            label: 'Profil zużycia (%)',
                            data: profileToShow || new Array(24).fill(100/24),
                            backgroundColor: 'rgba(39, 174, 96, 0.5)',
                            borderColor: '#27ae60',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: textColor
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            y: {
                                beginAtZero: true,
                                title: { 
                                    display: true, 
                                    text: 'Zużycie (% dobowego)',
                                    color: textColor
                                },
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Błąd podczas tworzenia wykresów:', error);
            }
        }
        
        function setUsageProfile(profileName, element) {
            // Kompatybilność z starymi przyciskami - przekieruj do nowego systemu
            setMainProfile(profileName);
            
            // Zaktualizuj select
            const mainSelect = document.getElementById('main-profile-select');
            if (mainSelect) {
                mainSelect.value = profileName;
            }
        }
        
        function setupEventListeners() {
            const monthlyUsage = document.getElementById('monthly-usage');
            if (monthlyUsage) {
                monthlyUsage.addEventListener('input', calculateCostsAndUpdate);
            }
            
            const annualUsage = document.getElementById('annual-usage');
            if (annualUsage) {
                annualUsage.addEventListener('input', calculateCostsAndUpdate);
            }
            
            const installationType = document.getElementById('installation-type');
            if (installationType) {
                installationType.addEventListener('change', calculateCostsAndUpdate);
            }
            
            const eurPlnRate = document.getElementById('eur-pln-rate');
            if (eurPlnRate) {
                eurPlnRate.addEventListener('input', () => {
                    updateSpotPricesDisplay();
                    calculateCostsAndUpdate();
                });
            }
            
            const g11fMargin = document.getElementById('g11f-margin');
            if (g11fMargin) {
                g11fMargin.addEventListener('input', () => {
                    renderHourlyTariffs();
                    calculateCostsAndUpdate();
                });
            }
            
            // Obsługa zmiany typu analizy
            const analysisType = document.getElementById('analysis-type');
            if (analysisType) {
                analysisType.addEventListener('change', function() {
                    const analysisTypeValue = this.value;
                    const singleDateGroup = document.getElementById('single-date-group');
                    const dateRangeGroup = document.getElementById('date-range-group');
                    const dateRangeGroupTo = document.getElementById('date-range-group-to');
                    
                    // Ukryj/pokaż odpowiednie pola
                    if (analysisTypeValue === 'date-range') {
                        if (singleDateGroup) singleDateGroup.style.display = 'none';
                        if (dateRangeGroup) dateRangeGroup.style.display = 'flex';
                        if (dateRangeGroupTo) dateRangeGroupTo.style.display = 'flex';
                    } else {
                        if (singleDateGroup) singleDateGroup.style.display = 'flex';
                        if (dateRangeGroup) dateRangeGroup.style.display = 'none';
                        if (dateRangeGroupTo) dateRangeGroupTo.style.display = 'none';
                        
                        // Zaktualizuj etykietę dla różnych typów analiz
                        const label = singleDateGroup ? singleDateGroup.querySelector('label') : null;
                        if (label) {
                            switch (analysisTypeValue) {
                                case 'week-analysis':
                                    label.textContent = 'Tydzień zawierający datę:';
                                    break;
                                case 'month-analysis':
                                    label.textContent = 'Miesiąc zawierający datę:';
                                    break;
                                default:
                                    label.textContent = 'Data analizy:';
                                    break;
                            }
                        }
                    }
                    
                    // Auto-fetch jeśli włączone
                    const autoFetch = document.getElementById('auto-fetch');
                    if (autoFetch && autoFetch.checked) {
                        console.log('🔄 Auto-fetch: zmiana typu analizy');
                        setTimeout(handleFetchSpotPrices, 500);
                    }
                });
            }
            
            // Auto-fetch przy zmianie dat - TYLKO jeśli checkbox jest włączony
            const dateSelect = document.getElementById('date-select');
            if (dateSelect) {
                dateSelect.addEventListener('change', () => {
                    const autoFetch = document.getElementById('auto-fetch');
                    if (autoFetch && autoFetch.checked) {
                        console.log('🔄 Auto-fetch: zmiana daty pojedynczej');
                        setTimeout(handleFetchSpotPrices, 500);
                    }
                });
            }
            
            const dateFrom = document.getElementById('date-from');
            if (dateFrom) {
                dateFrom.addEventListener('change', () => {
                    const autoFetch = document.getElementById('auto-fetch');
                    const dateTo = document.getElementById('date-to');
                    if (autoFetch && autoFetch.checked && dateTo && dateTo.value) {
                        console.log('🔄 Auto-fetch: zmiana daty początkowej');
                        setTimeout(handleFetchSpotPrices, 500);
                    }
                });
            }
            
            const dateTo = document.getElementById('date-to');
            if (dateTo) {
                dateTo.addEventListener('change', () => {
                    const autoFetch = document.getElementById('auto-fetch');
                    const dateFromEl = document.getElementById('date-from');
                    if (autoFetch && autoFetch.checked && dateFromEl && dateFromEl.value) {
                        console.log('🔄 Auto-fetch: zmiana daty końcowej');
                        setTimeout(handleFetchSpotPrices, 500);
                    }
                });
            }
        }
        
        // === FUNKCJE ZAAWANSOWANYCH PROFILI ===
        
        function toggleAdvanced() {
            const section = document.getElementById('advanced-section');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                initializeAdvancedProfiles();
                // Smooth scroll to advanced section
                section.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                section.style.display = 'none';
            }
        }
        
        function initializeAdvancedProfiles() {
            // Inicjalizuj edytor godzinowy
            const container = document.getElementById('hour-sliders');
            container.innerHTML = '';
            
            // Nowy graficzny interfejs profili
            container.innerHTML = `
                <div class="profile-visualizer">
                    <canvas id="profileChart" width="800" height="200" style="max-width: 100%; border-radius: 10px;"></canvas>
                    <div style="text-align: center; margin-top: 10px; font-size: 0.8rem; color: var(--text-secondary);">
                        📊 Podgląd profilu zużycia w ciągu doby
                    </div>
                </div>
                <div class="hour-sliders-grid">
                    ${Array.from({length: 24}, (_, hour) => `
                        <div class="hour-slider-container">
                            <div class="hour-label">${hour}h</div>
                            <input type="range" class="hour-slider" id="slider-${hour}" 
                                   min="0" max="20" step="0.1" value="${currentProfile[hour].toFixed(1)}"
                                   oninput="updateHourValueSlider(${hour}, this.value)"
                                   orient="vertical">
                            <input type="number" class="hour-input-small" id="hour-${hour}" 
                                   min="0" max="50" step="0.1" value="${currentProfile[hour].toFixed(1)}"
                                   onchange="updateHourValue(${hour}, this.value)">
                            <div class="hour-percentage" id="percentage-${hour}">${currentProfile[hour].toFixed(1)}%</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Inicjalizuj wykres profilu
            setTimeout(() => initializeProfileChart(), 100);
        }
        
        function selectDay(day) {
            // Aktualizuj aktywny tab
            document.querySelectorAll('.day-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-day="${day}"]`).classList.add('active');
            
            selectedDay = day;
            
            // Aktualizuj tytuł
            const dayNames = {
                'all': 'Wszystkie dni',
                'monday': 'Poniedziałek',
                'tuesday': 'Wtorek', 
                'wednesday': 'Środa',
                'thursday': 'Czwartek',
                'friday': 'Piątek',
                'saturday': 'Sobota',
                'sunday': 'Niedziela'
            };
            
            document.getElementById('editor-title').textContent = `Edycja profilu: ${dayNames[day]}`;
            
            // Załaduj profil dla wybranego dnia
            const profileToLoad = day === 'all' ? currentProfile : weeklyProfiles[day];
            
            for (let hour = 0; hour < 24; hour++) {
                const input = document.getElementById(`hour-${hour}`);
                const slider = document.getElementById(`slider-${hour}`);
                const percentageLabel = document.getElementById(`percentage-${hour}`);
                
                if (input) input.value = profileToLoad[hour].toFixed(1);
                if (slider) slider.value = profileToLoad[hour].toFixed(1);
                if (percentageLabel) percentageLabel.textContent = profileToLoad[hour].toFixed(1) + '%';
            }
            
            // Odśwież wykres profilu
            updateProfileChart();
        }
        
        // Funkcja obsługująca przesuwniki
        function updateHourValueSlider(hour, value) {
            const numValue = parseFloat(value) || 0;
            
            // Aktualizuj input number i label
            const numberInput = document.getElementById(`hour-${hour}`);
            const percentageLabel = document.getElementById(`percentage-${hour}`);
            
            if (numberInput) numberInput.value = numValue.toFixed(1);
            if (percentageLabel) percentageLabel.textContent = numValue.toFixed(1) + '%';
            
            // Aktualizuj profil
            if (selectedDay === 'all') {
                currentProfile[hour] = numValue;
                Object.keys(weeklyProfiles).forEach(day => {
                    weeklyProfiles[day][hour] = numValue;
                });
            } else {
                weeklyProfiles[selectedDay][hour] = numValue;
                useWeeklyProfiles = true;
            }
            
            // Odśwież wykres profilu
            updateProfileChart();
            
            // Przelicz koszty
            calculateCostsAndUpdate();
        }
        
        // Funkcja inicjalizująca wykres profilu
        let profileChart = null;
        
        function initializeProfileChart() {
            const canvas = document.getElementById('profileChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Wyczyść canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            updateProfileChart();
        }
        
        function updateProfileChart() {
            const canvas = document.getElementById('profileChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Wyczyść canvas
            ctx.clearRect(0, 0, width, height);
            
            const profileToShow = selectedDay === 'all' ? currentProfile : weeklyProfiles[selectedDay];
            const maxValue = Math.max(...profileToShow, 10);
            
            // Kolory gradientu
            const gradient = ctx.createLinearGradient(0, height, 0, 0);
            gradient.addColorStop(0, '#27ae60');
            gradient.addColorStop(0.5, '#f39c12');
            gradient.addColorStop(1, '#e74c3c');
            
            // Rysuj słupki
            const barWidth = width / 24;
            
            profileToShow.forEach((value, hour) => {
                const barHeight = (value / maxValue) * (height - 40);
                const x = hour * barWidth;
                const y = height - barHeight - 20;
                
                // Słupek
                ctx.fillStyle = gradient;
                ctx.fillRect(x + 2, y, barWidth - 4, barHeight);
                
                // Etykieta godziny
                ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-secondary');
                ctx.font = '10px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(hour + 'h', x + barWidth/2, height - 5);
                
                // Wartość
                if (value > 0.5) {
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 9px -apple-system, BlinkMacSystemFont, sans-serif';
                    ctx.fillText(value.toFixed(1), x + barWidth/2, y + 12);
                }
            });
            
            // Siatka pomocnicza
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--border-color');
            ctx.lineWidth = 1;
            ctx.setLineDash([2, 2]);
            
            for (let i = 1; i <= 4; i++) {
                const y = height - 20 - (i * (height - 40) / 4);
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
                
                // Etykieta wartości
                ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-secondary');
                ctx.font = '9px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText((maxValue * i / 4).toFixed(1) + '%', 5, y - 3);
            }
        }
        
        function updateHourValue(hour, value) {
            const numValue = parseFloat(value) || 0;
            
            // Aktualizuj slider i label
            const slider = document.getElementById(`slider-${hour}`);
            const percentageLabel = document.getElementById(`percentage-${hour}`);
            
            if (slider) slider.value = numValue;
            if (percentageLabel) percentageLabel.textContent = numValue.toFixed(1) + '%';
            
            if (selectedDay === 'all') {
                currentProfile[hour] = numValue;
                // Aktualizuj także wszystkie dni tygodnia
                Object.keys(weeklyProfiles).forEach(day => {
                    weeklyProfiles[day][hour] = numValue;
                });
            } else {
                weeklyProfiles[selectedDay][hour] = numValue;
                useWeeklyProfiles = true;
            }
            
            // Odśwież wykres profilu
            updateProfileChart();
            
            // Przelicz koszty
            calculateCostsAndUpdate();
        }
        
        function applyPreset(presetName) {
            if (!usageProfiles[presetName]) return;
            
            const preset = [...usageProfiles[presetName]];
            
            if (selectedDay === 'all') {
                currentProfile = [...preset];
                // Aktualizuj wszystkie dni
                Object.keys(weeklyProfiles).forEach(day => {
                    weeklyProfiles[day] = [...preset];
                });
                useWeeklyProfiles = false;
            } else {
                weeklyProfiles[selectedDay] = [...preset];
                useWeeklyProfiles = true;
            }
            
            // Apply seasonal adjustments if needed
            if (currentSeason !== 'all') {
                applySeasonalAdjustments();
            }
            
            // Aktualizuj UI
            for (let hour = 0; hour < 24; hour++) {
                const input = document.getElementById(`hour-${hour}`);
                if (input) {
                    input.value = preset[hour].toFixed(1);
                }
            }
            
            calculateCostsAndUpdate();
        }
        
        function resetCurrentDay() {
            applyPreset('standard');
        }
        
        function copyToAllDays() {
            if (selectedDay === 'all') return;
            
            const profileToCopy = [...weeklyProfiles[selectedDay]];
            
            Object.keys(weeklyProfiles).forEach(day => {
                weeklyProfiles[day] = [...profileToCopy];
            });
            
            currentProfile = [...profileToCopy];
            
            alert(`Profil z ${selectedDay} skopiowany na wszystkie dni tygodnia.`);
            calculateCostsAndUpdate();
        }
        
        function saveCustomProfile() {
            const profileData = selectedDay === 'all' ? 
                { type: 'single', data: [...currentProfile] } : 
                { type: 'weekly', data: JSON.parse(JSON.stringify(weeklyProfiles)) };
                
            const profileName = prompt('Nazwa profilu:', `Mój profil ${selectedDay === 'all' ? 'standardowy' : 'tygodniowy'}`);
            
            if (profileName) {
                // Zapisz w localStorage
                const savedProfiles = JSON.parse(localStorage.getItem('customProfiles') || '{}');
                savedProfiles[profileName] = {
                    ...profileData,
                    created: new Date().toISOString(),
                    description: selectedDay === 'all' ? 'Profil jednodniowy' : 'Profil tygodniowy z różnymi dniami'
                };
                localStorage.setItem('customProfiles', JSON.stringify(savedProfiles));
                
                updateProfilesList();
                alert(`✅ Profil "${profileName}" został zapisany!`);
            }
        }
        
        function loadCustomProfile(profileName) {
            const savedProfiles = JSON.parse(localStorage.getItem('customProfiles') || '{}');
            const profile = savedProfiles[profileName];
            
            if (!profile) {
                alert('❌ Nie znaleziono profilu');
                return;
            }
            
            if (profile.type === 'single') {
                currentProfile = [...profile.data];
                selectedDay = 'all';
                useWeeklyProfiles = false;
                // Aktualizuj wszystkie dni tygodnia
                Object.keys(weeklyProfiles).forEach(day => {
                    weeklyProfiles[day] = [...profile.data];
                });
            } else if (profile.type === 'weekly') {
                weeklyProfiles = JSON.parse(JSON.stringify(profile.data));
                useWeeklyProfiles = true;
            }
            
            // Odśwież interfejs
            selectDay(selectedDay);
            calculateCostsAndUpdate();
            alert(`✅ Załadowano profil "${profileName}"`);
        }
        
        function deleteCustomProfile(profileName) {
            if (confirm(`Czy na pewno chcesz usunąć profil "${profileName}"?`)) {
                const savedProfiles = JSON.parse(localStorage.getItem('customProfiles') || '{}');
                delete savedProfiles[profileName];
                localStorage.setItem('customProfiles', JSON.stringify(savedProfiles));
                updateProfilesList();
                alert(`✅ Profil "${profileName}" został usunięty`);
            }
        }
        
        function updateProfilesList() {
            const container = document.getElementById('saved-profiles-list');
            if (!container) return;
            
            const savedProfiles = JSON.parse(localStorage.getItem('customProfiles') || '{}');
            const profileNames = Object.keys(savedProfiles);
            
            if (profileNames.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-style: italic; text-align: center; padding: 20px;">Brak zapisanych profili</div>';
                return;
            }
            
            container.innerHTML = profileNames.map(name => {
                const profile = savedProfiles[name];
                const date = new Date(profile.created).toLocaleDateString('pl-PL');
                return `
                    <div class="saved-profile-item">
                        <div class="profile-info">
                            <div class="profile-name">${name}</div>
                            <div class="profile-meta">${profile.description} • ${date}</div>
                        </div>
                        <div class="profile-actions">
                            <button onclick="loadCustomProfile('${name}')" class="glass-button secondary">📂 Załaduj</button>
                            <button onclick="deleteCustomProfile('${name}')" class="glass-button secondary">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getAverageWeeklyProfile() {
            try {
                // Oblicz średni profil tygodniowy (5 dni roboczych + 2 dni weekend)
                const avgProfile = new Array(24).fill(0);
                
                for (let hour = 0; hour < 24; hour++) {
                    let total = 0;
                    let count = 0;
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                    
                    days.forEach(day => {
                        if (weeklyProfiles[day] && weeklyProfiles[day][hour] !== undefined) {
                            total += weeklyProfiles[day][hour];
                            count++;
                        }
                    });
                    
                    avgProfile[hour] = count > 0 ? total / count : 100/24;
                }
                
                return avgProfile;
            } catch (error) {
                console.error('Błąd podczas obliczania średniego profilu tygodniowego:', error);
                return new Array(24).fill(100/24);
            }
        }
        
        // Funkcja toggle dla zarządzania profilami
        function toggleProfilesManager() {
            const manager = document.getElementById('profiles-manager');
            const comparison = document.getElementById('profile-comparison');
            
            if (manager.style.display === 'none') {
                manager.style.display = 'block';
                comparison.style.display = 'none';
                updateProfilesList();
            } else {
                manager.style.display = 'none';
            }
        }
        
        // Funkcja toggle dla porównania profili
        function toggleProfileComparison() {
            const comparison = document.getElementById('profile-comparison');
            const manager = document.getElementById('profiles-manager');
            
            if (comparison.style.display === 'none') {
                comparison.style.display = 'block';
                manager.style.display = 'none';
                updateComparisonProfiles();
            } else {
                comparison.style.display = 'none';
            }
        }
        
        // Aktualizuj listę profili do porównania
        function updateComparisonProfiles() {
            const profileBSelect = document.getElementById('profile-b-select');
            const savedProfiles = JSON.parse(localStorage.getItem('customProfiles') || '{}');
            
            console.log('🔍 updateComparisonProfiles:', {
                profileSelectFound: !!profileBSelect,
                savedProfilesCount: Object.keys(savedProfiles).length,
                savedProfiles
            });
            
            if (!profileBSelect) {
                console.error('❌ Nie znaleziono profile-b-select');
                return;
            }
            
            // Wyczyść opcje
            profileBSelect.innerHTML = '<option value="">Wybierz profil...</option>';
            
            // Dodaj predefiniowane profile
            Object.keys(usageProfiles).forEach(key => {
                const option = document.createElement('option');
                option.value = `preset_${key}`;
                option.textContent = `Wzorzec: ${key.charAt(0).toUpperCase() + key.slice(1)}`;
                profileBSelect.appendChild(option);
            });
            
            // Dodaj zapisane profile
            Object.keys(savedProfiles).forEach(name => {
                const option = document.createElement('option');
                option.value = `saved_${name}`;
                option.textContent = `Zapisany: ${name}`;
                profileBSelect.appendChild(option);
            });
        }
        
        // Funkcja porównania profili
        function compareProfiles() {
            const profileASelect = document.getElementById('profile-a-select').value;
            const profileBSelect = document.getElementById('profile-b-select').value;
            const resultsDiv = document.getElementById('comparison-results');
            
            if (!profileBSelect) {
                alert('Wybierz profil do porównania');
                return;
            }
            
            // Pobierz profile
            let profileA = selectedDay === 'all' ? currentProfile : getAverageWeeklyProfile();
            let profileB;
            
            if (profileBSelect.startsWith('preset_')) {
                const presetName = profileBSelect.replace('preset_', '');
                profileB = [...usageProfiles[presetName]];
            } else if (profileBSelect.startsWith('saved_')) {
                const savedName = profileBSelect.replace('saved_', '');
                const savedProfiles = JSON.parse(localStorage.getItem('customProfiles') || '{}');
                const savedProfile = savedProfiles[savedName];
                
                if (!savedProfile) {
                    alert('Nie znaleziono zapisanego profilu');
                    return;
                }
                
                profileB = savedProfile.type === 'single' ? 
                    [...savedProfile.data] : 
                    calculateAverageProfile(savedProfile.data);
            }
            
            // Oblicz koszty dla obu profili
            const monthlyUsage = parseFloat(document.getElementById('monthly-usage').value) || 300;
            const annualUsage = parseFloat(document.getElementById('annual-usage').value) || 3600;
            const installationTypeElement = document.getElementById('installation-type');
            const installationType = installationTypeElement ? installationTypeElement.value : '3-phase';
            
            const resultsA = calculateAllTariffCosts(profileA, monthlyUsage, annualUsage, installationType);
            const resultsB = calculateAllTariffCosts(profileB, monthlyUsage, annualUsage, installationType);
            
            // Znajdź najlepsze opcje
            const bestA = resultsA.reduce((min, current) => current.totalCost < min.totalCost ? current : min);
            const bestB = resultsB.reduce((min, current) => current.totalCost < min.totalCost ? current : min);
            
            // Wyświetl wyniki
            displayComparisonResults(resultsA, resultsB, bestA, bestB, profileASelect, profileBSelect);
        }
        
        // Pomocnicza funkcja obliczania średniego profilu z profili tygodniowych
        function calculateAverageProfile(weeklyProfiles) {
            const avgProfile = new Array(24).fill(0);
            const days = Object.keys(weeklyProfiles);
            
            for (let hour = 0; hour < 24; hour++) {
                let total = 0;
                days.forEach(day => {
                    total += weeklyProfiles[day][hour] || 0;
                });
                avgProfile[hour] = total / days.length;
            }
            
            return avgProfile;
        }
        
        // Funkcja obliczania kosztów dla wszystkich taryf
        function calculateAllTariffCosts(profile, monthlyUsage, annualUsage, installationType) {
            console.log('🔍 calculateAllTariffCosts called:', {
                profileLength: profile?.length,
                monthlyUsage,
                annualUsage,
                installationType,
                spotPricesCount: spotPrices?.length || 0,
                tariffsCount: Object.keys(tariffs).length
            });
            
            const tempCurrentProfile = [...currentProfile];
            const tempUseWeeklyProfiles = useWeeklyProfiles;
            
            // Tymczasowo ustaw profil
            currentProfile = [...profile];
            useWeeklyProfiles = false;
            
            const results = [];
            Object.keys(tariffs).forEach(tariffId => {
                const result = calculateTariffCost(tariffId, monthlyUsage, annualUsage, installationType);
                if (result) {
                    // Konwertuj strukturę na format kompatybilny z głównymi wynikami
                    const tariffName = tariffs[tariffId].name || tariffId;
                    results.push({
                        id: tariffId,
                        name: tariffName,
                        totalCost: result.total,
                        variableCost: result.variable,
                        fixedCost: result.fixed,
                        dailyCost: result.total / 30
                    });
                }
            });
            
            // Przywróć oryginalny profil
            currentProfile = [...tempCurrentProfile];
            useWeeklyProfiles = tempUseWeeklyProfiles;
            
            return results.sort((a, b) => a.totalCost - b.totalCost);
        }
        
        // Wyświetl wyniki porównania
        function displayComparisonResults(resultsA, resultsB, bestA, bestB, profileAName, profileBName) {
            const resultsDiv = document.getElementById('comparison-results');
            
            const savings = bestA.totalCost - bestB.totalCost;
            const savingsPercent = ((savings / bestA.totalCost) * 100);
            
            let summaryText = '';
            if (savings > 0) {
                summaryText = `<div class="savings-positive">✅ Profil B jest tańszy o ${Math.abs(savings).toFixed(2)} zł miesięcznie (${Math.abs(savingsPercent).toFixed(1)}%)</div>`;
            } else if (savings < 0) {
                summaryText = `<div class="savings-negative">❌ Profil A jest tańszy o ${Math.abs(savings).toFixed(2)} zł miesięcznie (${Math.abs(savingsPercent).toFixed(1)}%)</div>`;
            } else {
                summaryText = `<div>⚖️ Oba profile mają podobne koszty</div>`;
            }
            
            resultsDiv.innerHTML = `
                <h5>📊 Najlepsze taryfy dla każdego profilu:</h5>
                ${summaryText}
                
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Taryfa</th>
                            <th>Profil A (obecny)</th>
                            <th>Profil B</th>
                            <th>Różnica</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${resultsA.slice(0, 5).map((resultA, index) => {
                            const resultB = resultsB.find(r => r.id === resultA.id);
                            if (!resultB) return '';
                            
                            const diff = resultA.totalCost - resultB.totalCost;
                            const diffClass = diff > 0 ? 'savings-negative' : diff < 0 ? 'savings-positive' : '';
                            
                            return `
                                <tr>
                                    <td><strong>${resultA.id}</strong></td>
                                    <td>${resultA.totalCost.toFixed(2)} zł</td>
                                    <td>${resultB.totalCost.toFixed(2)} zł</td>
                                    <td class="${diffClass}">${diff > 0 ? '+' : ''}${diff.toFixed(2)} zł</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Funkcje obsługi dwóch profili
        function getProfileDisplayName(profile) {
            // Znajdź nazwę profilu na podstawie jego danych
            for (const [name, data] of Object.entries(usageProfiles)) {
                if (JSON.stringify(data) === JSON.stringify(profile)) {
                    // Tłumaczenie nazw profili na polskie
                    const polishNames = {
                        'standard': 'Standard',
                        'morning': 'Poranny', 
                        'evening': 'Wieczorny',
                        'night': 'Nocny',
                        'flexible': 'Elastyczny G12',
                        'flexibleW': 'Elastyczny G12w',
                        'homeoffice': 'Home Office',
                        'ev_charging': 'Ładowanie EV',
                        'heat_pump': 'Pompa ciepła'
                    };
                    return polishNames[name] || name;
                }
            }
            
            // Sprawdź zapisane profile
            const savedProfiles = JSON.parse(localStorage.getItem('customProfiles') || '{}');
            for (const [name, data] of Object.entries(savedProfiles)) {
                if (JSON.stringify(data) === JSON.stringify(profile)) {
                    return `Zapisany: ${name}`;
                }
            }
            
            return 'Profil niestandardowy';
        }
        
        function setMainProfile(profileName) {
            if (usageProfiles[profileName]) {
                currentProfile = [...usageProfiles[profileName]];
                
                // Apply seasonal adjustments
                applySeasonalAdjustments();
                
                // Zaktualizuj wykresy
                createCharts();
                
                // Przelicz i aktualizuj
                calculateCostsAndUpdate();
            }
        }
        
        function setComparisonProfile(profileName) {
            console.log('🔍 setComparisonProfile:', profileName);
            
            if (profileName === '') {
                comparisonProfile = null;
                document.getElementById('enable-comparison').checked = false;
                isDualProfileMode = false;
                console.log('📴 Wyczyszczono profil porównania');
            } else {
                // Parsuj wartość z dropdown
                if (profileName.startsWith('preset_')) {
                    const actualProfileName = profileName.replace('preset_', '');
                    if (usageProfiles[actualProfileName]) {
                        comparisonProfile = [...usageProfiles[actualProfileName]];
                        document.getElementById('enable-comparison').checked = true;
                        isDualProfileMode = true;
                        console.log('✅ Ustawiono profil porównania (preset):', actualProfileName);
                    }
                } else if (profileName.startsWith('saved_')) {
                    const actualProfileName = profileName.replace('saved_', '');
                    const savedProfiles = JSON.parse(localStorage.getItem('customProfiles') || '{}');
                    if (savedProfiles[actualProfileName]) {
                        comparisonProfile = [...savedProfiles[actualProfileName]];
                        document.getElementById('enable-comparison').checked = true;
                        isDualProfileMode = true;
                        console.log('✅ Ustawiono profil porównania (saved):', actualProfileName);
                    }
                } else if (usageProfiles[profileName]) {
                    // Dla kompatybilności wstecznej
                    comparisonProfile = [...usageProfiles[profileName]];
                    document.getElementById('enable-comparison').checked = true;
                    isDualProfileMode = true;
                    console.log('✅ Ustawiono profil porównania (legacy):', profileName);
                }
            }
            
            // Zaktualizuj wykresy
            createCharts();
            
            // Przelicz i aktualizuj
            calculateCostsAndUpdate();
        }
        
        function toggleDualProfileMode() {
            const checkbox = document.getElementById('enable-comparison');
            const comparisonSelect = document.getElementById('profile-b-select');
            
            console.log('🔄 toggleDualProfileMode:', {
                checked: checkbox.checked,
                comparisonSelectValue: comparisonSelect?.value,
                comparisonSelectFound: !!comparisonSelect
            });
            
            isDualProfileMode = checkbox.checked;
            
            if (!isDualProfileMode) {
                comparisonProfile = null;
                if (comparisonSelect) comparisonSelect.value = '';
                console.log('📴 Wyłączono porównanie');
            } else if (comparisonSelect && comparisonSelect.value) {
                // Parsuj wartość z dropdown
                const selectedValue = comparisonSelect.value;
                if (selectedValue.startsWith('preset_')) {
                    const profileName = selectedValue.replace('preset_', '');
                    if (usageProfiles[profileName]) {
                        comparisonProfile = [...usageProfiles[profileName]];
                        console.log('✅ Ustawiono profil porównania (preset):', profileName);
                    }
                } else if (selectedValue.startsWith('saved_')) {
                    const profileName = selectedValue.replace('saved_', '');
                    const savedProfiles = JSON.parse(localStorage.getItem('customProfiles') || '{}');
                    if (savedProfiles[profileName]) {
                        comparisonProfile = [...savedProfiles[profileName]];
                        console.log('✅ Ustawiono profil porównania (saved):', profileName);
                    }
                }
            } else {
                console.log('⚠️ Brak wybranego profilu do porównania');
            }
            
            // Zaktualizuj wykresy
            createCharts();
            
            // Przelicz i aktualizuj
            calculateCostsAndUpdate();
        }
        
        
        // Funkcja pobierania kursu EUR/PLN
        async function fetchEuroRate() {
            try {
                console.log('💱 Pobieranie kursu EUR/PLN...');
                
                // Użyj NBP API dla kursu EUR/PLN
                const response = await fetch('https://api.nbp.pl/api/exchangerates/rates/a/eur/?format=json');
                
                if (!response.ok) {
                    throw new Error(`NBP API error: ${response.status}`);
                }
                
                const data = await response.json();
                const rate = data.rates[0].mid;
                
                // Aktualizuj pole kursu
                const eurPlnInput = document.getElementById('eur-pln-rate');
                if (eurPlnInput) {
                    eurPlnInput.value = rate.toFixed(4);
                    console.log(`✅ Pobrano kurs EUR/PLN: ${rate.toFixed(4)}`);
                    
                    // Przelicz koszty jeśli są dane spot
                    if (spotPrices) {
                        calculateCostsAndUpdate();
                    }
                    
                    alert(`✅ Pobrano aktualny kurs EUR/PLN: ${rate.toFixed(4)}`);
                } else {
                    console.error('❌ Nie znaleziono pola eur-pln-rate');
                }
                
            } catch (error) {
                console.error('❌ Błąd pobierania kursu EUR:', error);
                alert('❌ Nie udało się pobrać kursu EUR/PLN z NBP. Używam domyślnej wartości.');
            }
        }
        
        // Dodatkowe funkcje UX
        function clearSpotData() {
            if (confirm('Czy na pewno chcesz wyczyścić dane spot?')) {
                spotPrices = null;
                spotPricesRange = [];
                
                const statusDiv = document.getElementById('api-status');
                if (statusDiv) {
                    statusDiv.className = 'api-status glass-card';
                    statusDiv.innerHTML = `<strong>🔌 API ENTSO-E:</strong> Kliknij "Pobierz ceny spot" aby pobrać rzeczywiste ceny energii<br>
                        <small>💡 <strong>Ważne:</strong> ENTSO-E ma dane tylko z przeszłości (maksymalnie do wczoraj)</small>`;
                }
                
                calculateCostsAndUpdate();
                alert('✅ Dane spot zostały wyczyszczone');
            }
        }
        
        function exportResults() {
            try {
                const results = Array.from(document.querySelectorAll('.summary-card')).map(card => {
                    const value = card.querySelector('.summary-value')?.textContent || '';
                    const label = card.querySelector('.summary-label')?.textContent || '';
                    return { taryfa: label, koszt: value };
                });
                
                const monthlyUsage = document.getElementById('monthly-usage')?.value || 0;
                const exportData = {
                    data_eksportu: new Date().toLocaleString('pl-PL'),
                    zuzycie_miesieczne: monthlyUsage + ' kWh',
                    profil_sezonowy: currentSeason,
                    ma_dane_spot: !!spotPrices,
                    wyniki_porownania: results,
                    profil_zuzycia: currentProfile
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `kalkulator_taryf_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                alert('✅ Wyniki zostały wyeksportowane do pliku JSON');
            } catch (error) {
                console.error('Błąd eksportu:', error);
                alert('❌ Błąd podczas eksportu danych');
            }
        }
        
        // Dodaj przycisk eksportu do interfejsu
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const statusDiv = document.getElementById('api-status');
                if (statusDiv && !document.getElementById('export-btn')) {
                    const exportBtn = document.createElement('button');
                    exportBtn.id = 'export-btn';
                    exportBtn.className = 'glass-button secondary';
                    exportBtn.innerHTML = '📤 Eksportuj wyniki';
                    exportBtn.onclick = exportResults;
                    exportBtn.style.cssText = 'float: right; margin: 10px 0;';
                    
                    statusDiv.parentNode.insertBefore(exportBtn, statusDiv.nextSibling);
                }
            }, 2000);
        });
    </script>
</body>
</html>
