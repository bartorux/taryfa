<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator taryf energii - rzeczywiste ceny ENTSO-E</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Light theme colors */
            --bg-gradient-1: #667eea;
            --bg-gradient-2: #764ba2;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e8f4f8;
            --text-primary: #2c3e50;
            --text-secondary: #666;
            --text-inverse: #ffffff;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --chart-bg: rgba(255, 255, 255, 0.95);
        }
        
        [data-theme="dark"] {
            /* Dark theme colors */
            --bg-gradient-1: #1a1a2e;
            --bg-gradient-2: #16213e;
            --bg-primary: #1e1e2e;
            --bg-secondary: #2a2a3e;
            --bg-tertiary: #35354a;
            --text-primary: #f0f0f0;
            --text-secondary: #b0b0b0;
            --text-inverse: #1e1e2e;
            --border-color: #444466;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --glass-bg: rgba(30, 30, 46, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #5dade2;
            --chart-bg: rgba(30, 30, 46, 0.95);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        /* Theme toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px var(--shadow-color);
        }
        
        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px var(--shadow-color);
        }
        
        .theme-toggle-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
        }
        
        .theme-toggle:hover .theme-toggle-icon {
            transform: rotate(180deg);
        }
        
        /* Glassmorphism container */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 8px 32px var(--shadow-color);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px var(--shadow-color);
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }
        
        h1 {
            text-align: center;
            color: var(--text-inverse);
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: fadeInDown 0.8s ease;
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-inverse);
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.9;
            animation: fadeInUp 0.8s ease 0.2s backwards;
        }
        
        /* Season toggle */
        .season-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease 0.4s backwards;
        }
        
        .season-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 25px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        .season-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow-color);
        }
        
        .season-btn.active {
            background: var(--info);
            color: white;
        }
        
        /* API Status */
        .api-status {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-primary);
            animation: slideIn 0.6s ease 0.6s backwards;
            transition: all 0.3s ease;
        }
        
        .api-status.loading {
            background: rgba(255, 243, 205, 0.8);
            border-color: rgba(255, 234, 167, 0.5);
            color: #856404;
        }
        
        .api-status.error {
            background: rgba(248, 215, 218, 0.8);
            border-color: rgba(245, 198, 203, 0.5);
            color: #721c24;
        }
        
        /* Controls section */
        .controls-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: fadeIn 0.8s ease 0.8s backwards;
            transition: all 0.3s ease;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            animation: fadeInUp 0.6s ease;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        input, select, textarea {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--info);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }
        
        /* Date range controls visibility fix */
        #date-range-group,
        #date-range-group-to {
            transition: all 0.3s ease;
        }
        
        /* Profile section */
        .profile-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            animation: fadeIn 0.6s ease;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .profile-btn {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }
        
        .profile-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--info);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }
        
        .profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .profile-btn.active {
            background: var(--info);
            color: white;
            border-color: var(--info);
        }
        
        /* Buttons */
        .fetch-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .fetch-btn:hover:not(:disabled) {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .fetch-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Charts section */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            background: var(--chart-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: scaleIn 0.8s ease;
            transition: all 0.3s ease;
        }
        
        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px var(--shadow-color);
        }
        
        .chart-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        .chart-wrapper {
            position: relative;
            height: 350px;
        }
        
        /* Summary section */
        .summary-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: fadeInUp 0.8s ease;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .summary-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .summary-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s ease;
        }
        
        .summary-card:hover::before {
            animation: shimmer 0.5s ease;
        }
        
        .summary-card.best {
            background: linear-gradient(135deg, var(--success), #27ae60);
            color: white;
            box-shadow: 0 5px 20px rgba(39, 174, 96, 0.3);
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            animation: countUp 1s ease;
        }
        
        .summary-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Price preview */
        .price-preview {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            animation: fadeIn 0.6s ease;
        }
        
        .prices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }
        
        .price-cell {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .price-cell:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .price-hour {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .price-value {
            font-weight: 600;
        }
        
        /* Hourly analysis */
        .hourly-analysis {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px var(--shadow-color);
            grid-column: 1 / -1;
            animation: fadeInUp 0.8s ease;
        }
        
        .hour-grid {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin-top: 15px;
        }
        
        .hour-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .hour-cell:hover {
            transform: scale(1.2);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* Tarcza toggle */
        .shield-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }
        
        .shield-toggle label {
            margin: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .shield-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* Daily costs section */
        .daily-costs-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px var(--shadow-color);
        }
        
        .daily-costs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .day-cost-card {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .day-cost-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .day-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-primary);
        }
        
        .day-cost {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--info);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }
        
        @keyframes countUp {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .hour-grid {
                grid-template-columns: repeat(12, 1fr);
            }
            
            .theme-toggle {
                top: 10px;
                right: 10px;
            }
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0,0,0,0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Seasonal profiles */
        .seasonal-info {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85rem;
            text-align: center;
            color: var(--text-secondary);
        }
        
        /* Advanced section improvements */
        #advanced-section {
            margin-top: 20px;
            animation: fadeIn 0.6s ease;
        }
        
        .profile-editor {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
        }
        
        .day-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .day-tab {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        
        .day-tab:hover {
            border-color: var(--info);
            transform: translateY(-2px);
            box-shadow: 0 3px 10px var(--shadow-color);
        }
        
        .day-tab.active {
            background: var(--info);
            color: white;
            border-color: var(--info);
        }
        
        /* Legend improvements */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            background: var(--bg-secondary);
            padding: 5px 15px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .legend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px var(--shadow-color);
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <span class="theme-toggle-icon">🌙</span>
        <span class="theme-text">Tryb ciemny</span>
    </button>
    
    <div class="container">
        <h1>⚡ Kalkulator Taryf Energii Elektrycznej</h1>
        <div class="subtitle">Porównanie wszystkich taryf Energa-Operator + rzeczywiste ceny spot ENTSO-E</div>
        
        <!-- Season Toggle -->
        <div class="season-toggle">
            <button class="season-btn active" onclick="setSeason('all', this)">📅 Cały rok</button>
            <button class="season-btn" onclick="setSeason('summer', this)">☀️ Lato</button>
            <button class="season-btn" onclick="setSeason('winter', this)">❄️ Zima</button>
        </div>
        
        <div class="api-status glass-card" id="api-status">
            <strong>🔌 API ENTSO-E:</strong> Kliknij "Pobierz ceny spot" aby pobrać rzeczywiste ceny energii z ENTSO-E Transparency Platform<br>
            <small>💡 <strong>Ważne:</strong> ENTSO-E ma dane tylko z przeszłości (maksymalnie do wczoraj)</small>
        </div>
        
        <!-- Sekcja ENTSO-E API -->
        <div class="controls-section glass-card">
            <h3>🌍 Rzeczywiste ceny energii (ENTSO-E Transparency Platform)</h3>
            <div class="controls-grid">
                <div class="input-group">
                    <label for="analysis-type">
                        Typ analizy:
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">Wybierz sposób analizy cen energii</span>
                        </span>
                    </label>
                    <select id="analysis-type">
                        <option value="single-day">Pojedynczy dzień</option>
                        <option value="date-range">Zakres dat</option>
                        <option value="week-analysis">Analiza tygodniowa</option>
                        <option value="month-analysis">Analiza miesięczna</option>
                    </select>
                </div>
                <div class="input-group" id="single-date-group">
                    <label for="date-select">Data analizy:</label>
                    <input type="date" id="date-select" value="">
                </div>
                <div class="input-group" id="date-range-group" style="display: none;">
                    <label for="date-from">Od:</label>
                    <input type="date" id="date-from" value="">
                </div>
                <div class="input-group" id="date-range-group-to" style="display: none;">
                    <label for="date-to">Do:</label>
                    <input type="date" id="date-to" value="">
                </div>
                <div class="input-group">
                    <label for="eur-pln-rate">
                        Kurs EUR/PLN:
                        <span class="tooltip">✏️
                            <span class="tooltiptext">Możesz edytować ręcznie</span>
                        </span>
                    </label>
                    <input type="number" id="eur-pln-rate" value="4.30" step="0.01" min="3" max="6">
                    <button class="fetch-btn" onclick="updateExchangeRate()" style="margin-top: 5px; padding: 6px 12px; font-size: 0.8rem;">
                        💱 Zaktualizuj kurs EUR/PLN
                    </button>
                </div>
                <div class="input-group">
                    <label for="g11f-margin">
                        Dodatkowa marża G11f (zł/kWh):
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">Marża dodawana do ceny spot przez sprzedawcę</span>
                        </span>
                    </label>
                    <input type="number" id="g11f-margin" value="0.05" step="0.001" min="0" max="0.2">
                </div>
                <div class="input-group">
                    <label>&nbsp;</label>
                    <button class="fetch-btn" onclick="fetchSpotPrices()">
                        📊 Pobierz ceny spot
                    </button>
                    <label class="auto-fetch" style="margin-top: 10px;">
                        <input type="checkbox" id="auto-fetch" checked> Auto-odświeżanie
                    </label>
                </div>
            </div>
            <div class="price-preview" id="price-preview" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>📊 Ceny spot dla Polski:</strong>
                    <div id="price-stats" style="font-size: 0.9rem;"></div>
                </div>
                <div class="prices-grid" id="spot-prices-grid"></div>
                <div class="currency-info" id="currency-info" style="margin-top: 15px; padding: 10px; background: var(--bg-tertiary); border-radius: 10px;"></div>
            </div>
        </div>
        
        <!-- Kontrolki podstawowe -->
        <div class="controls-section glass-card">
            <h3>⚙️ Parametry gospodarstwa</h3>
            
            <!-- Tarcza toggle -->
            <div class="shield-toggle">
                <label>
                    <input type="checkbox" id="shield-toggle" checked onchange="toggleShield()">
                    <strong>🛡️ Tarcza rządowa:</strong> Uwzględnij tymczasowe stawki obowiązujące w 2025 r.
                </label>
                <small style="margin-left: 10px; color: var(--text-secondary);">
                    (bez VAT, zgodnie z ustawą o środkach nadzwyczajnych)
                </small>
            </div>
            
            <div class="controls-grid">
                <div class="input-group">
                    <label for="monthly-usage">Miesięczne zużycie (kWh):</label>
                    <input type="number" id="monthly-usage" value="300" min="0" step="10">
                </div>
                <div class="input-group">
                    <label for="annual-usage">Roczne zużycie (kWh):</label>
                    <input type="number" id="annual-usage" value="3600" min="0" step="100">
                </div>
                <div class="input-group">
                    <label for="installation-type">Typ instalacji:</label>
                    <select id="installation-type">
                        <option value="1-phase">1-fazowa</option>
                        <option value="3-phase" selected>3-fazowa</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>&nbsp;</label>
                    <button class="fetch-btn" onclick="toggleAdvanced()" style="background: var(--text-primary);">
                        ⚙️ Zaawansowane profile
                    </button>
                </div>
            </div>
            
            <div class="profile-section">
                <h4>📈 Profile zużycia energii</h4>
                <div class="seasonal-info" id="seasonal-info" style="display: none;">
                    Profil dostosowany do sezonu: <strong id="current-season">Cały rok</strong>
                </div>
                <div class="profile-grid">
                    <div class="profile-btn active" onclick="setUsageProfile('standard', this)">
                        🏠 Standard<br><small>Równomierne zużycie</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('morning', this)">
                        🌅 Poranny<br><small>Pik 6-9, 17-21</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('evening', this)">
                        🌆 Wieczorny<br><small>Pik 18-23</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('night', this)">
                        🌙 Nocny<br><small>Pik 22-6</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('flexible', this)">
                        🔄 Elastyczny G12<br><small>Dostosowany do G12</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('flexibleW', this)">
                        🔄 Elastyczny G12w<br><small>Dostosowany do G12w</small>
                    </div>
                    <div class="profile-btn" onclick="setUsageProfile('homeoffice', this)">
                        💻 Home Office<br><small>Równomierne 8-18</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Podsumowanie kosztów miesięcznych -->
        <div class="summary-section glass-card">
            <h3>💰 Porównanie miesięcznych kosztów</h3>
            <div class="summary-grid" id="cost-summary">
                <!-- Wypełniane dynamicznie -->
            </div>
        </div>
        
        <!-- Podsumowanie kosztów dobowych -->
        <div class="daily-costs-section glass-card">
            <h3>📅 Średnie koszty dobowe</h3>
            <div class="daily-costs-grid" id="daily-cost-summary">
                <!-- Wypełniane dynamicznie -->
            </div>
        </div>
        
        <!-- Wykresy -->
        <div class="charts-section">
            <div class="chart-container glass-card">
                <div class="chart-title">Stawki w ciągu doby</div>
                <div class="chart-wrapper">
                    <canvas id="hourlyRatesChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container glass-card">
                <div class="chart-title">Profil zużycia vs ceny</div>
                <div class="chart-wrapper">
                    <canvas id="costProfileChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Analiza godzinowa -->
        <div class="hourly-analysis glass-card">
            <div class="chart-title">🕐 Analiza godzinowa taryf</div>
            
            <h4>G11f - Dynamiczna (ceny spot + stały składnik 0,0516 zł/kWh + marża)</h4>
            <div class="hour-label" style="text-align: center; color: var(--text-secondary); margin-bottom: 5px;">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g11f-hours"></div>
            
            <h4 style="margin-top: 20px;">G12 - Dzień/Noc</h4>
            <div class="hour-label" style="text-align: center; color: var(--text-secondary); margin-bottom: 5px;">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g12-hours"></div>
            
            <h4 style="margin-top: 20px;">G12w - Weekendowa (+ całe weekendy w taryfie nocnej)</h4>
            <div class="hour-label" style="text-align: center; color: var(--text-secondary); margin-bottom: 5px;">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g12w-hours"></div>
            
            <h4 style="margin-top: 20px;">G12r - Szczyt/Pozaszczyt</h4>
            <div class="hour-label" style="text-align: center; color: var(--text-secondary); margin-bottom: 5px;">Godziny: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23</div>
            <div class="hour-grid" id="g12r-hours"></div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--danger);"></div>
                    <span>Drożej (dzień/szczyt)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--success);"></div>
                    <span>Taniej (noc/pozaszczyt)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, var(--success), var(--warning), var(--danger));"></div>
                    <span>Dynamiczna (zielony=tanie, czerwony=drogie)</span>
                </div>
            </div>
        </div>
        
        <!-- Sekcja zaawansowana -->
        <div class="controls-section glass-card" id="advanced-section" style="display: none;">
            <h3>🔧 Zaawansowane profile zużycia</h3>
            <p style="margin-bottom: 20px; color: var(--text-secondary);">
                Ustaw różne profile zużycia dla poszczególnych dni tygodnia. 
                Przydatne np. dla ładowania auta elektrycznego tylko w określone dni.
            </p>
            
            <div class="profile-editor">
                <div class="day-tabs">
                    <button class="day-tab active" onclick="selectDay('all')" data-day="all">Wszystkie dni</button>
                    <button class="day-tab" onclick="selectDay('monday')" data-day="monday">Poniedziałek</button>
                    <button class="day-tab" onclick="selectDay('tuesday')" data-day="tuesday">Wtorek</button>
                    <button class="day-tab" onclick="selectDay('wednesday')" data-day="wednesday">Środa</button>
                    <button class="day-tab" onclick="selectDay('thursday')" data-day="thursday">Czwartek</button>
                    <button class="day-tab" onclick="selectDay('friday')" data-day="friday">Piątek</button>
                    <button class="day-tab" onclick="selectDay('saturday')" data-day="saturday">Sobota</button>
                    <button class="day-tab" onclick="selectDay('sunday')" data-day="sunday">Niedziela</button>
                </div>
                
                <div class="profile-controls" style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                    <div class="profile-presets">
                        <h4 style="margin-bottom: 10px;">Gotowe wzorce:</h4>
                        <div class="preset-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('standard')">🏠 Standard</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('morning')">🌅 Poranny</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('evening')">🌆 Wieczorny</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('night')">🌙 Nocny</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('ev_charging')">⚡ Ładowanie EV</button>
                            <button class="fetch-btn" style="background: var(--info);" onclick="applyPreset('heat_pump')">🔥 Pompa ciepła</button>
                        </div>
                    </div>
                    
                    <div class="hourly-editor">
                        <h4 id="editor-title">Edycja profilu: Wszystkie dni</h4>
                        <div class="hour-sliders" id="hour-sliders" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 10px; margin: 20px 0;">
                            <!-- Wypełniane dynamicznie -->
                        </div>
                        <div class="editor-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="fetch-btn" style="background: var(--warning);" onclick="resetCurrentDay()">🔄 Reset dnia</button>
                            <button class="fetch-btn" style="background: #9b59b6;" onclick="copyToAllDays()">📋 Kopiuj na wszystkie dni</button>
                            <button class="fetch-btn" onclick="saveCustomProfile()">💾 Zapisz profil</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Twój token ENTSO-E (będzie używany automatycznie)
        const ENTSO_API_TOKEN = '74e2281c-6281-46b5-8805-7d5b3dc7389b';
        const POLAND_DOMAIN = '10YPL-AREA-----S';
        
        // Theme management
        let currentTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        updateThemeToggle();
        
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeToggle();
            
            // Update charts if they exist
            if (hourlyChart) {
                updateChartTheme(hourlyChart);
            }
            if (costChart) {
                updateChartTheme(costChart);
            }
        }
        
        function updateThemeToggle() {
            const toggle = document.querySelector('.theme-toggle');
            const icon = toggle.querySelector('.theme-toggle-icon');
            const text = toggle.querySelector('.theme-text');
            
            if (currentTheme === 'dark') {
                icon.textContent = '☀️';
                text.textContent = 'Tryb jasny';
            } else {
                icon.textContent = '🌙';
                text.textContent = 'Tryb ciemny';
            }
        }
        
        function updateChartTheme(chart) {
            if (!chart || !chart.options || !chart.options.scales) return;
            
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary');
            const gridColor = getComputedStyle(document.body).getPropertyValue('--border-color');
            
            if (chart.options.scales.x) {
                if (chart.options.scales.x.ticks) chart.options.scales.x.ticks.color = textColor;
                if (chart.options.scales.x.grid) chart.options.scales.x.grid.color = gridColor;
            }
            if (chart.options.scales.y) {
                if (chart.options.scales.y.ticks) chart.options.scales.y.ticks.color = textColor;
                if (chart.options.scales.y.grid) chart.options.scales.y.grid.color = gridColor;
            }
            if (chart.options.plugins && chart.options.plugins.legend && chart.options.plugins.legend.labels) {
                chart.options.plugins.legend.labels.color = textColor;
            }
            
            chart.update();
        }
        
        // Season management
        let currentSeason = 'all';
        
        function setSeason(season, element) {
            currentSeason = season;
            
            // Update buttons
            document.querySelectorAll('.season-btn').forEach(btn => btn.classList.remove('active'));
            if (element) element.classList.add('active');
            
            // Update seasonal info
            const seasonalInfo = document.getElementById('seasonal-info');
            const currentSeasonText = document.getElementById('current-season');
            
            if (seasonalInfo && currentSeasonText) {
                if (season !== 'all') {
                    seasonalInfo.style.display = 'block';
                    currentSeasonText.textContent = season === 'summer' ? 'Lato' : 'Zima';
                } else {
                    seasonalInfo.style.display = 'none';
                }
            }
            
            // Apply seasonal adjustments to profiles
            applySeasonalAdjustments();
            calculateCostsAndUpdate();
        }
        
        function applySeasonalAdjustments() {
            try {
                if (!currentProfile || currentProfile.length === 0) {
                    currentProfile = [...usageProfiles.standard];
                }
                
                // Stwórz kopię profilu do modyfikacji
                let adjustedProfile = [...currentProfile];
                
                // Adjust profiles based on season
                if (currentSeason === 'summer') {
                    // Summer adjustments - less heating, more cooling
                    adjustedProfile = adjustedProfile.map((value, hour) => {
                        if (hour >= 12 && hour <= 16) {
                            return value * 1.2; // More AC usage during hot hours
                        } else if (hour >= 22 || hour <= 5) {
                            return value * 0.8; // Less night usage (no heating)
                        }
                        return value;
                    });
                } else if (currentSeason === 'winter') {
                    // Winter adjustments - more heating, longer lighting
                    adjustedProfile = adjustedProfile.map((value, hour) => {
                        if ((hour >= 6 && hour <= 8) || (hour >= 17 && hour <= 22)) {
                            return value * 1.3; // More heating and lighting
                        } else if (hour >= 10 && hour <= 15) {
                            return value * 0.9; // Less usage during warmer day hours
                        }
                        return value;
                    });
                }
                
                // Normalize to 100%
                const sum = adjustedProfile.reduce((a, b) => a + b, 0);
                if (sum > 0) {
                    currentProfile = adjustedProfile.map(v => (v / sum) * 100);
                }
            } catch (error) {
                console.error('Błąd podczas dostosowywania profilu sezonowego:', error);
            }
        }
        
        // Shield toggle
        let useShield = true;
        
        function toggleShield() {
            useShield = document.getElementById('shield-toggle').checked;
            calculateCostsAndUpdate();
        }
        
        // Definicje taryf z Energa Operator
        const tariffs = {
            G11: {
                name: "G11 - Jednostrefowa",
                rate: 0.3437, // bez tarczy
                rateShield: 0.412, // z tarczą 
                fixedMonthly: { "1-phase": 7.68, "3-phase": 11.54 },
                type: "flat"
            },
            G11f: {
                name: "G11f - Dynamiczna", 
                baseRate: 0.0516, // Stały składnik zmienny stawki sieciowej
                fixedMonthly: { "1-phase": 38.69, "3-phase": 54.37 }, // Stały składnik stawki sieciowej
                type: "dynamic"
            },
            G12: {
                name: "G12 - Dzień/Noc",
                rates: { 
                    day: 0.3791, 
                    night: 0.0816,
                    dayShield: 0.542,
                    nightShield: 0.224
                },
                zones: [
                    // dzień: 6-13, 15-22; noc: 13-15, 22-6
                    'night','night','night','night','night','night', // 0-5
                    'day','day','day','day','day','day','day', // 6-12
                    'night','night', // 13-14
                    'day','day','day','day','day','day','day', // 15-21
                    'night','night' // 22-23
                ],
                fixedMonthly: { "1-phase": 14.07, "3-phase": 19.77 }
            },
            G12w: {
                name: "G12w - Weekendowa",
                rates: { 
                    day: 0.3960, 
                    night: 0.0838,
                    dayShield: 0.542,
                    nightShield: 0.224
                },
                zones: [
                    'night','night','night','night','night','night',
                    'day','day','day','day','day','day','day',
                    'night','night',
                    'day','day','day','day','day','day','day',
                    'night','night'
                ],
                weekendAllNight: true,
                fixedMonthly: { "1-phase": 14.07, "3-phase": 19.77 }
            },
            G12r: {
                name: "G12r - Szczyt/Pozaszczyt", 
                rates: { 
                    peak: 0.3590, 
                    offpeak: 0.0870,
                    peakShield: 0.542,
                    offpeakShield: 0.224
                },
                zones: [
                    // szczyt: 7-13, 16-22; pozaszczyt: 13-16, 22-7
                    'offpeak','offpeak','offpeak','offpeak','offpeak','offpeak','offpeak', // 0-6
                    'peak','peak','peak','peak','peak','peak', // 7-12
                    'offpeak','offpeak','offpeak', // 13-15
                    'peak','peak','peak','peak','peak','peak', // 16-21
                    'offpeak','offpeak' // 22-23
                ],
                fixedMonthly: { "1-phase": 14.07, "3-phase": 19.77 }
            }
        };
        
        // Systemowe opłaty
        const systemCharges = {
            subscription: 4.56,
            quality: 0.0321,
            oze: 0.0035,
            cogeneration: 0.003,
        };
        
        function getTransitionFee(annualUsage) {
            if (annualUsage < 500) return 0.02;
            if (annualUsage <= 1200) return 0.10;
            return 0.33;
        }
        
        function getPowerFee(annualUsage) {
            if (annualUsage < 500) return 2.86;
            if (annualUsage <= 1200) return 6.86;
            if (annualUsage <= 2800) return 11.44;
            return 16.01;
        }
        
        // Profile zużycia (% dla każdej godziny doby)
        const usageProfiles = {
            standard: new Array(24).fill(100/24), // równomierne
            morning: [2,2,2,2,2,8,12,12,8,4,4,4,4,4,4,4,8,12,12,8,6,4,3,2], // poranki + wieczory
            evening: [2,2,2,2,2,3,6,8,4,3,3,3,3,3,3,3,4,6,12,15,15,8,4,2], // wieczorny pik
            night: [8,8,8,6,4,2,2,2,2,2,2,2,2,2,2,2,2,3,4,6,8,12,15,15], // nocny
            flexible: [8,8,8,8,6,4,2,2,2,2,2,2,8,8,4,2,2,2,2,2,4,6,8,8], // dostosowany do G12
            flexibleW: [10,10,10,8,6,4,2,2,2,2,2,2,8,8,2,2,2,2,2,2,2,4,8,10], // dostosowany do G12w (więcej w weekendy)
            homeoffice: [3,2,2,2,2,4,6,8,10,8,6,6,6,8,8,6,6,4,3,2,2,2,2,2], // home office
            ev_charging: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,50,50,0], // ładowanie EV 21-23h
            heat_pump: [6,6,6,6,6,8,4,2,2,2,2,2,2,2,2,2,2,4,6,8,8,8,8,6] // pompa ciepła
        };
        
        let currentProfile = [...usageProfiles.standard];
        let weeklyProfiles = {
            monday: [...usageProfiles.standard],
            tuesday: [...usageProfiles.standard],
            wednesday: [...usageProfiles.standard],
            thursday: [...usageProfiles.standard],
            friday: [...usageProfiles.standard],
            saturday: [...usageProfiles.standard],
            sunday: [...usageProfiles.standard]
        };
        let selectedDay = 'all';
        let useWeeklyProfiles = false;
        let spotPrices = null;
        let spotPricesRange = []; // Dla zakresów dat
        let hourlyChart = null;
        let costChart = null;
        let currentExchangeRate = 4.30;
        
        // Inicjalizuj currentProfile jeśli jest pusty
        if (!currentProfile || currentProfile.length === 0) {
            currentProfile = new Array(24).fill(100/24);
        }
        
        // Zabezpieczenie przed błędami
        window.addEventListener('error', function(e) {
            console.error('Błąd aplikacji:', e.message, e.filename, e.lineno, e.colno);
            return true;
        });
        
        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Aplikacja startuje...');
            
            try {
                // Ustaw wczorajszą datę (ENTSO-E ma opóźnienie ~1 dzień)
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                const weekAgo = new Date(Date.now() - 7 * 86400000).toISOString().split('T')[0];
                
                // Ustaw maksymalną datę na wczoraj dla wszystkich pól dat
                const dateSelect = document.getElementById('date-select');
                if (dateSelect) {
                    dateSelect.value = yesterday;
                    dateSelect.max = yesterday;
                }
                
                const dateFrom = document.getElementById('date-from');
                if (dateFrom) {
                    dateFrom.value = weekAgo;
                    dateFrom.max = yesterday;
                }
                
                const dateTo = document.getElementById('date-to');
                if (dateTo) {
                    dateTo.value = yesterday;
                    dateTo.max = yesterday;
                }
                
                // Ustaw domyślny kurs
                currentExchangeRate = 4.30;
                const eurInput = document.getElementById('eur-pln-rate');
                if (eurInput) {
                    eurInput.value = currentExchangeRate.toFixed(4);
                }
                
                // Event listenery
                setupEventListeners();
                
                // Wstępne obliczenia bez cen spot (używa standardowych taryf)
                setTimeout(() => {
                    calculateCostsAndUpdate();
                    console.log('✅ Aplikacja uruchomiona pomyślnie');
                }, 100);
                
            } catch (error) {
                console.error('❌ Błąd podczas inicjalizacji:', error);
            }
        });
        
        function fetchExchangeRate() {
            const eurInput = document.getElementById('eur-pln-rate');
            if (eurInput) {
                const newRate = parseFloat(eurInput.value);
                if (!isNaN(newRate) && newRate > 0) {
                    currentExchangeRate = newRate;
                    console.log(`📊 Zaktualizowano kurs EUR/PLN: ${currentExchangeRate.toFixed(4)}`);
                    
                    // Aktualizuj wyświetlanie jeśli są już ceny
                    if (spotPrices && spotPrices.length > 0) {
                        updateSpotPricesDisplay();
                        calculateCostsAndUpdate();
                    }
                    
                    // Wyświetl info o kursie
                    const currencyInfo = document.getElementById('currency-info');
                    if (currencyInfo) {
                        currencyInfo.innerHTML = `
                            💱 <span style="font-weight: bold;">Kurs EUR/PLN: ${currentExchangeRate.toFixed(4)}</span>
                            <span style="margin-left: 20px;">📡 Źródło: Wprowadzono ręcznie</span>
                            <span style="margin-left: 20px;">✅ Zaktualizowano</span>
                        `;
                    }
                } else {
                    alert('Wprowadź poprawną wartość kursu EUR/PLN');
                }
            }
        }
        
        async function updateExchangeRate() {
            try {
                // Spróbuj kilka źródeł kursu EUR/PLN
                let rate = null;
                let source = '';
                
                console.log('🔄 Pobieranie kursu EUR/PLN...');
                
                // 1. Spróbuj NBP API przez CORS proxy
                try {
                    const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://api.nbp.pl/api/exchangerates/rates/a/eur/?format=json'));
                    if (response.ok) {
                        const data = await response.json();
                        if (data.contents) {
                            const nbpData = JSON.parse(data.contents);
                            if (nbpData && nbpData.rates && nbpData.rates.length > 0) {
                                rate = nbpData.rates[0].mid;
                                source = `NBP (${nbpData.rates[0].effectiveDate})`;
